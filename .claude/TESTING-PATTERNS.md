# –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.
> **–ö–æ–≥–¥–∞ —á–∏—Ç–∞—Ç—å:** –ü–æ —Å—Å—ã–ª–∫–µ –∏–∑ TESTING.md –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω.
> **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-12-01

---

## –ù–∞–≤–∏–≥–∞—Ü–∏—è

| –ü–∞—Ç—Ç–µ—Ä–Ω | –°–µ–∫—Ü–∏—è |
|---------|--------|
| –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ | [#–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è-—Ç–µ—Å—Ç–æ–≤](#–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è-—Ç–µ—Å—Ç–æ–≤) |
| Edge cases | [#edge-cases](#edge-cases-–ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π-–ø–æ–¥—Ö–æ–¥) |
| REFACTOR —á–µ–∫-–ª–∏—Å—Ç | [#refactor](#refactor-—á–µ–∫-–ª–∏—Å—Ç) |
| Async: confirmation | [#async-confirmation](#–ø–∞—Ç—Ç–µ—Ä–Ω-1-confirmation) |
| Async: serial executor | [#async-serial](#–ø–∞—Ç—Ç–µ—Ä–Ω-2-withmainserialexecutor) |
| Async: actor isolation | [#async-actor](#–ø–∞—Ç—Ç–µ—Ä–Ω-3-actor-isolation) |

---

## –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–µ—Å—Ç–æ–≤

**–ß—Ç–æ —ç—Ç–æ:** –†–∞–∑–±–∏–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ Component —Ç–µ—Å—Ç–∞ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —á–∞—Å—Ç–∏.

**–ß—Ç–æ —ç—Ç–æ –ù–ï:** –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤/actors (—ç—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ‚Üí ADR).

### –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å

```
Component Test > 30-40 —Å—Ç—Ä–æ–∫? ‚Üí –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è
```

### –ü—Ä–æ—Ü–µ—Å—Å

```
E2E —Å—Ü–µ–Ω–∞—Ä–∏–π: "–ü–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"
    ‚îÇ
    ‚ñº
Component Test ‚Äî —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —à–∞–≥–∏:
    ‚îÇ
    ‚îú‚îÄ> Test: loadChats (happy)
    ‚îú‚îÄ> Test: loadChats (error) ‚Äî –µ—Å–ª–∏ mock –ø—Ä–æ—Å—Ç–æ–π
    ‚îÇ
    ‚îú‚îÄ> Test: filterChannels (happy)
    ‚îú‚îÄ> Test: filterChannels (edge: empty)
    ‚îÇ
    ‚îú‚îÄ> Test: fetchMessages (happy)
    ‚îÇ
    ‚îî‚îÄ> Integration Test: –≤—Å—è —Ü–µ–ø–æ—á–∫–∞
```

### –ü–æ—Ä—è–¥–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

```
1. Happy path ‚Üí RED ‚Üí GREEN ‚Üí REFACTOR
2. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ edge cases (—Å–º. –º–∞—Ç—Ä–∏—Ü—É –Ω–∏–∂–µ)
3. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
```

### –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–µ—Å—Ç–æ–≤

```swift
@Suite("ChannelMessageSource")
struct ChannelMessageSourceTests {

    // === –®–∞–≥ 1: loadChats ===
    @Test func loadChats_returnsChats() { }
    @Test func loadChats_throwsOnError() { }

    // === –®–∞–≥ 2: filterChannels ===
    @Test func filterChannels_returnsOnlyChannels() { }
    @Test func filterChannels_emptyWhenNoChannels() { }

    // === –®–∞–≥ 3: fetchMessages ===
    @Test func fetchMessages_returnsMessages() { }

    // === Integration ===
    @Test func fetchUnreadMessages_fullFlow() { }
}
```

---

## Edge cases: –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥

### –ú–∞—Ç—Ä–∏—Ü–∞ "–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å √ó –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å"

```
                    ‚îÇ –í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å ‚îÇ –ù–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è        ‚îÇ ‚úÖ –¢–µ—Å—Ç –°–ï–ô–ß–ê–°      ‚îÇ üìù TODO –≤ –∫–æ–¥–µ
–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è        ‚îÇ                     ‚îÇ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ         ‚îÇ ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç     ‚îÇ ‚ùå –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                    ‚îÇ    –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ      ‚îÇ
```

### –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è TDLib –ø—Ä–æ–µ–∫—Ç–∞

| –°–∏—Ç—É–∞—Ü–∏—è | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –†–µ—à–µ–Ω–∏–µ |
|----------|-------------|-------------|---------|
| TDLib –≤–µ—Ä–Ω—É–ª error | –í—ã—Å–æ–∫–∞—è | –ö—Ä–∏—Ç–∏—á–Ω–æ | ‚úÖ –¢–µ—Å—Ç |
| –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ | –í—ã—Å–æ–∫–∞—è | –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ | ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç |
| –°–µ—Ç—å —É–ø–∞–ª–∞ | –°—Ä–µ–¥–Ω—è—è | –ö—Ä–∏—Ç–∏—á–Ω–æ | ‚úÖ –¢–µ—Å—Ç |
| –ö–∞–Ω–∞–ª —É–¥–∞–ª—ë–Ω | –ù–∏–∑–∫–∞—è | –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ | üìù TODO |
| Rate limit | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | üìù TODO |

### –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç (3 –≤–æ–ø—Ä–æ—Å–∞)

```
–ü–æ—Å–ª–µ happy path:

‚ñ° API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É? ‚Üí –¢–µ—Å—Ç –µ—Å–ª–∏ mock —É–∂–µ –µ—Å—Ç—å
‚ñ° –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç? ‚Üí –û–±—ã—á–Ω–æ 2-3 —Å—Ç—Ä–æ–∫–∏
‚ñ° –ß—Ç–æ-—Ç–æ –µ—â—ë –∫—Ä–∏—Ç–∏—á–Ω–æ–µ? ‚Üí TODO
```

### –§–æ—Ä–º–∞—Ç TODO –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö cases

```swift
// TODO: [EDGE] Rate limit handling
// –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å: —Å—Ä–µ–¥–Ω—è—è
```

### –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

> –ï—Å–ª–∏ –¥–ª—è edge case –Ω—É–∂–µ–Ω –Ω–æ–≤—ã–π mock ‚Äî —ç—Ç–æ TODO, –Ω–µ —Ç–µ—Å—Ç. MVP –≤–∞–∂–Ω–µ–µ –ø–æ–∫—Ä—ã—Ç–∏—è.

---

## REFACTOR —á–µ–∫-–ª–∏—Å—Ç

### –ß—Ç–æ —Ç–∞–∫–æ–µ REFACTOR

```
RED    ‚Üí —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç
GREEN  ‚Üí –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥ —á—Ç–æ–±—ã –ø—Ä–æ—à—ë–ª
REFACTOR ‚Üí —É–ª—É—á—à–∞–µ–º –∫–æ–¥, —Ç–µ—Å—Ç—ã –≤—Å—ë –µ—â—ë GREEN
```

### –ß–µ–∫-–ª–∏—Å—Ç: –Ω—É–∂–µ–Ω –ª–∏?

```
‚ñ° –ï—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ? ‚Üí –≤—ã–Ω–µ—Å—Ç–∏ –≤ –º–µ—Ç–æ–¥
‚ñ° –ù–∞–∑–≤–∞–Ω–∏—è –ø–æ–Ω—è—Ç–Ω—ã? ‚Üí –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
‚ñ° –§—É–Ω–∫—Ü–∏—è > 20-25 —Å—Ç—Ä–æ–∫? ‚Üí —Ä–∞–∑–±–∏—Ç—å
‚ñ° –í–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å > 2 —É—Ä–æ–≤–Ω–µ–π? ‚Üí —É–ø—Ä–æ—Å—Ç–∏—Ç—å

–í—Å—ë ‚úì ‚Üí –Ω–µ –Ω—É–∂–µ–Ω, —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç
```

### –ß—Ç–æ –ù–ï –≤—Ö–æ–¥–∏—Ç –≤ REFACTOR

```
‚ùå Edge cases ‚Äî —ç—Ç–æ –ù–û–í–´–ï —Ç–µ—Å—Ç—ã
‚ùå –ù–æ–≤—ã–µ —Ñ–∏—á–∏ ‚Äî —ç—Ç–æ –ù–û–í–´–ï —Ç–µ—Å—Ç—ã
‚ùå –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî ADR
```

### –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

| –°–∏—Ç—É–∞—Ü–∏—è | –ö—É–¥–∞ |
|----------|------|
| –ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ | `// TODO: –æ–ø–∏—Å–∞–Ω–∏–µ` |
| –ò–¥–µ—è –Ω–∞ –±—É–¥—É—â–µ–µ | BACKLOG.md |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –¥–æ–ª–≥ | ADR |

---

## Async —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–∞—Ç—Ç–µ—Ä–Ω 1: confirmation()

**–ö–æ–≥–¥–∞:** AsyncSequence/AsyncStream, –ø–æ–¥—Å—á—ë—Ç —Å–æ–±—ã—Ç–∏–π.

```swift
@Test func receivesUpdates() async throws {
    await confirmation(expectedCount: 3) { confirm in
        await handler.start { update in
            confirm()
        }
    }
}
```

https://developer.apple.com/documentation/testing/confirmation

### –ü–∞—Ç—Ç–µ—Ä–Ω 2: withMainSerialExecutor

**–ö–æ–≥–¥–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—è–¥–∫–∞, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã.

```swift
import ConcurrencyExtras

@Test func processesSequentially() async throws {
    await withMainSerialExecutor {
        var order: [Int] = []
        await handler.start { order.append($0.id) }
        #expect(order == [1, 2, 3])
    }
}
```

https://www.pointfree.co/blog/posts/110-reliably-testing-async-code-in-swift

### –ü–∞—Ç—Ç–µ—Ä–Ω 3: Actor isolation

**–ö–æ–≥–¥–∞:** Thread-safety, concurrent –≤—ã–∑–æ–≤—ã.

```swift
@Test func threadSafe() async throws {
    await withTaskGroup(of: Void.self) { group in
        for _ in 1...10 {
            group.addTask { await handler.process() }
        }
    }
}
```

---

## –†–µ—Å—É—Ä—Å—ã

- [Swift Testing](https://developer.apple.com/documentation/testing)
- [swift-concurrency-extras](https://github.com/pointfreeco/swift-concurrency-extras)
