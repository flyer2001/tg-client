# v0.4.0: Pipeline Integration RFC

> **–°—Ç–∞—Ç—É—Å:** Draft
> **–î–∞—Ç–∞:** 2025-12-06
> **–ê–≤—Ç–æ—Ä:** Senior Swift Architect

---

## üéØ –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π pipeline: MessageSource ‚Üí DigestOrchestrator ‚Üí BotNotifier + StateManager.

**Scope:**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ChannelMessageSource —Å DigestOrchestrator
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è BotNotifierProtocol (Telegram Bot API)
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è StateManagerProtocol (timestamp JSON)
- Retry logic –¥–ª—è transient errors
- E2E —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ pipeline

---

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

| –ê—Å–ø–µ–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|--------|---------|-------------|
| **Error handling** | Partial success | –ï—Å–ª–∏ 1 –∫–∞–Ω–∞–ª —É–ø–∞–ª ‚Üí –ª–æ–≥–∏—Ä—É–µ–º, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —á–∞—Å—Ç–∏—á–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç. |
| **Checkpoint timing** | –ü–æ—Å–ª–µ BotNotifier + markAsRead | –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å: –ª–∏–±–æ –≤—Å—ë —É—Å–ø–µ—à–Ω–æ, –ª–∏–±–æ retry –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ. |
| **Rollback strategy** | –ù–ï –ø–æ–º–µ—á–∞—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º –µ—Å–ª–∏ BotNotifier —É–ø–∞–ª | –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç. –í–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ($$). |
| **Retry logic** | –í –∫–∞–∂–¥–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ, transient errors —Ç–æ–ª—å–∫–æ | Granular retry —ç–∫–æ–Ω–æ–º–∏—Ç –¥–µ–Ω—å–≥–∏ (–Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é –µ—Å–ª–∏ —É–ø–∞–ª BotNotifier). |

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Pipeline Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          DigestOrchestrator.runPipeline()       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº            ‚ñº            ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ Message  ‚îÇ ‚îÇ Summary  ‚îÇ ‚îÇ   Bot    ‚îÇ
  ‚îÇ  Source  ‚îÇ ‚îÇGenerator ‚îÇ ‚îÇ Notifier ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ            ‚îÇ            ‚îÇ
        ‚ñº            ‚ñº            ‚ñº
    (TDLib)      (OpenAI)    (Bot API)

                     ‚îÇ
                     ‚ñº (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞)
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  State   ‚îÇ
              ‚îÇ Manager  ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. DigestOrchestrator (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ v0.3.0)

**–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```swift
public func runPipeline(
    messageSource: MessageSourceProtocol,
    botNotifier: BotNotifierProtocol,
    stateManager: StateManagerProtocol
) async throws -> PipelineResult
```

**–õ–æ–≥–∏–∫–∞:**
1. `lastTimestamp = try await stateManager.loadState()`
2. `channels = try await messageSource.fetchUnreadChannels(since: lastTimestamp)`
3. **Per-channel processing (partial success):**
   ```swift
   var successfulChannels: [(channel, digest)] = []
   var failedChannels: [(channel, error)] = []

   for channel in channels {
       do {
           let messages = channel.messages
           let digest = try await summaryGenerator.generate(messages: messages)
           successfulChannels.append((channel, digest))
       } catch {
           logger.error("–ö–∞–Ω–∞–ª \(channel.id) —É–ø–∞–ª", metadata: ["error": error])
           failedChannels.append((channel, error))
           continue // partial success
       }
   }
   ```
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–π–¥–∂–µ—Å—Ç–∞:**
   ```swift
   guard !successfulChannels.isEmpty else {
       throw PipelineError.noSuccessfulChannels
   }

   let fullDigest = formatDigest(successfulChannels)
   try await botNotifier.send(digest: fullDigest) // –º–æ–∂–µ—Ç retry –≤–Ω—É—Ç—Ä–∏
   ```
5. **–ê—Ç–æ–º–∞—Ä–Ω–∞—è commit (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —à–∞–≥ 4 —É—Å–ø–µ—à–µ–Ω):**
   ```swift
   // markAsRead —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
   try await messageSource.markAsRead(channels: successfulChannels.map { $0.channel })
   try await stateManager.saveState(timestamp: Date())
   ```

**Errors:**
- `PipelineError.noSuccessfulChannels` ‚Äî –≤—Å–µ –∫–∞–Ω–∞–ª—ã —É–ø–∞–ª–∏
- `PipelineError.botNotifierFailed` ‚Äî –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å (–ù–ï –ø–æ–º–µ—á–∞–µ–º –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏)

**Retry:** –ù–ï–¢ –Ω–∞ —É—Ä–æ–≤–Ω–µ DigestOrchestrator (retry –≤–Ω—É—Ç—Ä–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤).

---

#### 2. BotNotifierProtocol (–Ω–æ–≤—ã–π)

**–ü—Ä–æ—Ç–æ–∫–æ–ª:**
```swift
public protocol BotNotifierProtocol: Sendable {
    /// –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç —á–µ—Ä–µ–∑ Telegram Bot.
    ///
    /// **Retry:** 3x exponential backoff (1s, 2s, 4s) –¥–ª—è transient errors.
    ///
    /// - Parameter digest: –î–∞–π–¥–∂–µ—Å—Ç –≤ Telegram MarkdownV2 —Ñ–æ—Ä–º–∞—Ç–µ
    /// - Throws: BotNotifierError
    func send(digest: String) async throws
}
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `TelegramBotNotifier`

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- HTTP: URLSession (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º HTTPClientProtocol –∏–∑ OpenAISummaryGenerator?)
- API: `https://api.telegram.org/bot<token>/sendMessage`
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
  ```json
  {
    "chat_id": "<TELEGRAM_BOT_CHAT_ID>",
    "text": "<digest>",
    "parse_mode": "MarkdownV2"
  }
  ```
- **–†–∞–∑–±–∏–≤–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ (>4096 chars):**
  ```swift
  if digest.count > 4096 {
      let chunks = digest.split(by: 4096, preserveMarkdown: true)
      for chunk in chunks {
          try await send(chunk)
      }
  }
  ```
- **Retry logic (transient errors):**
  - 429 (rate limit) ‚Üí retry 3x —Å exponential backoff
  - 5xx (server error) ‚Üí retry 3x
  - Timeout ‚Üí retry 3x
  - 401/403 ‚Üí fail fast (unrecoverable)

**Errors:**
```swift
public enum BotNotifierError: Error {
    case unauthorized // 401
    case forbidden    // 403
    case rateLimited  // 429 –ø–æ—Å–ª–µ 3 retries
    case serverError  // 5xx –ø–æ—Å–ª–µ 3 retries
    case timeout      // –ø–æ—Å–ª–µ 3 retries
    case invalidMarkdown
}
```

**Env:**
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_BOT_CHAT_ID`

---

#### 3. StateManagerProtocol (–Ω–æ–≤—ã–π)

**–ü—Ä–æ—Ç–æ–∫–æ–ª:**
```swift
public protocol StateManagerProtocol: Sendable {
    /// –ó–∞–≥—Ä—É–∂–∞–µ—Ç timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
    ///
    /// - Returns: Timestamp –∏–ª–∏ nil (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)
    func loadState() async throws -> Date?

    /// –°–æ—Ö—Ä–∞–Ω—è–µ—Ç timestamp —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
    ///
    /// **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:** write to temp + rename (–¥–ª—è crash safety).
    ///
    /// - Parameter timestamp: Timestamp –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    func saveState(timestamp: Date) async throws
}
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `FileBasedStateManager`

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- **–ü—É—Ç—å:** `~/.tdlib/digest_state.json`
- **–§–æ—Ä–º–∞—Ç:**
  ```json
  {
    "version": 1,
    "last_processed_at": "2025-12-05T18:30:00Z"
  }
  ```
- **–ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å (crash safety):**
  ```swift
  let tempPath = statePath + ".tmp"
  try data.write(to: tempPath)
  try FileManager.default.moveItem(at: tempPath, to: statePath) // atomic rename
  ```
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:**
  - JSON parsing –æ—à–∏–±–∫–∞ ‚Üí –ª–æ–≥–∏—Ä—É–µ–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º nil (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)
  - Timestamp –≤ –±—É–¥—É—â–µ–º ‚Üí –ª–æ–≥–∏—Ä—É–µ–º warning, –∏—Å–ø–æ–ª—å–∑—É–µ–º (clock skew)
  - Timestamp —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π ‚Üí –ª–æ–≥–∏—Ä—É–µ–º info, –∏—Å–ø–æ–ª—å–∑—É–µ–º

**Errors:**
```swift
public enum StateManagerError: Error {
    case fileSystemError(underlying: Error)
    case corruptedState(reason: String)
}
```

**Env:**
- `DIGEST_STATE_DIR` (default: `~/.tdlib`)

---

#### 4. MessageSource Integration

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:** –ù–ï–¢ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ v0.2.0).

**API:**
```swift
public protocol MessageSourceProtocol: Sendable {
    func fetchUnreadMessages(since: Date?) async throws -> [SourceMessage]
    func markAsRead(messages: [SourceMessage]) async throws
}
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º:** `ChannelMessageSource` (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞).

---

## üß™ TDD Breakdown (Outside-In)

### E2E Test (–ø–µ—Ä–≤—ã–π, RED)

**–§–∞–π–ª:** `Tests/TgClientE2ETests/FullPipelineE2ETests.swift`

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```swift
@Test(.disabled("–¢—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π TDLib + OpenAI + Bot API"))
func fullPipelineE2ETest() async throws {
    // Given: —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    let tdlib = try await TDLibClient(...)
    let messageSource = ChannelMessageSource(tdlibClient: tdlib, logger: logger)
    let summaryGenerator = OpenAISummaryGenerator(httpClient: URLSessionHTTPClient(), logger: logger)
    let botNotifier = TelegramBotNotifier(httpClient: URLSessionHTTPClient(), logger: logger)
    let stateManager = FileBasedStateManager(stateDir: tmpDir)
    let orchestrator = DigestOrchestrator(summaryGenerator: summaryGenerator, logger: logger)

    // When: –∑–∞–ø—É—Å–∫ pipeline
    let result = try await orchestrator.runPipeline(
        messageSource: messageSource,
        botNotifier: botNotifier,
        stateManager: stateManager
    )

    // Then: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    #expect(result.successfulChannels.count > 0)

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º state —Å–æ—Ö—Ä–∞–Ω—ë–Ω
    let state = try await stateManager.loadState()
    #expect(state != nil)
}
```

**–°—Ç–∞—Ç—É—Å:** `.disabled()` (—Ç—Ä–µ–±—É–µ—Ç env + —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞).

---

### Component Tests (per –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)

#### 1. DigestOrchestrator (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

**–§–∞–π–ª:** `Tests/TgClientComponentTests/DigestCore/DigestOrchestratorPipelineTests.swift`

**–¢–µ—Å—Ç—ã (5-7):**
1. ‚úÖ Happy path: –≤—Å–µ –∫–∞–Ω–∞–ª—ã —É—Å–ø–µ—à–Ω—ã ‚Üí BotNotifier.send ‚Üí markAsRead ‚Üí saveState
2. ‚úÖ Partial success: 1 –∫–∞–Ω–∞–ª —É–ø–∞–ª ‚Üí –ª–æ–≥–∏—Ä—É–µ–º, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–π–¥–∂–µ—Å—Ç –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö
3. ‚úÖ All channels failed ‚Üí throw PipelineError.noSuccessfulChannels
4. ‚úÖ BotNotifier.send —É–ø–∞–ª ‚Üí –ù–ï –≤—ã–∑—ã–≤–∞–µ–º markAsRead/saveState
5. ‚úÖ markAsRead —É–ø–∞–ª ‚Üí –ù–ï –≤—ã–∑—ã–≤–∞–µ–º saveState
6. ‚úÖ Empty state (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫) ‚Üí fetchUnreadMessages(since: nil)
7. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –Ω–∞—á–∞–ª–æ, –∫–æ–Ω–µ—Ü, –æ—à–∏–±–∫–∏

**–ú–æ–∫–∏:**
- `MockMessageSource` (protocol conformance)
- `MockBotNotifier` (protocol conformance)
- `MockStateManager` (protocol conformance)
- `MockSummaryGenerator` ‚Äî **–ù–ï –ù–£–ñ–ï–ù** (–∏—Å–ø–æ–ª—å–∑—É–µ–º OpenAISummaryGenerator + MockHTTPClient!)

---

#### 2. TelegramBotNotifier

**–§–∞–π–ª:** `Tests/TgClientComponentTests/DigestCore/TelegramBotNotifierTests.swift`

**–¢–µ—Å—Ç—ã (6-8):**
1. ‚úÖ Happy path: –¥–∞–π–¥–∂–µ—Å—Ç < 4096 chars ‚Üí sendMessage —É—Å–ø–µ—à–µ–Ω
2. ‚úÖ –î–ª–∏–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç > 4096 chars ‚Üí —Ä–∞–∑–±–∏–≤–∫–∞ –Ω–∞ chunks ‚Üí –Ω–µ—Å–∫–æ–ª—å–∫–æ sendMessage
3. ‚úÖ Retry logic: 429 ‚Üí retry 3x —Å exponential backoff (1s, 2s, 4s) ‚Üí success
4. ‚úÖ Retry exhausted: 429 ‚Üí 3 retries ‚Üí throw BotNotifierError.rateLimited
5. ‚úÖ Transient error: 500 ‚Üí retry ‚Üí 200 success
6. ‚úÖ Unrecoverable error: 401 ‚Üí fail fast (no retry)
7. ‚úÖ Timeout ‚Üí retry 3x
8. ‚úÖ Invalid Markdown ‚Üí throw BotNotifierError.invalidMarkdown (–µ—Å–ª–∏ API –≤–µ—Ä–Ω—ë—Ç 400)

**–ú–æ–∫–∏:**
- `MockHTTPClient` (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ v0.3.0)

---

#### 3. FileBasedStateManager

**–§–∞–π–ª:** `Tests/TgClientComponentTests/DigestCore/FileBasedStateManagerTests.swift`

**–¢–µ—Å—Ç—ã (5-6):**
1. ‚úÖ Happy path: saveState ‚Üí loadState ‚Üí timestamp —Å–æ–≤–ø–∞–¥–∞–µ—Ç
2. ‚úÖ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫: —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí loadState –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç nil
3. ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å: saveState ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º temp file —É–¥–∞–ª—ë–Ω
4. ‚úÖ Corrupted state: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON ‚Üí loadState –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç nil + –ª–æ–≥–∏—Ä—É–µ–º error
5. ‚úÖ Timestamp –≤ –±—É–¥—É—â–µ–º ‚Üí loadState –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç timestamp + –ª–æ–≥–∏—Ä—É–µ–º warning
6. ‚úÖ Concurrent writes (race condition) ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∏—Å–∫

**–ú–æ–∫–∏:** –ù–ï–¢ (real FileManager, temp dir).

---

### Unit Tests

#### 1. PipelineResult model (–µ—Å–ª–∏ —Å–æ–∑–¥–∞–¥–∏–º)

```swift
public struct PipelineResult {
    public let successfulChannels: [ChannelDigest]
    public let failedChannels: [ChannelError]
    public let timestamp: Date
}
```

**–¢–µ—Å—Ç—ã:** Codable roundtrip (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è).

#### 2. BotNotifier retry logic helper (–µ—Å–ª–∏ –≤—ã–Ω–µ—Å–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é)

**–§–∞–π–ª:** `Tests/TgClientUnitTests/DigestCore/RetryLogicTests.swift`

**–¢–µ—Å—Ç—ã (3-4):**
1. ‚úÖ Success –Ω–∞ –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ ‚Üí no retry
2. ‚úÖ Transient error ‚Üí retry —Å exponential backoff
3. ‚úÖ Max retries exhausted ‚Üí throw
4. ‚úÖ Unrecoverable error ‚Üí fail fast (no retry)

---

## üìÅ –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

### Sources/

```
Sources/
‚îú‚îÄ‚îÄ DigestCore/
‚îÇ   ‚îú‚îÄ‚îÄ Orchestrators/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DigestOrchestrator.swift (–∏–∑–º–µ–Ω–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å runPipeline)
‚îÇ   ‚îú‚îÄ‚îÄ Notifiers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BotNotifierProtocol.swift (–Ω–æ–≤—ã–π)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TelegramBotNotifier.swift (–Ω–æ–≤—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ State/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StateManagerProtocol.swift (–Ω–æ–≤—ã–π)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FileBasedStateManager.swift (–Ω–æ–≤—ã–π)
‚îÇ   ‚îî‚îÄ‚îÄ Models/
‚îÇ       ‚îî‚îÄ‚îÄ PipelineResult.swift (–Ω–æ–≤—ã–π, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### Tests/

```
Tests/
‚îú‚îÄ‚îÄ TgClientComponentTests/
‚îÇ   ‚îî‚îÄ‚îÄ DigestCore/
‚îÇ       ‚îú‚îÄ‚îÄ DigestOrchestratorPipelineTests.swift (–Ω–æ–≤—ã–π)
‚îÇ       ‚îú‚îÄ‚îÄ TelegramBotNotifierTests.swift (–Ω–æ–≤—ã–π)
‚îÇ       ‚îî‚îÄ‚îÄ FileBasedStateManagerTests.swift (–Ω–æ–≤—ã–π)
‚îú‚îÄ‚îÄ TgClientUnitTests/
‚îÇ   ‚îî‚îÄ‚îÄ DigestCore/
‚îÇ       ‚îî‚îÄ‚îÄ RetryLogicTests.swift (–Ω–æ–≤—ã–π, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
‚îî‚îÄ‚îÄ TgClientE2ETests/
    ‚îî‚îÄ‚îÄ FullPipelineE2ETests.swift (–Ω–æ–≤—ã–π)
```

### Tests/TestHelpers/

```
Tests/TestHelpers/
‚îú‚îÄ‚îÄ MockMessageSource.swift (–Ω–æ–≤—ã–π)
‚îú‚îÄ‚îÄ MockBotNotifier.swift (–Ω–æ–≤—ã–π)
‚îî‚îÄ‚îÄ MockStateManager.swift (–Ω–æ–≤—ã–π)
```

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ v0.4.0

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
- [ ] DigestOrchestrator.runPipeline —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] BotNotifier –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç —á–µ—Ä–µ–∑ Telegram Bot API
- [ ] StateManager —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç/–∑–∞–≥—Ä—É–∂–∞–µ—Ç timestamp
- [ ] Partial success: —É–ø–∞–≤—à–∏–π –∫–∞–Ω–∞–ª –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ
- [ ] Rollback: BotNotifier —É–ø–∞–ª ‚Üí –ù–ï –ø–æ–º–µ—á–∞–µ–º –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
- [ ] Retry logic: 3x exponential backoff –¥–ª—è transient errors

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ
- [ ] Component —Ç–µ—Å—Ç—ã: DigestOrchestrator (7), BotNotifier (8), StateManager (6) = 21 —Ç–µ—Å—Ç
- [ ] E2E —Ç–µ—Å—Ç: FullPipelineE2ETests (1, .disabled)
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã GREEN (146 + 21 = 167)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü/–æ—à–∏–±–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- [ ] Env: TELEGRAM_BOT_TOKEN, TELEGRAM_BOT_CHAT_ID, DIGEST_STATE_DIR

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] CHANGELOG.md: –¥–æ–±–∞–≤–∏—Ç—å v0.4.0
- [ ] TASKS.md: –æ–±–Ω–æ–≤–∏—Ç—å "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏"
- [ ] ARCHITECTURE.md: –æ–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

---

## üöÄ Implementation Plan (TDD Cycles)

### Cycle 1: BotNotifier (3-4 —á–∞—Å–∞)

1. **DocC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî BotNotifierProtocol + –ø—Ä–∏–º–µ—Ä—ã
2. **Component Test (RED)** ‚Äî TelegramBotNotifierTests (8 —Ç–µ—Å—Ç–æ–≤)
3. **Protocol** ‚Äî BotNotifierProtocol
4. **Unit Tests** ‚Äî RetryLogicTests (–µ—Å–ª–∏ –≤—ã–Ω–µ—Å–µ–º helper)
5. **Implementation ‚Üí GREEN** ‚Äî TelegramBotNotifier + retry logic
6. **REFACTOR** ‚Äî –≤—ã–Ω–µ—Å—Ç–∏ retry helper (–µ—Å–ª–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è —Å OpenAISummaryGenerator)

### Cycle 2: StateManager (2-3 —á–∞—Å–∞)

1. **DocC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî StateManagerProtocol + –ø—Ä–∏–º–µ—Ä—ã
2. **Component Test (RED)** ‚Äî FileBasedStateManagerTests (6 —Ç–µ—Å—Ç–æ–≤)
3. **Protocol** ‚Äî StateManagerProtocol
4. **Unit Tests** ‚Äî StateModel roundtrip (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
5. **Implementation ‚Üí GREEN** ‚Äî FileBasedStateManager + atomic write
6. **REFACTOR** ‚Äî error handling, –≤–∞–ª–∏–¥–∞—Ü–∏—è

### Cycle 3: DigestOrchestrator Integration (3-4 —á–∞—Å–∞)

1. **E2E Test (RED)** ‚Äî FullPipelineE2ETests (1 —Ç–µ—Å—Ç, .disabled)
2. **Component Test (RED)** ‚Äî DigestOrchestratorPipelineTests (7 —Ç–µ—Å—Ç–æ–≤)
3. **Mocks** ‚Äî MockMessageSource, MockBotNotifier, MockStateManager
4. **Implementation ‚Üí GREEN** ‚Äî DigestOrchestrator.runPipeline
5. **REFACTOR** ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, error handling

### Cycle 4: E2E Validation (1-2 —á–∞—Å–∞)

1. **Manual E2E** ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º TDLib + OpenAI + Bot API
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** ‚Äî –≤—Å–µ external calls –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω—ã
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å StateManager** ‚Äî —Ñ–∞–π–ª —Å–æ–∑–¥–∞—ë—Ç—Å—è, timestamp –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å CHANGELOG.md, TASKS.md

---

## ü§î –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### 1. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ HTTPClientProtocol –¥–ª—è BotNotifier?

**–û–ø—Ü–∏–∏:**
- ‚úÖ –î–∞ ‚Äî –º–µ–Ω—å—à–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- ‚ùå –ù–µ—Ç ‚Äî —Ä–∞–∑–Ω—ã–µ API (OpenAI vs Telegram Bot), —Ä–∞–∑–Ω–∞—è retry –ª–æ–≥–∏–∫–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–∞, –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. Retry logic –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ wrapper.

### 2. –ù—É–∂–µ–Ω –ª–∏ PipelineResult model?

**–û–ø—Ü–∏–∏:**
- ‚úÖ –î–∞ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ª–µ–≥—á–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚ùå –ù–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º void

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–∞, —Å–æ–∑–¥–∞—Ç—å –¥–ª—è clarity + future metrics.

### 3. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å concurrent –∑–∞–ø—É—Å–∫–∏ pipeline?

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–∞ cron job –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí race condition –Ω–∞ StateManager.

**–†–µ—à–µ–Ω–∏–µ (MVP):** File lock –∏–ª–∏ PID file. –û—Ç–ª–æ–∂–∏—Ç—å –¥–æ v0.5.0 (–ø–æ—Å–ª–µ MVP).

### 4. –ö–∞–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å digest –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤?

**–§–æ—Ä–º–∞—Ç (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ):**
```markdown
üìä **–î–∞–π–¥–∂–µ—Å—Ç –∑–∞ 05.12.2025**

–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: 3
–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 42

---

**üì¢ –ö–∞–Ω–∞–ª: Swift News**
- –ù–æ–≤–æ—Å—Ç—å 1
- –ù–æ–≤–æ—Å—Ç—å 2
[–ü–æ–¥—Ä–æ–±–Ω–µ–µ](t.me/c/123/456)

**üì¢ –ö–∞–Ω–∞–ª: Tech Updates**
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 1
[–ü–æ–¥—Ä–æ–±–Ω–µ–µ](t.me/c/789/101)

---

‚ö†Ô∏è **–û—à–∏–±–∫–∏:**
–ö–∞–Ω–∞–ª "Python News": Failed to generate summary (rate limit)
```

**–í–æ–ø—Ä–æ—Å:** –£—Ç–≤–µ—Ä–¥–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏?

---

## üìö –°—Å—ã–ª–∫–∏

- [MVP.md](MVP.md) ‚Äî —Ü–µ–ª–∏ –∏ scope MVP
- [ARCHITECTURE.md](ARCHITECTURE.md) ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
- [TESTING.md](TESTING.md) ‚Äî TDD workflow
- [TESTING-PATTERNS.md](TESTING-PATTERNS.md) ‚Äî async patterns, edge cases
- [Telegram Bot API Docs](https://core.telegram.org/bots/api#sendmessage)
