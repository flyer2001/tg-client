# –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

> **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-12-11

---

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **Swift Testing** ‚Äî —Ç–æ–ª—å–∫–æ Swift Testing, –ù–ï XCTest
2. **TDD –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** ‚Äî —Ç–µ—Å—Ç—ã –î–û —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ([workflow](#tdd-workflow-outside-in))
3. **swift test –±–µ–∑ pipe** ‚Äî `swift test | head/tail/grep` –≤—ã–∑—ã–≤–∞–µ—Ç SIGPIPE –∑–∞–≤–∏—Å–∞–Ω–∏–µ
4. **Async –±–µ–∑ sleep** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π async –ø–∞—Ç—Ç–µ—Ä–Ω—ã ([—Å–º. –Ω–∏–∂–µ](#async-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ))
5. **–ù–µ raw JSON** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –º–æ–¥–µ–ª–∏ + encode
6. **üî¥ Research-First –¥–ª—è External API** ‚Äî WebFetch docs + failing test –î–û —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ([—á–µ–∫–ª–∏—Å—Ç](#research-first-retro-2024-11))
7. **üî¥ Mock —Ç–æ–ª—å–∫–æ boundaries** ‚Äî FFI/network/filesystem, –ù–ï internal logic ([–¥–µ—Ç–∞–ª–∏](#–ø—Ä–∞–≤–∏–ª–∞-–º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è))

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
‚úÖ swift test 2>&1
‚úÖ swift test --filter MyTest 2>&1
```

---

## –£—Ä–æ–≤–Ω–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –£—Ä–æ–≤–µ–Ω—å | –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç | Mock |
|---------|---------------|------|
| **E2E** | User story —Ü–µ–ª–∏–∫–æ–º | –†–µ–∞–ª—å–Ω—ã–π TDLib |
| **Component** | –û–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç | MockTDLibClient |
| **Unit** | –§—É–Ω–∫—Ü–∏—è/–º–æ–¥–µ–ª—å | –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π |

```
–ù–æ–≤–∞—è user story?           ‚Üí E2E + Component —Ç–µ—Å—Ç—ã
–ß–∞—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π story?   ‚Üí Component —Ç–µ—Å—Ç
–ú–æ–¥–µ–ª—å/encoder/decoder?     ‚Üí Unit —Ç–µ—Å—Ç
```

### –ü—Ä–∞–≤–∏–ª–∞ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏–Ω—Ü–∏–ø:** Mock –¢–û–õ–¨–ö–û –≤–Ω–µ—à–Ω–∏–µ boundaries (FFI, network, filesystem), –ù–ï high-level API.

| –ß—Ç–æ –º–æ–∫–∞–µ–º | –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚úÖ | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚ùå |
|------------|-------------|----------------|
| TDLib | MockTDLibFFI (rawSend/rawReceive) | MockTDLibClient (–≤–µ—Å—å API) |
| HTTP | MockHTTPClient (send request) | MockSummaryGenerator (–ª–æ–≥–∏–∫–∞) |
| Filesystem | MockFileSystem (read/write) | MockConfig (–ø–∞—Ä—Å–∏–Ω–≥) |

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É (ResponseWaiters, JSON –ø–∞—Ä—Å–∏–Ω–≥, error handling) ‚Üí –º–µ–Ω—å—à–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –±–æ–ª—å—à–µ –ø–æ–∫—Ä—ã—Ç–∏–µ.

**–ò—Å—Ç–æ—Ä–∏—è:** [retro-2024-11-analysis.md](archived/retro-2024-11-analysis.md#–±–ª–æ–∫-4-overhead-–æ—Ç-mockclient-–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ-–ª–æ–≥–∏–∫–∏-real-–∫–ª–∏–µ–Ω—Ç–∞)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö

**–ü—Ä–∏–Ω—Ü–∏–ø:** —Ç–µ—Å—Ç—ã = –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–Ω–∞–Ω–∏–π –æ –≤–Ω–µ—à–Ω–∏—Ö API, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ä–µ—à–µ–Ω–∏—è—Ö –∏ –º–æ–¥–µ–ª—è—Ö.

| –£—Ä–æ–≤–µ–Ω—å | –ß—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å | –ü—Ä–∏–º–µ—Ä |
|---------|---------------------|--------|
| **Unit** (–≤–Ω–µ—à–Ω–∏–π API) | –°—Å—ã–ª–∫–∏ –Ω–∞ API docs, –ø—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª—å–Ω—ã—Ö JSON | [ChatTests.swift](../Tests/TgClientUnitTests/TDLibAdapter/TDLibCodableModels/Responses/ChatTests.swift) |
| **Unit** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –º–æ–¥–µ–ª—å) | –ö–æ–Ω—Ç—Ä–∞–∫—Ç, edge cases, –ø—Ä–∏—á–∏–Ω—ã —Ä–µ—à–µ–Ω–∏–π | [ResponseWaitersTests.swift](../Tests/TgClientUnitTests/TDLibAdapter/ResponseWaitersTests.swift) |
| **Component** | –°—Å—ã–ª–∫–∏ –Ω–∞ unit —Ç–µ—Å—Ç—ã/–º–æ–¥–µ–ª–∏, –Ω–µ–∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ | [AuthenticationFlowTests.swift](../Tests/TgClientComponentTests/TDLibAdapter/AuthenticationFlowTests.swift) |
| **E2E** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π, —Ä—É—á–Ω–∞—è/–ø–æ–ª—É—Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ | `Tests/TgClientE2ETests/` –∏–ª–∏ `scripts/manual_*.sh` |

---

## Research-First [RETRO-2024-11]

**–ö–æ–≥–¥–∞:** –Ω–æ–≤—ã–π API –∏–ª–∏ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API (TDLib, HTTP, –±–∏–±–ª–∏–æ—Ç–µ–∫–∞).

### üî¥ –ß–µ–∫–ª–∏—Å—Ç: External API

```
‚òê WebFetch –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã + behaviour + edge cases)
‚òê Failing test —Å –∫—Ä–∞–µ–≤—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏
‚òê Live —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç (–µ—Å–ª–∏ —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞: offset, pagination, async updates)
‚òê –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
```

### üî¥ –ß–µ–∫–ª–∏—Å—Ç: External API –º–æ–¥–µ–ª–∏

```
‚òê WebFetch docs (—Ç–∏–ø—ã –ø–æ–ª–µ–π)
‚òê Manual E2E –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ JSON (debug –ª–æ–≥)
‚òê Unit test –º–æ–¥–µ–ª–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º JSON (–ü–û–°–õ–ï E2E, –Ω–µ –î–û)
```

| –®–∞–≥ | –î–µ–π—Å—Ç–≤–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-----|----------|-----------|
| 1. Spike | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è + **throwaway –∫–æ–¥** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è (‚â§30 –º–∏–Ω) | "API —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫" |
| 2. Architecture | Edge cases? Concurrency? Memory? | –ü—Ä–æ–≥–æ–≤–æ—Ä–∏—Ç—å –≤—Å–ª—É—Ö |
| 3. ADR | –ï—Å–ª–∏ >50 —Å—Ç—Ä–æ–∫ ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å –≤ ARCHITECTURE.md | –î–æ–∫—É–º–µ–Ω—Ç —Ä–µ—à–µ–Ω–∏—è |
| 4. TDD | –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —à–∞–≥–æ–≤ 1-3 | RED ‚Üí GREEN ‚Üí REFACTOR |

**‚ö†Ô∏è Spike = –∫–æ–¥!** –†–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ API –º–æ–∂–µ—Ç —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.

**–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–∞–≤–∏–ª–∞:** –ü—Ä–æ–ø—É—Å–∫ spike ‚Üí –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ (–∞—Ä—Ö–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã v0.3.0, Race Condition v0.2.0).

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ v0.3.0:**
- –ë–µ–∑ Research-First: **100% –±–∞–≥–æ–≤**
- –° Research-First: **0% –±–∞–≥–æ–≤**

---

## TDD Workflow: Outside-In

```
RED ‚Üí GREEN ‚Üí REFACTOR
```

### –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫-–ª–∏—Å—Ç

```
‚òê User Story –¥–æ–∫—É–º–µ–Ω—Ç (E2E-Scenarios/*.md) ‚Äî —á—Ç–æ –¥–µ–ª–∞–µ–º, –∑–∞—á–µ–º, –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
‚òê Research-First (–µ—Å–ª–∏ External API ‚Äî —Å–º. –Ω–∏–∂–µ)
‚òê Architecture-First (–µ—Å–ª–∏ concurrency ‚Äî —Å–º. –Ω–∏–∂–µ)
‚òê E2E Test (RED) ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π full scenario
‚òê Component Test (RED) ‚Äî –¥–µ—Ç–∞–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
‚òê Models + Unit Tests ‚Üí GREEN
‚òê Implementation ‚Üí GREEN (E2E + Component —Ç–µ—Å—Ç—ã)
‚òê REFACTOR
‚òê E2E validation (manual ‚Äî –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
```

**–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:** [TESTING-PATTERNS.md#–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è-—Ç–µ—Å—Ç–æ–≤](TESTING-PATTERNS.md#–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è-—Ç–µ—Å—Ç–æ–≤)

### –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ç–µ—Å—Ç–æ–≤

–ï—Å–ª–∏ Component Test > 30-40 —Å—Ç—Ä–æ–∫ ‚Üí —Ä–∞–∑–±–µ–π –Ω–∞ —á–∞—Å—Ç–∏:

```
Test 1: –ø–µ—Ä–≤—ã–π —à–∞–≥ (happy)
Test 2: –ø–µ—Ä–≤—ã–π —à–∞–≥ (error)
...
Integration Test: –≤—Å—è —Ü–µ–ø–æ—á–∫–∞
```

### –î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞

```
1. Happy path ‚Üí RED ‚Üí GREEN ‚Üí REFACTOR
2. Edge cases (—Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ)
3. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
```

**–ú–∞—Ç—Ä–∏—Ü–∞ edge cases:** [TESTING-PATTERNS.md#edge-cases](TESTING-PATTERNS.md#edge-cases-–ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π-–ø–æ–¥—Ö–æ–¥)

---

## Async —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –ü–∞—Ç—Ç–µ—Ä–Ω | –ö–æ–≥–¥–∞ | –ü–æ–¥—Ä–æ–±–Ω–µ–µ |
|---------|-------|-----------|
| `confirmation()` | AsyncStream, –ø–æ–¥—Å—á—ë—Ç —Å–æ–±—ã—Ç–∏–π | [TESTING-PATTERNS.md](TESTING-PATTERNS.md#–ø–∞—Ç—Ç–µ—Ä–Ω-1-confirmation) |
| `withMainSerialExecutor` | –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ | [TESTING-PATTERNS.md](TESTING-PATTERNS.md#–ø–∞—Ç—Ç–µ—Ä–Ω-2-withmainserialexecutor) |

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
Tests/
‚îú‚îÄ‚îÄ TestHelpers/              # –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã (DocC –≤ –∫–æ–¥–µ)
‚îú‚îÄ‚îÄ TgClientUnitTests/        # Unit —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ TgClientComponentTests/   # Component —Ç–µ—Å—Ç—ã
‚îî‚îÄ‚îÄ TgClientE2ETests/         # E2E —Ç–µ—Å—Ç—ã
```

---

## –°—Å—ã–ª–∫–∏

| –¢–µ–º–∞ | –§–∞–π–ª |
|------|------|
| –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è, edge cases, REFACTOR, async | [TESTING-PATTERNS.md](TESTING-PATTERNS.md) |
| –ü—Ä–æ–±–ª–µ–º—ã —Å–±–æ—Ä–∫–∏/—Ç–µ—Å—Ç–æ–≤ | [TROUBLESHOOTING.md#—Ç–µ—Å—Ç—ã](TROUBLESHOOTING.md#–ø—Ä–æ–±–ª–µ–º—ã-—Å-—Ç–µ—Å—Ç–∞–º–∏) |
