# –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

> üìã **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-10-28

## ‚ö†Ô∏è –ù–µ—Å–Ω–∏–º–∞–µ–º–æ–µ –ø—Ä–∞–≤–∏–ª–æ

**–í—Å–µ —Ç–µ—Å—Ç—ã –ø–∏—à—É—Ç—Å—è –¢–û–õ–¨–ö–û –Ω–∞ Swift Testing —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ (–ù–ï XCTest).**

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://developer.apple.com/documentation/testing

---

## –£—Ä–æ–≤–Ω–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Unit-—Ç–µ—Å—Ç—ã
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π/–∫–ª–∞—Å—Å–æ–≤
- –ú–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ë—ã—Å—Ç—Ä—ã–µ, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
- –ü—Ä–∏–º–µ—Ä—ã: TDLibRequestEncoder, TDLibUpdate, –º–æ–¥–µ–ª–∏

#### –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è Unit-—Ç–µ—Å—Ç–æ–≤

**Rule #6: Regression —Ç–µ—Å—Ç—ã –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏**

‚ö†Ô∏è **–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –±–∞–≥–∞ –≤–æ –≤—Ä–µ–º—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏–ª–∏ –¥–µ–±–∞–≥–∞ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–ø–∏—à–∏ —Ç–µ—Å—Ç!**

**Workflow:**
1. –ù–∞—à—ë–ª –±–∞–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `@type` –Ω–µ –∫–æ–¥–∏—Ä—É–µ—Ç—Å—è –≤ JSON)
2. **–°–Ω–∞—á–∞–ª–∞** –Ω–∞–ø–∏—à–∏ falling test, –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –±–∞–≥
3. **–ü–æ—Ç–æ–º** –∏—Å–ø—Ä–∞–≤—å –∫–æ–¥
4. –£–±–µ–¥–∏—Å—å —á—Ç–æ —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç
5. –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `// Regression test:` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –±–∞–≥–∞

**–ü—Ä–∏–º–µ—Ä:**
```swift
/// –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ @type –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏ encoding.
///
/// **Regression test:** –ë–µ–∑ @type –≤ JSON, TDLibClient –Ω–µ –º–æ–∂–µ—Ç —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å response.
/// Bug –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ MockTDLibFFI - responses –Ω–µ –º–∞—Ç—á–∏–ª–∏—Å—å.
@Test("Encoding –≤–∫–ª—é—á–∞–µ—Ç @type='error'")
func encodingIncludesAtType() throws {
    let error = TDLibErrorResponse(code: 500, message: "Internal error")
    let data = try JSONEncoder.tdlib().encode(error)
    let json = try JSONSerialization.jsonObject(with: data) as? [String: Any]

    #expect(json?["@type"] as? String == "error")
}
```

**–ó–∞—á–µ–º:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏—é –≤ –±—É–¥—É—â–µ–º. –¢–µ—Å—Ç ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –±–∞–≥–∞.

---

**Rule #7: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π raw JSON –≤ —Ç–µ—Å—Ç–∞—Ö**

‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û:** –í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–º–æ–¥–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã** –≤–º–µ—Å—Ç–æ raw JSON —Å—Ç—Ä–æ–∫.

**‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```swift
let json = """
{
    "@type": "message",
    "id": 123,
    "chat_id": 456
}
"""
let data = json.data(using: .utf8)!
let message = try JSONDecoder.tdlib().decode(Message.self, from: data)
```

**‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```swift
let original = Message(
    id: 123,
    chatId: 456,
    date: 1699564800,
    content: .text(FormattedText(text: "Hello", entities: nil))
)

// Round-trip test
let data = try original.toTDLibData()  // Helper –∏–∑ TestHelpers module
let decoded = try JSONDecoder.tdlib().decode(Message.self, from: data)
#expect(decoded.id == 123)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- ‚úÖ Compile-time –ø—Ä–æ–≤–µ—Ä–∫–∞ (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Üí —Ç–µ—Å—Ç—ã –Ω–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è)
- ‚úÖ –ú–µ–Ω—å—à–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ—Ç –Ω—É–∂–¥—ã –ø–∏—Å–∞—Ç—å JSON –≤—Ä—É—á–Ω—É—é)
- ‚úÖ –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å (Swift –∫–æ–¥ vs JSON —Å—Ç—Ä–æ–∫–∏)
- ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (IDE –ø–æ–º–æ–∂–µ—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ–ª—è)

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è helper:**
- `Tests/TestHelpers/EncodableExtensions.swift` ‚Üí `.toTDLibData()`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `JSONEncoder.tdlib()` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

**–ö–æ–≥–¥–∞ –ù–ï –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ:**
- –¢–µ—Å—Ç—ã –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è **–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ JSON** (–ø—Ä–æ–≤–µ—Ä–∫–∞ error handling)
- –ü—Ä–∏–º–µ—Ä—ã: missing fields, wrong types, invalid @type

**–°—Å—ã–ª–∫–∏:**
- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: `.claude/TASKS.md` ‚Üí TD-7 (—É–±—Ä–∞—Ç—å raw JSON –∏–∑ ResponseTests)
- –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤: `Tests/TgClientUnitTests/.../ChatResponseTests.swift`

---

**Rule #8: TDLibResponse –û–ë–Ø–ó–ê–ù–´ –≤–∫–ª—é—á–∞—Ç—å @type –≤ encoded JSON**

‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û:** –í—Å–µ TDLibResponse –º–æ–¥–µ–ª–∏ –î–û–õ–ñ–ù–´ –≤–∫–ª—é—á–∞—Ç—å –ø–æ–ª–µ `@type` –≤ encoded JSON.

**–ü—Ä–∏—á–∏–Ω–∞:**
TDLibClient.startUpdatesLoop() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@type` –¥–ª—è routing responses.
–ë–µ–∑ `@type` response —Ç–µ—Ä—è–µ—Ç—Å—è –≤ background loop ‚Üí –∑–∞–≤–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –∏ production –∫–æ–¥–∞!

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–æ–¥–µ–ª–∏:**
1. –°–≤–æ–π—Å—Ç–≤–æ: `public let type = "typeName"`
2. CodingKeys –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: `case type = "@type"`

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ç–µ—Å—Ç–∞—Ö:**
```swift
import TestHelpers

@Test func roundTrip() throws {
    let response = YourResponse(...)

    // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û! –ü—Ä–æ–≤–µ—Ä—è–µ–º @type –≤ encoded JSON
    try response.assertValidEncoding()

    let data = try response.toTDLibData()
    // ...
}
```

**–ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤:**
- 2025-11-28: MessagesResponse –Ω–µ –∏–º–µ–ª `case type = "@type"` –≤ CodingKeys ‚Üí –∑–∞–≤–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ 2+ —á–∞—Å–∞

**–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π Response –º–æ–¥–µ–ª–∏:**
1. –î–æ–±–∞–≤—å `public let type = "typeName"` (–∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ TDLib docs)
2. –î–æ–±–∞–≤—å `case type = "@type"` –≤ CodingKeys
3. –°–æ–∑–¥–∞–π unit test —Å `assertValidEncoding()`
4. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç ‚Üí –µ—Å–ª–∏ fail, –ø—Ä–æ–≤–µ—Ä—å CodingKeys

**–°–º. —Ç–∞–∫–∂–µ:**
- `Tests/TestHelpers/TDLibResponseValidation.swift` ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è assertValidEncoding()
- `.claude/RETROSPECTIVE.md` ‚Äî –¥–µ—Ç–∞–ª–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞

---

**Rule #9: –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (@Test(arguments:))**

‚ö†Ô∏è **–ò—Å—Ç–æ—á–Ω–∏–∫:** https://swiftology.io/articles/pitfalls-of-parameterized-tests/

**–ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã—Ö –∏–∑–±–µ–≥–∞–µ–º:**

**1. –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–∞—Å–∫–∏—Ä—É—é—Ç –±–∞–≥–∏**
```swift
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –∑–µ—Ä–∫–∞–ª–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
@Test(arguments: ChatType.allCases)
func chatTypeGreeting(type: ChatType) {
    #expect(greeting(of: type) == "Hello \(type.rawValue)!")  // –ü—Ä–æ–π–¥—ë—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –Ω–µ–≤–µ—Ä–Ω–∞
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
@Test(arguments: [
    (.private, "Hello Private Chat!"),
    (.supergroup, "Hello Group!"),
    (.channel, "Hello Channel!")
])
func chatTypeGreeting(type: ChatType, expected: String) {
    #expect(greeting(of: type) == expected)
}
```

**2. –õ–æ–≥–∏–∫–∞ –≤ —Ç–µ—Å—Ç–∞—Ö (if/else –¥—É–±–ª–∏—Ä—É–µ—Ç –∫–æ–¥)**
```swift
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: —Ç–µ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
@Test(arguments: ChatType.allCases)
func chatPermissions(type: ChatType) {
    if type == .channel {
        #expect(permissions(for: type).canPost == false)
    } else {
        #expect(permissions(for: type).canPost == true)
    }
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: —Ä–∞–∑–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
@Test("Channels are read-only")
func channelsReadOnly() {
    #expect(permissions(for: .channel).canPost == false)
}

@Test(arguments: [ChatType.private, .supergroup, .basicGroup])
func groupsAllowPosting(type: ChatType) {
    #expect(permissions(for: type).canPost == true)
}
```

**3. –•—Ä—É–ø–∫–∏–µ —Ç–µ—Å—Ç—ã —á–µ—Ä–µ–∑ zip() + CaseIterable**
```swift
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ enum cases
@Test(arguments: zip(Ingredient.allCases, Dish.allCases))
func cook(_ ingredient: Ingredient, into dish: Dish) {
    #expect(cook(ingredient) == dish)
}
// –ü—Ä–æ–±–ª–µ–º–∞: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ enum ‚Üí —Ç–µ—Å—Ç —Å–ª–æ–º–∞–µ—Ç—Å—è –ë–ï–ó –ø—Ä–∏—á–∏–Ω—ã

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: —è–≤–Ω—ã–µ –ø–∞—Ä—ã (–º–∞—Å—Å–∏–≤ –∫–æ—Ä—Ç–µ–∂–µ–π)
@Test(arguments: [
    (.rice, .onigiri),
    (.potato, .fries),
    (.egg, .omelette)
])
func cook(_ ingredient: Ingredient, into dish: Dish) {
    #expect(cook(ingredient) == dish)
}
```

**4. –ü–æ—Ç–µ—Ä—è coverage —á–µ—Ä–µ–∑ zip()**
```swift
// ‚ùå –û–ü–ê–°–ù–û: zip –æ–±—Ä–µ–∑–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã
zip([.rice, .potato, .egg, .tomato], [.onigiri, .fries, .omelette])
// .tomato –ü–†–û–ü–ê–î–Å–¢ –∏–∑ —Ç–µ—Å—Ç–æ–≤ –ë–ï–ó –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: —è–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ
@Test(arguments: [
    (.rice, .onigiri),
    (.potato, .fries),
    (.egg, .omelette),
    (.tomato, .salad)  // –Ø–≤–Ω–æ –≤–∏–¥–∏–º —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏
])
```

**–ö–æ–≥–¥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —É–º–µ—Å—Ç–Ω–∞:**

**Property-based —Ç–µ—Å—Ç—ã:**
```swift
// ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –í–°–ï–• –∑–Ω–∞—á–µ–Ω–∏–π
@Test("Full clockwise rotation returns to original",
      arguments: Orientation.allCases)
func fullCircle(orientation: Orientation) {
    let rotated = orientation
        .turnClockwise()
        .turnClockwise()
        .turnClockwise()
        .turnClockwise()
    #expect(rotated == orientation)  // –°–≤–æ–π—Å—Ç–≤–æ: 4 –ø–æ–≤–æ—Ä–æ—Ç–∞ = 360¬∞
}

// ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è numeric —Ç–∏–ø–æ–≤
@Test(arguments: [Int64.min, -1, 0, 1, Int64.max])
func chatIdValidation(chatId: Int64) {
    #expect(throws: Never.self) {
        _ = try ChatRequest(chatId: chatId)  // –î–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å –í–°–ï Int64
    }
}
```

**–ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º @Test(arguments:):**
- [ ] –≠—Ç–æ property-based —Ç–µ—Å—Ç? (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ)?
- [ ] –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `zip()` —Å —Ä–∞–∑–Ω—ã–º–∏ enum?
- [ ] –ù–ï–¢ `if/else` –ª–æ–≥–∏–∫–∏ –≤ —Ç–µ–ª–µ —Ç–µ—Å—Ç–∞?
- [ ] –ú–∞—Å—Å–∏–≤ –∫–æ—Ä—Ç–µ–∂–µ–π —á–∏—Ç–∞–µ–º –∏ –ø–æ–Ω—è—Ç–µ–Ω?

**–ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –ª—É—á—à–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, —á–µ–º –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å –ª–æ–≥–∏–∫–æ–π.

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Actor –∫–æ–¥–∞: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** Actor –º–µ—Ç–æ–¥—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, –Ω–æ `withCheckedContinuation` —Ç—Ä–µ–±—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ closure.

**‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (race condition):**
```swift
let task = Task {
    try await withCheckedContinuation { continuation in
        Task { await actor.method(continuation) }  // ‚ö†Ô∏è –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ—Ä—è–¥–æ–∫!
    }
}
await Task.yield()  // ‚ö†Ô∏è –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ!
await actor.resume()  // –ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –î–û method()
```

**‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–π test helper —Å callback):**
```swift
// Extension —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
extension MyActor {
    nonisolated func methodWithCallback(
        continuation: CheckedContinuation<Result, Error>,
        onRegistered: @escaping @Sendable () -> Void
    ) {
        Task {
            await self.method(continuation)
            onRegistered()  // ‚úÖ –°–∏–≥–Ω–∞–ª: –≥–æ—Ç–æ–≤–æ
        }
    }
}

// –í —Ç–µ—Å—Ç–µ: AsyncStream –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è
let (stream, streamCont) = AsyncStream.makeStream(of: Void.self)
let task = Task {
    try await withCheckedContinuation { continuation in
        actor.methodWithCallback(continuation: continuation) {
            streamCont.yield(())  // –°–∏–≥–Ω–∞–ª: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        }
    }
}
_ = await stream.first(where: { _ in true })  // –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
await actor.resume()  // –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ!
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:** `Tests/.../ResponseWaitersTests.swift` ‚Üí `addWaiterWithCallback`

### Component-—Ç–µ—Å—Ç—ã
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- –ë–µ–∑ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏
- –ú–æ–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è C API –∏ —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- –ü—Ä–∏–º–µ—Ä—ã: TDLibClient (—Å –º–æ–∫ TDLib), –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### E2E-—Ç–µ—Å—Ç—ã
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º TDLib
- –¢—Ä–µ–±—É—é—Ç credentials
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤ CI
- –ü—Ä–∏–º–µ—Ä—ã: –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤:**

E2E —Ç–µ—Å—Ç—ã **–æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** —á–µ—Ä–µ–∑ `.disabled()` trait.

```bash
# –û–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ - –ë–ï–ó E2E —Ç–µ—Å—Ç–æ–≤ (–±—ã—Å—Ç—Ä–æ)
swift test

# E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –í–†–£–ß–ù–£–Æ –∏–∑ Xcode –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
# (—Ç—Ä–µ–±—É—é—Ç credentials –∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –≤ ~/.tdlib/)
```

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å E2E —Ç–µ—Å—Ç—ã:**
- ‚úÖ –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–µ–ª–∏–∑–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ Linux!)
- ‚úÖ –ü–æ—Å–ª–µ –∫—Ä—É–ø–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ TDLibAdapter
- ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å TDLib
- ‚ùå –ù–ï –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (–∏—Å–ø–æ–ª—å–∑—É–π Unit/Component —Ç–µ—Å—Ç—ã)

**–ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è –¥–ª—è E2E:**
- `.env` —Ñ–∞–π–ª —Å `TELEGRAM_API_ID`, `TELEGRAM_API_HASH`
- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è TDLib –≤ `~/.tdlib/` (–≤—ã–ø–æ–ª–Ω–∏—Ç—å `swift run tg-client` –µ—Å–ª–∏ –Ω–µ—Ç)
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Telegram –∫–∞–Ω–∞–ª—ã —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

## TDD Workflow

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ E2E —Å—Ü–µ–Ω–∞—Ä–∏—è (DoCC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

**–¶–µ–ª—å:** –û–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user story), –±–µ–∑ –∏–∑–ª–∏—à–Ω–∏—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π.

#### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã E2E —Å—Ü–µ–Ω–∞—Ä–∏—è

**1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ**
```markdown
# [Feature Name]

[–û–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚Äî —á—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]
```

**2. User Story**
–û–ø–∏—Å–∞–Ω–∏–µ —Å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —á—Ç–æ –æ–Ω —Ö–æ—á–µ—Ç —Å–¥–µ–ª–∞—Ç—å –∏ –∫–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–∏—Ç—å.

```markdown
## User Story

–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —è —Ö–æ—á—É [–¥–µ–π—Å—Ç–≤–∏–µ], —á—Ç–æ–±—ã [—Ä–µ–∑—É–ª—å—Ç–∞—Ç].

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: [–æ–ø–∏—Å–∞–Ω–∏–µ]
- –û—à–∏–±–∫–∏: –Ø–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
```

**3. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)**
–°—Å—ã–ª–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç–∞—Ç—å–∏/—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–µ –≤–µ—Å—å —Ñ–ª–æ—É (–Ω–µ –º–æ–¥–µ–ª–∏!).

```markdown
## –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏](https://example.com/flow-guide)
```

**4. –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è**
–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ/–≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–æ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.

```markdown
## –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è

- `.env` —Ñ–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ (—Å–º. `.env.example`)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: `api_id`, `api_hash`, `encryption_key`, `tdlib_path`
- [–î—Ä—É–≥–∏–µ –ø—Ä–µ–¥—É—Å–ª–æ–≤–∏—è]
```

**5. –®–∞–≥–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è**
–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```markdown
## –®–∞–≥–∏

1. **[–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞]** ‚Äî [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ]
   - **–í–≤–æ–¥:** [—á—Ç–æ –≤–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç:** [—á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]
   - **–û—à–∏–±–∫–∏:** –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

2. **[–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥]** ‚Äî ...

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2FA) —É–∫–∞–∑–∞—Ç—å —è–≤–Ω–æ.
```

**6. –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π**
–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤—Ä—É—á–Ω—É—é.

```markdown
## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π

**–ó–∞–ø—É—Å–∫:**
\`\`\`bash
swift run tg-client [–∫–æ–º–∞–Ω–¥–∞]
# –∏–ª–∏
./scripts/test-scenario.sh
\`\`\`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º:**
1. [–®–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ 1]
2. [–®–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ 2]

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** [–æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è]
```

**7. –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π —Ç–µ—Å—Ç**
–û–¥–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π Component Test (–Ω–µ –Ω–∞ –º–æ–¥–µ–ª–∏!).

```markdown
## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π —Ç–µ—Å—Ç

<doc:ComponentTestName>
```

#### –ß—Ç–æ –ù–ï –≤–∫–ª—é—á–∞—Ç—å –≤ E2E —Å—Ü–µ–Ω–∞—Ä–∏–π

‚ùå **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –Ω–∞ –º–æ–¥–µ–ª–∏** ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç –≤ Component/Unit —Ç–µ—Å—Ç–∞—Ö
‚ùå **–¢–∞–±–ª–∏—Ü—ã –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫** ‚Äî –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –º–æ–¥–µ–ª–∏ –æ—à–∏–±–æ–∫
‚ùå **–°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è
‚ùå **–í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞ Request/Response –º–æ–¥–µ–ª–∏** ‚Äî —Ç–æ–ª—å–∫–æ –æ–±—â–∏–π —Ñ–ª–æ—É
‚ùå **–î–∏–∞–≥—Ä–∞–º–º—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π** ‚Äî –µ—Å—Ç—å –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
‚ùå **–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞** ‚Äî —ç—Ç–æ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–µ user story
‚ùå **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ (JSON, API –≤—ã–∑–æ–≤—ã)** ‚Äî –≤ Component —Ç–µ—Å—Ç–∞—Ö

#### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è E2E —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ TgClient.md

**–í–ê–ñ–ù–û:** –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π E2E —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ü–µ–Ω–∞—Ä–∏—è.

```markdown
# –í Sources/TgClient/TgClient.docc/TgClient.md

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ (E2E) —Å—Ü–µ–Ω–∞—Ä–∏–∏

–ü–æ–ª–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º:
- <doc:Authentication> - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- <doc:FetchUnreadMessages> - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∫–∞–Ω–∞–ª–æ–≤
- <doc:[YourNewScenario]> - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
```

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏: –ù–æ–≤—ã–π E2E vs –ß–∞—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ

**–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–∏—Ä–æ–¥—É –∑–∞–¥–∞—á–∏.**

### –≠—Ç–æ –ù–û–í–´–ô E2E —Å—Ü–µ–Ω–∞—Ä–∏–π –µ—Å–ª–∏:

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **—è–≤–Ω–æ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç —Ü–µ–ª—å**: "–Ø —Ö–æ—á—É –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤"
- –≠—Ç–æ **—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ**, –Ω–µ –∑–∞–≤–∏—Å—è—â–µ–µ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–Ω–µ –¥—É–º–∞–µ—Ç –æ –¥–µ—Ç–∞–ª—è—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: –µ–º—É –≤–∞–∂–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –Ω–µ –ø—Ä–æ—Ü–µ—Å—Å

**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚úÖ "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Telegram" ‚Üí –Ω–æ–≤—ã–π E2E
- ‚úÖ "–ü–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è" ‚Üí –Ω–æ–≤—ã–π E2E
- ‚úÖ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞" ‚Üí –Ω–æ–≤—ã–π E2E

### –≠—Ç–æ –ß–ê–°–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ E2E –µ—Å–ª–∏:

- –≠—Ç–æ **—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å** —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥—Ä—É–≥–æ–π user story
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–Ω–µ –¥—É–º–∞–µ—Ç –æ–± —ç—Ç–æ–º** –∫–∞–∫ –æ–± –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ü–µ–ª–∏
- –≠—Ç–æ **HOW** (–∫–∞–∫ –¥–µ–ª–∞–µ–º), –∞ –Ω–µ **WHAT** (—á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚ùå "AsyncStream –¥–ª—è updates" ‚Üí Component Test (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å "–ü–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ")
- ‚ùå "–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤" ‚Üí Unit Test (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã)
- ‚ùå "Pagination —á–µ—Ä–µ–∑ loadChats" ‚Üí Component Test (–¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ "–ü–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ")

### –≠—Ç–æ –ß–ò–°–¢–û —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ (–ë–ï–ó E2E) –µ—Å–ª–∏:

- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ (–ø—Ä–æ—Ç–æ–∫–æ–ª—ã, helpers)

**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚ùå "–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ Encoder/Decoder" ‚Üí Unit Test
- ‚ùå "SwiftLint rules" ‚Üí –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤, –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚ùå "ChannelCache actor" ‚Üí Unit Test (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)

### üö® –ü—Ä–∞–≤–∏–ª–æ: –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏–∏ –°–ü–†–û–°–ò

**–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –Ω–∞ 100% - –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:**

> "–ó–∞–¥–∞—á–∞ '[–Ω–∞–∑–≤–∞–Ω–∏–µ]' ‚Äî —ç—Ç–æ –Ω–æ–≤–∞—è user story (–æ—Ç–¥–µ–ª—å–Ω—ã–π E2E —Å—Ü–µ–Ω–∞—Ä–∏–π) –∏–ª–∏ —á–∞—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ '[–Ω–∞–∑–≤–∞–Ω–∏–µ E2E]'?"

**–ù–ï –Ω–∞—á–∏–Ω–∞–π –ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞.**

---

### Outside-In TDD –¥–ª—è TDLib –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–ü—Ä–∏–Ω—Ü–∏–ø:** –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è (E2E), —Å–ø—É—Å–∫–∞–µ–º—Å—è –∫ –¥–µ—Ç–∞–ª—è–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

#### –ö—Ä–∞—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ reference)

```
‚òê E2E —Å—Ü–µ–Ω–∞—Ä–∏–π (.docc)
‚òê Component Test (RED - –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è)
‚òê Protocol extension (—Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞)
‚òê Unit Tests –¥–ª—è –º–æ–¥–µ–ª–µ–π (RED - –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è)
‚òê Models (Request/Response Codable) ‚Üí Unit Tests GREEN
‚òê Real implementation (TDLibClient) ‚Üí Component Test –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –Ω–æ RED
‚òê Mock implementation (MockTDLibClient) ‚Üí Component Test GREEN
‚òê E2E validation (manual –Ω–∞ –∂–∏–≤–æ–º TDLib)
‚òê –í–∞–ª–∏–¥–∞—Ü–∏—è DoCC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫)
‚òê Refactor (–∫–æ–¥ + –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
```

**–ù–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ:** –¥–µ–ª–∞–π –ø–∞—É–∑—É –∏ —Å–ø—Ä–∞—à–∏–≤–∞–π "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–ª—å—à–µ?"

#### –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º Outside-In (–∫–∞–∫ –º—ã —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ–º)

**–í–ê–ñ–ù–û:** –≠—Ç–æ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **—Ä–µ–∞–ª—å–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å**, –∞ –Ω–µ –ª–∏–Ω–µ–π–Ω—ã–π –ø–ª–∞–Ω.

```
1. –ù–∞–ø–∏—Å–∞—Ç—å –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π Component Test
   ‚îî‚îÄ> –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–ï–¢–°–Ø (–Ω–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞)

2. –°–æ–∑–¥–∞—Ç—å –∑–∞–≥–ª—É—à–∫–∏ (–º–∏–Ω–∏–º—É–º —á—Ç–æ–±—ã —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–ª–æ—Å—å)
   ‚îî‚îÄ> –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è, –ø–∞–¥–∞–µ—Ç –Ω–∞ fatalError

3. –ü–û–ü–´–¢–ê–¢–¨–°–Ø —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥
   ‚îî‚îÄ> –ü–∏—à–µ–º –∫–æ–¥ –∫–∞–∫ –±—É–¥—Ç–æ –≤—Å—ë –µ—Å—Ç—å
   ‚îî‚îÄ> ‚ö†Ô∏è –°–¢–û–ü! –û–±–Ω–∞—Ä—É–∂–∏–ª–∏: –Ω—É–∂–µ–Ω tdlib.loadChats() ‚Äî –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–ï–¢–°–Ø

4. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –¥–ª—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (–í –¢–û–ú –ñ–ï —Ñ–∞–π–ª–µ!)
   ‚îî‚îÄ> @Test("loadChats + updates stream")
   ‚îî‚îÄ> –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–ï–¢–°–Ø (–Ω–µ—Ç loadChats/updates)
   ‚îî‚îÄ> –≠—Ç–æ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏

5. –°–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ ‚Üí Unit —Ç–µ—Å—Ç—ã –¥–ª—è –º–æ–¥–µ–ª–µ–π
   ‚îî‚îÄ> LoadChatsRequestTests, UpdateTests
   ‚îî‚îÄ> Models implementation
   ‚îî‚îÄ> Real implementation (loadChats –≤ TDLibClient)
   ‚îî‚îÄ> Mock implementation

6. –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ ‚Üí –ø–æ–ø—ã—Ç–∫–∞ #2
   ‚îî‚îÄ> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é fetchUnreadMessages()
   ‚îî‚îÄ> ‚ö†Ô∏è –°–¢–û–ü! –û–±–Ω–∞—Ä—É–∂–∏–ª–∏: –Ω—É–∂–µ–Ω tdlib.getChatHistory()

7. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —à–∞–≥–∏ 4-6 –ø–æ–∫–∞ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ç–µ—Å—Ç –Ω–µ —Å—Ç–∞–Ω–µ—Ç GREEN
```

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ Outside-In:**
- ‚ùå –ù–ï –ø–ª–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –∑–∞—Ä–∞–Ω–µ–µ (overengineering)
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ **–ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –≤ **–æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ** (–≤–∏–¥–Ω–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è)

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:** `ChannelMessageSourceTests.swift`
- –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ç–µ—Å—Ç `fetchUnreadMessages()`
- –°–µ–∫—Ü–∏—è `// MARK: - –¢–µ—Å—Ç—ã –¥–ª—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞`
- –¢–µ—Å—Ç `loadChatsEmitsUpdateNewChat()` ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤–æ–π —Ñ–∏—á–∏ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π Outside-In, –¥–ª—è reference)

```
1. E2E —Å—Ü–µ–Ω–∞—Ä–∏–π (DoCC)
   ‚îî‚îÄ> –û–ø–∏—Å–∞–Ω–∏–µ user story –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
   ‚îî‚îÄ> –ü—Ä–∏–º–µ—Ä: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤"

2. Component Test (RED)
   ‚îî‚îÄ> ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–∏—à–µ–º –†–ï–ê–õ–¨–ù–´–ô –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞: `mockClient.loadChats()`, –∞ –ù–ï `mockClient.mockLoadChats()`
   ‚îî‚îÄ> ‚ö†Ô∏è –ù–ï –ü–†–ò–î–£–ú–´–í–ê–ô Mock API! –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ –∂–µ –∏–º—è –º–µ—Ç–æ–¥–∞ —á—Ç–æ –±—É–¥–µ—Ç –≤ TDLibClient
   ‚îî‚îÄ> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: —Ç—Ä–µ–±—É–µ–º—ã–µ Request/Response –º–æ–¥–µ–ª–∏ + —Å—Å—ã–ª–∫–∏ –Ω–∞ TDLib docs
   ‚îî‚îÄ> –ü—Ä–∏–º–µ—Ä JSON –∏–∑ TDLib (–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–ª–∏ fixtures)
   ‚îî‚îÄ> –¢–µ—Å—Ç –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–ï–¢–°–Ø ‚Äî –º–µ—Ç–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   ‚îî‚îÄ> –≠–¢–û –ò –ï–°–¢–¨ RED: –∫–æ–¥ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è, –∞ –Ω–µ "—Ç–µ—Å—Ç —Ñ–µ–π–ª–∏—Ç—Å—è —Å –∑–∞–≥–ª—É—à–∫–æ–π"

3. Protocol extension (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
   ‚îî‚îÄ> –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞—Ç—É—Ä—É –º–µ—Ç–æ–¥–∞ –≤ TDLibClientProtocol
   ‚îî‚îÄ> –°–º–æ—Ç—Ä–∏–º TDLib docs ‚Äî –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω—É–∂–Ω—ã, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
   ‚îî‚îÄ> –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø—ã: func loadChats(chatList: ChatList, limit: Int) async throws -> OkResponse
   ‚îî‚îÄ> Component Test –≤—Å—ë –µ—â—ë –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–ï–¢–°–Ø (–Ω–µ—Ç —Ç–∏–ø–∞ ChatList)

4. Unit Tests –¥–ª—è –º–æ–¥–µ–ª–µ–π (RED)
   ‚îú‚îÄ> LoadChatsRequestTests ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
   ‚îú‚îÄ> OkResponseTests ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ JSON
   ‚îî‚îÄ> –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ TDLib docs
   ‚îî‚îÄ> –¢–µ—Å—Ç—ã –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–Æ–¢–°–Ø (–Ω–µ—Ç –º–æ–¥–µ–ª–µ–π)

5. Models implementation (GREEN unit tests)
   ‚îú‚îÄ> –°–æ–∑–¥–∞—ë–º LoadChatsRequest, ChatList enum
   ‚îú‚îÄ> Unit-—Ç–µ—Å—Ç—ã –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –∏ –∑–µ–ª—ë–Ω—ã–µ
   ‚îî‚îÄ> Component Test –≤—Å—ë –µ—â—ë –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–ï–¢–°–Ø (–Ω–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ TDLibClient/Mock)

6. Real implementation (TDLibClient)
   ‚îî‚îÄ> –†–µ–∞–ª–∏–∑—É–µ–º loadChats() –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∫–ª–∏–µ–Ω—Ç–µ
   ‚îî‚îÄ> –ò—Å–ø–æ–ª—å–∑—É–µ–º Request/Response –∏–∑ —à–∞–≥–∞ 5
   ‚îî‚îÄ> –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, async/await, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   ‚îî‚îÄ> Component Test –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –≤—Å—ë –µ—â—ë RED (MockTDLibClient –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)

7. Mock implementation (MockTDLibClient)
   ‚îî‚îÄ> –í–ê–ñ–ù–û: Mock —Å–æ–∑–¥–∞—ë–º –ü–û–°–õ–ï —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
   ‚îî‚îÄ> Mock —Ç–æ—á–Ω–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ Real (–≤–∫–ª—é—á–∞—è edge cases)
   ‚îî‚îÄ> –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ JSON –ø—Ä–∏–º–µ—Ä—ã –∏–∑ fixtures

8. Component Test (GREEN)
   ‚îî‚îÄ> –¢–µ–ø–µ—Ä—å Mock –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
   ‚îî‚îÄ> Component Test –∑–µ–ª—ë–Ω—ã–π

9. E2E validation (manual)
   ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∂–∏–≤–æ–º TDLib
   ‚îî‚îÄ> –û–±–Ω–æ–≤–ª—è–µ–º DoCC —Å—Ü–µ–Ω–∞—Ä–∏–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

10. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    ‚îî‚îÄ> –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ./scripts/generate-docc-from-tests.sh
    ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ Component Test –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (.docc/Tests/Component-Tests/)
    ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ Unit-—Ç–µ—Å—Ç—ã –º–æ–¥–µ–ª–µ–π –≤–Ω—É—Ç—Ä–∏ Component —Ç–µ—Å—Ç–∞
    ‚îî‚îÄ> –î–æ–±–∞–≤–ª—è–µ–º E2E —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ TgClient.md (–µ—Å–ª–∏ –Ω–æ–≤—ã–π)
    ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ Component Test –≤ E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏

11. REFACTOR
    ‚îî‚îÄ> –ö–æ–¥: edge cases, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
    ‚îî‚îÄ> –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —É—Ç–æ—á–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤
```

---

### –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** User Story –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ Component Test –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è —Å–ª–æ–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- –§–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (updates handler, polling)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (in-memory cache, persistence)
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ edge cases (timeout, retry, circuit breaker)
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∑–æ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –æ–¥–Ω–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ

**–†–µ—à–µ–Ω–∏–µ:** –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω–∞ –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º **Single Responsibility Principle (SRP)**.

#### –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é?

**–ü—Ä–∏–∑–Ω–∞–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ Component Test:**

1. **Mock —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–æ–∂–Ω—ã–º:**
   ```swift
   // ‚ùå –ü–ª–æ—Ö–æ: MockTDLibClient –¥–æ–ª–∂–µ–Ω —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å updates, –∫—ç—à, retry logic
   mockClient.mockUpdatesSequence = [...]
   mockClient.mockCacheState = [...]
   mockClient.mockRetryBehavior = ...
   ```

2. **–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Å–ø–µ–∫—Ç–æ–≤:**
   ```swift
   // ‚ùå –ü–ª–æ—Ö–æ: –æ–¥–∏–Ω —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç loadChats, updates, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
   @Test func fetchUnreadMessages() async throws {
       // 50+ —Å—Ç—Ä–æ–∫ —Ç–µ—Å—Ç–∞
   }
   ```

3. **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–º–µ–µ—Ç > 1 –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
   ```swift
   // ‚ùå –ü–ª–æ—Ö–æ: ChannelMessageSource –¥–µ–ª–∞–µ—Ç –≤—Å—ë
   class ChannelMessageSource {
       func loadChats() { ... }          // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
       func handleUpdate() { ... }       // –û–±—Ä–∞–±–æ—Ç–∫–∞ updates
       func cacheChannel() { ... }       // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
       func filterUnread() { ... }       // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
       func fetchMessages() { ... }      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
   }
   ```

#### ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏

**‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: Overengineering –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π**

–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –¥–µ–ª–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞:
1. ‚úÖ –ü–æ–ø—ã—Ç–∞–ª—Å—è –Ω–∞–ø–∏—Å–∞—Ç—å Component Test
2. ‚úÖ –†–ï–ê–õ–¨–ù–û —É–≤–∏–¥–µ–ª —Å–ª–æ–∂–Ω–æ—Å—Ç—å (> 50 —Å—Ç—Ä–æ–∫, –º–Ω–æ–≥–æ –∞—Å–ø–µ–∫—Ç–æ–≤)
3. ‚úÖ –¢–û–ì–î–ê –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è

**–ù–ï –¥–µ–ª–∞–π:**
- ‚ùå "–≠—Ç–æ –±—É–¥–µ—Ç —Å–ª–æ–∂–Ω–æ" (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ —Ç–µ—Å—Ç–∞)
- ‚ùå "–ù–∞ –±—É–¥—É—â–µ–µ –ª—É—á—à–µ —Ä–∞–∑–±–∏—Ç—å" (YAGNI principle)
- ‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–æ Component Test

**–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ (MVP-1.6, 2025-11-12):**
```
‚ùå –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–ª–∏ —á—Ç–æ ChannelMessageSource —Å–ª–æ–∂–Ω—ã–π –ë–ï–ó –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç
‚ùå –°–æ–∑–¥–∞–ª–∏ UpdatesHandler (–æ–∫–∞–∑–∞–ª–æ—Å—å 3 —Å—Ç—Ä–æ–∫–∏ = for await loop)
‚ùå –°–æ–∑–¥–∞–ª–∏ ChannelCache –¥–ª—è realtime –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ù–ï –Ω—É–∂–µ–Ω –¥–ª—è stateless MVP)
‚ùå Overengineering –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±—ã–ª–æ: –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –Ω–∞–ø–∏—Å–∞—Ç—å Component Test —Å—Ä–∞–∑—É
‚úÖ –û–∫–∞–∑–∞–ª–æ—Å—å —á—Ç–æ ChannelMessageSource –≤–ø–æ–ª–Ω–µ —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ 1 actor –±–µ–∑ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```
‚úÖ –ù–∞–ø–∏—Å–∞–ª–∏ Component Test –¥–ª—è ChannelMessageSource
‚úÖ –£–≤–∏–¥–µ–ª–∏ —á—Ç–æ —Ç–µ—Å—Ç > 50 —Å—Ç—Ä–æ–∫, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç 5 –∞—Å–ø–µ–∫—Ç–æ–≤
‚úÖ –¢–û–ì–î–ê –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω–∞ Cache, Fetcher
```

#### –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π Outside-In TDD)

```
1. E2E —Å—Ü–µ–Ω–∞—Ä–∏–π (HIGH-LEVEL)
   ‚îî‚îÄ> User Story: "–ü–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–æ–≤"
   ‚îî‚îÄ> –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

2. Component Test (MEDIUM-LEVEL) ‚Üí –ü–´–¢–ê–ï–ú–°–Ø –ù–ê–ü–ò–°–ê–¢–¨ –¢–ï–°–¢
   ‚îî‚îÄ> –ü–∏—à–µ–º —Ç–µ—Å—Ç —Å MockTDLibClient
   ‚îî‚îÄ> –†–ï–ê–õ–¨–ù–û –≤–∏–¥–∏–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å (> 50 —Å—Ç—Ä–æ–∫, –º–Ω–æ–≥–æ –∞—Å–ø–µ–∫—Ç–æ–≤)
   ‚îî‚îÄ> ‚ö†Ô∏è –°–¢–û–ü! –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–∂–Ω—ã–π

3. –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è (ARCHITECTURE DECISION)
   ‚îî‚îÄ> –í—ã–¥–µ–ª—è–µ–º –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ –∑–æ–Ω–∞–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
       ‚îú‚îÄ [–ü—Ä–∏–º–µ—Ä] ChannelCache (actor) ‚Äî –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
       ‚îú‚îÄ [–ü—Ä–∏–º–µ—Ä] UpdatesHandler ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ TDLib updates
       ‚îú‚îÄ MessageFetcher ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∫–∞–Ω–∞–ª–æ–≤
       ‚îî‚îÄ ChannelMessageSource ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)

4. Unit Tests –¥–ª—è –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (LOW-LEVEL)
   ‚îú‚îÄ [–ü—Ä–∏–º–µ—Ä] ChannelCacheTests ‚Äî –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
   ‚îú‚îÄ [–ü—Ä–∏–º–µ—Ä] UpdatesHandlerTests ‚Äî –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
   ‚îî‚îÄ MessageFetcherTests ‚Äî –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ

5. Models + Unit Tests
   ‚îî‚îÄ> Request/Response –º–æ–¥–µ–ª–∏ –¥–ª—è TDLib –º–µ—Ç–æ–¥–æ–≤

6. Integration (ASSEMBLY)
   ‚îî‚îÄ> ChannelMessageSource —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å—ë –≤–º–µ—Å—Ç–µ
   ‚îî‚îÄ> Component Test –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã + MockTDLibClient

7. E2E validation
   ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∂–∏–≤–æ–º TDLib
```

#### –ü—Ä–∏–º–µ—Ä –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏: ChannelMessageSource

> ‚ö†Ô∏è **–í–ê–ñ–ù–û:** –≠—Ç–æ –ì–ò–ü–û–¢–ï–¢–ò–ß–ï–°–ö–ò–ô –ø—Ä–∏–º–µ—Ä –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏.
> –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è MVP-1.6 ChannelMessageSource –æ–∫–∞–∑–∞–ª—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç—ã–º (stateless –ø–æ–¥—Ö–æ–¥),
> –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –ù–ï –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å. ChannelCache/UpdatesHandler –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∫–∞–∫ overengineering.
>
> **–ü—Ä–∞–≤–∏–ª–æ –æ—Å—Ç–∞–µ—Ç—Å—è:** –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –Ω–∞–ø–∏—Å–∞—Ç—å Component Test,
> –µ—Å–ª–∏ –≤–∏–¥–∏–º > 50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∏ –º–Ω–æ–≥–æ –∞—Å–ø–µ–∫—Ç–æ–≤ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.
>
> –°–º. BACKLOG.md ‚Üí Realtime –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–∫–æ–º–º–∏—Ç—ã `00c9f3f`, `1a6a762`) –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

**–î–æ (–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç):**
```swift
// ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ SRP: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
actor ChannelMessageSource: MessageSourceProtocol {
    func fetchUnreadMessages() async throws -> [SourceMessage] {
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ loadChats loop
        // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ updates
        // 3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤
        // 4. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        // 5. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        // 6. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫
        // 100+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, 5 –∑–æ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
    }
}
```

**–ü–æ—Å–ª–µ (–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –ø–æ SRP):**
```swift
// ‚úÖ ChannelCache: –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û –∑–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
actor ChannelCache {
    private var channels: [Int64: ChannelInfo] = [:]

    func add(_ chat: Chat) { ... }
    func updateUnreadCount(chatId: Int64, count: Int) { ... }
    func getUnreadChannels() -> [ChannelInfo] { ... }
}

// ‚úÖ UpdatesHandler: –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É updates
actor UpdatesHandler {
    func start(tdlib: TDLibClientProtocol, onUpdate: @escaping (Update) -> Void) { ... }
    func stop() { ... }
}

// ‚úÖ MessageFetcher: –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û –∑–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
struct MessageFetcher {
    func fetch(from channels: [ChannelInfo]) async throws -> [SourceMessage] { ... }
}

// ‚úÖ ChannelMessageSource: –ö–û–û–†–î–ò–ù–ê–¢–û–† (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
actor ChannelMessageSource: MessageSourceProtocol {
    private let cache: ChannelCache
    private let updatesHandler: UpdatesHandler
    private let messageFetcher: MessageFetcher

    func fetchUnreadMessages() async throws -> [SourceMessage] {
        // –ü—Ä–æ—Å—Ç–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è: –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º
        let channels = await cache.getUnreadChannels()
        return try await messageFetcher.fetch(from: channels)
    }
}
```

#### –ü—Ä–∞–≤–∏–ª–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏

**1. Single Responsibility Principle (SRP):**
- –û–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç = –æ–¥–Ω–∞ –∑–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –ï—Å–ª–∏ –∫–ª–∞—Å—Å/actor > 100 —Å—Ç—Ä–æ–∫ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ SRP

**2. Dependency Injection:**
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `init`
- –ù–µ —Å–æ–∑–¥–∞—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è

**3. Testability:**
- –ö–∞–∂–¥—ã–π –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- Mock —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (TDLibClient, —Å–µ—Ç—å)

**4. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä vs Worker:**
- **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä** (ChannelMessageSource) ‚Äî –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á–∏, –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- **Worker** (ChannelCache, MessageFetcher) ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ª–æ–≥–∏–∫—É

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏

–ü–æ—Å–ª–µ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º:

**1. ARCHITECTURE.md:**
- –î–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –û–ø–∏—Å–∞—Ç—å –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ

**2. E2E —Å—Ü–µ–Ω–∞—Ä–∏–π (FetchUnreadMessages.md):**
- –ù–ï —É–ø–æ–º–∏–Ω–∞—Ç—å –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (—ç—Ç–æ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- –§–æ–∫—É—Å –Ω–∞ user story

**3. Component Test –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –£–ø–æ–º—è–Ω—É—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö)
- –°—Å—ã–ª–∫–∏ –Ω–∞ Unit-—Ç–µ—Å—Ç—ã –ø–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–µ)

**–°–º. —Ç–∞–∫–∂–µ:**
- <doc:../ARCHITECTURE.md#single-responsibility-principle> ‚Äî –¥–µ—Ç–∞–ª–∏ SRP –≤ –ø—Ä–æ–µ–∫—Ç–µ

---

#### –í–∞–ª–∏–¥–∞—Ü–∏—è DoCC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥)

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∏—á–∏ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

**–®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**
```bash
./scripts/generate-docc-from-tests.sh
```

**–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ Component Test –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–Ω .md —Ñ–∞–π–ª –¥–ª—è component —Ç–µ—Å—Ç–∞
ls Sources/TgClient/TgClient.docc/Tests/Component-Tests/[YourComponentTest].md
```

–í–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ (–∏–∑ @Suite doc comment)
- ‚úÖ –°–µ–∫—Ü–∏—è `## Topics` ‚Üí `### Unit-—Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π`
- ‚úÖ –°—Å—ã–ª–∫–∏ –Ω–∞ –≤—Å–µ Request/Response –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ `<doc:ModelNameTests>`

**–ü—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–µ–∫—Ü–∏–∏ Topics:**
```markdown
## Topics

### –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- <doc:TgClient>
- <doc:Authentication>

### Unit-—Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π

- <doc:SetAuthenticationPhoneNumberRequestTests>
- <doc:CheckAuthenticationCodeRequestTests>
- <doc:AuthorizationStateUpdateResponseTests>
- <doc:TDLibErrorResponseTests>
```

**–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ Unit Test –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–Ω—ã .md —Ñ–∞–π–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
ls Sources/TgClient/TgClient.docc/Tests/Unit-Tests/SetAuthenticationPhoneNumberRequestTests.md
ls Sources/TgClient/TgClient.docc/Tests/Unit-Tests/AuthorizationStateUpdateResponseTests.md
```

**–®–∞–≥ 4: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è E2E —Å—Ü–µ–Ω–∞—Ä–∏—è (–µ—Å–ª–∏ –Ω–æ–≤—ã–π)**

–î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ `Sources/TgClient/TgClient.docc/TgClient.md`:
```markdown
## Topics

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ (E2E) —Å—Ü–µ–Ω–∞—Ä–∏–∏

- <doc:Authentication>
- <doc:FetchUnreadMessages>
- <doc:[YourNewScenario]>  ‚Üê –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å
```

**–®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ Component Test –≤ E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏**

–í E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏ (`Sources/TgClient/TgClient.docc/E2E-Scenarios/[Scenario].md`) –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–µ–∫—Ü–∏—è:
```markdown
## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π —Ç–µ—Å—Ç

<doc:[YourComponentTest]>
```

**–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è:**
1. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ `@Suite` doc comment –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ñ–∞–π–ª–µ
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∏–º–µ–Ω–∞ Request/Response –º–æ–¥–µ–ª–µ–π —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö component —Ç–µ—Å—Ç–∞
3. –ó–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å –≤—ã–≤–æ–¥–æ–º –æ—à–∏–±–æ–∫: `bash -x ./scripts/generate-docc-from-tests.sh`

---

#### –ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è Component —Ç–µ—Å—Ç–æ–≤

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ @Suite:**
- ‚úÖ –û–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: —á—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- ‚úÖ Scope: 2-3 –ø—É–Ω–∫—Ç–∞ (–æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)
- ‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ TDLib docs (–µ—Å–ª–∏ applicable)
- ‚ùå –ù–ï–¢ —Å—Å—ã–ª–æ–∫ –Ω–∞ .claude/* (—ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Claude Code)
- ‚ùå –ù–ï–¢ –æ–ø–∏—Å–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π (—ç—Ç–æ –≤ ARCHITECTURE.md)
- ‚ùå –ù–ï–¢ –æ–ø–∏—Å–∞–Ω–∏—è async patterns (—ç—Ç–æ –≤ TESTING.md)
- ‚ùå –ù–ï–¢ —Å–µ–∫—Ü–∏–∏ "Related" —Å —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ unit-—Ç–µ—Å—Ç—ã (–æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ DoCC)

**–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
```swift
/// Component-—Ç–µ—Å—Ç—ã –¥–ª—è loadChats –∏ getChat —á–µ—Ä–µ–∑ TDLibClient.
///
/// **Scope:**
/// - `loadChats()` - –∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –≤ TDLib cache (—É—Å–ø–µ—Ö + 404 pagination)
/// - `getChat(chatId:)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ (—É—Å–ø–µ—Ö + –æ—à–∏–±–∫–∏)
///
/// **TDLib docs:**
/// - loadChats: https://core.telegram.org/tdlib/docs/classtd_1_1td__api_1_1load_chats.html
@Suite("TDLibAdapter: loadChats + getChat")
struct LoadChatsAndGetChatTests { ... }
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ —Ç–µ—Å—Ç–∞—Ö:**
- ‚úÖ –Ø–≤–Ω–æ —É–ø–æ–º–∏–Ω–∞–π Request/Response –º–æ–¥–µ–ª–∏ (–¥–ª—è DoCC –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
- ‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ TDLib docs –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ (–≤ docstring —Ç–µ—Å—Ç–∞)
- ‚ùå –ù–ï–¢ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≥–æ —á—Ç–æ —É–∂–µ –Ω–∞–ø–∏—Å–∞–Ω–æ –≤ –∫–æ–¥–µ —Ç–µ—Å—Ç–∞

#### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **RED = –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è** ‚Äî –Ω–∞—Å—Ç–æ—è—â–∏–π RED —Ç–µ—Å—Ç –ø–∏—à–µ—Ç—Å—è –∫–∞–∫ –±—É–¥—Ç–æ –º–µ—Ç–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
   ```swift
   @Test("–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –≤ –∫–µ—à")
   func loadChatsToCache() async throws {
       let mockClient = MockTDLibClient()
       let response = try await mockClient.loadChats(chatList: .main, limit: 100)
       #expect(response.type == "ok")
   }
   // –≠—Ç–æ—Ç —Ç–µ—Å—Ç –ù–ï –°–û–ë–ï–†–Å–¢–°–Ø ‚Äî –º–µ—Ç–æ–¥–∞ loadChats() –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   // –ù–ï –ü–ò–®–ò –∑–∞–≥–ª—É—à–∫–∏ —Ç–∏–ø–∞ #expect(Bool(false), "TODO")!
   ```

2. **Mock –ü–û–°–õ–ï Real ‚Äî –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π Mock API —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏!**

   **‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:**
   - –®–∞–≥ 2: Component Test –≤—ã–∑—ã–≤–∞–µ—Ç `mockClient.getChatHistory(chatId: 123)` (–†–ï–ê–õ–¨–ù–´–ô –º–µ—Ç–æ–¥)
   - –®–∞–≥ 6: –†–µ–∞–ª–∏–∑—É–µ–º `TDLibClient.getChatHistory()` —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫, async/await
   - –®–∞–≥ 7: MockTDLibClient –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥ `getChatHistory()` –∏ –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ Real

   **‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω):**
   ```swift
   // ‚ùå –ù–ï –î–ï–õ–ê–ô –¢–ê–ö! –ü—Ä–∏–¥—É–º—ã–≤–∞–Ω–∏–µ Mock API —Ä–∞–Ω—å—à–µ Real:
   mockClient.mockGetChat(id: 123, title: "Channel", type: .supergroup, unreadCount: 5)
   mockClient.mockLoadChats(chatIds: [123, 456])
   mockClient.setupMockData(...)

   // –ü—Ä–æ–±–ª–µ–º–∞: –º—ã –Ω–µ –∑–Ω–∞–µ–º –∫–∞–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –†–ï–ê–õ–¨–ù–´–ô getChat()!
   // - –ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω—É–∂–Ω—ã?
   // - –ö–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å?
   // - –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è edge case?
   ```

   **‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:**
   ```swift
   // –ü–∏—à–µ–º –∫–∞–∫ –±—É–¥—Ç–æ –º–µ—Ç–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
   let chat = try await mockClient.getChat(id: 123)
   #expect(chat.type == .supergroup(supergroupId: 123, isChannel: true))
   #expect(chat.unreadCount == 5)

   // Component Test –ù–ï –ö–û–ú–ü–ò–õ–ò–†–£–ï–¢–°–Ø (—ç—Ç–æ RED)
   // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 3: Protocol extension, —à–∞–≥—É 4: Unit Tests –º–æ–¥–µ–ª–µ–π, —à–∞–≥—É 6: Real implementation
   // –¢–û–õ–¨–ö–û –ü–û–°–õ–ï —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Real - —Å–æ–∑–¥–∞—ë–º Mock (—à–∞–≥ 7)
   ```

   **–ü—Ä–∞–≤–∏–ª–æ:** Mock –∏–º–∏—Ç–∏—Ä—É–µ—Ç –†–ï–ê–õ–¨–ù–û–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∞ –Ω–µ –ø—Ä–∏–¥—É–º–∞–Ω–Ω–æ–µ. –ï—Å–ª–∏ —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Real - –ù–ï–õ–¨–ó–Ø –¥–µ–ª–∞—Ç—å Mock.

3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è DoCC –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** ‚Äî —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–π Request/Response –º–æ–¥–µ–ª–∏:
   ```swift
   // –®–∞–≥ 1: SetAuthenticationPhoneNumberRequest ‚Üí AuthorizationStateUpdateResponse (waitCode)
   await mockClient.setMockResponse(
       for: SetAuthenticationPhoneNumberRequest.testWithPhone("+1234567890"),
       response: .success(AuthorizationStateUpdateResponse.waitCode)
   )
   ```

   –ò –≤ docstring —Ç–µ—Å—Ç–∞:
   ```swift
   /// **Related:**
   /// - Unit-—Ç–µ—Å—Ç—ã –º–æ–¥–µ–ª–µ–π: `SetAuthenticationPhoneNumberRequestTests`, `AuthorizationStateUpdateResponseTests`
   /// - TDLib docs: https://core.telegram.org/tdlib/classtd_1_1td__api_1_1set_authentication_phone_number.html
   ```

   **–ó–∞—á–µ–º:** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ DoCC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ unit-—Ç–µ—Å—Ç—ã.
   **–ü—Ä–∏–º–µ—Ä:** —Å–º. `Tests/TgClientComponentTests/TDLibAdapter/AuthenticationFlowTests.swift`

4. **–†–µ–∞–ª—å–Ω—ã–µ JSON –ø—Ä–∏–º–µ—Ä—ã** ‚Äî –±–µ—Ä—ë–º –∏–∑ TDLib docs, —Ö—Ä–∞–Ω–∏–º –≤ `Tests/Fixtures/TDLib/`

5. **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å** ‚Äî –µ—Å–ª–∏ –Ω–∞ —à–∞–≥–µ 6 –Ω–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —à–∞–≥—É 3-4

6. **–ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Task.sleep() –≤ async —Ç–µ—Å—Ç–∞—Ö (–∑–∞ —Ä–µ–¥–∫–∏–º–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏)**

   **–ü—Ä–æ–±–ª–µ–º–∞:** Task.sleep() –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É.

   **‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω:**
   ```swift
   await handler.start { update in /* ... */ }
   try await Task.sleep(for: .milliseconds(100))  // ‚ùå –ñ–¥—ë–º —á—Ç–æ update –ø—Ä–∏–¥—ë—Ç
   #expect(receivedCount > 0)  // ‚ùå –ú–æ–∂–µ—Ç fail –µ—Å–ª–∏ async –º–µ–¥–ª–µ–Ω–Ω–µ–µ
   ```

   **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
   ```swift
   // –ò—Å–ø–æ–ª—å–∑—É–π confirmation() –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
   await confirmation(expectedCount: 3) { confirm in
       await handler.start { update in
           confirm()  // ‚úÖ –Ø–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
       }
   }
   ```

   **–†–µ–¥–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∫–æ–≥–¥–∞ Task.sleep() –¥–æ–ø—É—Å—Ç–∏–º:**
   - Cancellation testing: –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ task.cancel()
   - –°–∏–º—É–ª—è—Ü–∏—è timeout –≤ withThrowingTaskGroup (—Å–º. TESTING.md:1245)
   - –ù–ï –¥–ª—è "–æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è" - –∏—Å–ø–æ–ª—å–∑—É–π confirmation()

7. **–ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å force unwrap –≤ —Ç–µ—Å—Ç–∞—Ö** (`!`, `as!`, `try!`)

   **–ü—Ä–æ–±–ª–µ–º–∞:** Force unwrap –∫—Ä–∞—à–∏—Ç —Ç–µ—Å—Ç —Å –Ω–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–π –æ—à–∏–±–∫–æ–π –≤–º–µ—Å—Ç–æ –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

   **‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:**
   ```swift
   let json = try JSONSerialization.jsonObject(with: data) as! [String: Any]
   let value = json["key"]!  // –ö—Ä–∞—à: "Unexpectedly found nil"
   ```

   **‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:**
   ```swift
   // –í–∞—Ä–∏–∞–Ω—Ç 1: –° #require (Swift Testing)
   let jsonObject = try JSONSerialization.jsonObject(with: data)
   let json = try #require(jsonObject as? [String: Any], "JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ª–æ–≤–∞—Ä—ë–º")
   let value = try #require(json["key"] as? String, "–ö–ª—é—á 'key' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π")

   // –í–∞—Ä–∏–∞–Ω—Ç 2: –° optional chaining + #expect
   let json = try JSONSerialization.jsonObject(with: data) as? [String: Any]
   #expect(json?["key"] as? String == "expected")
   ```

   **–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
   - ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: "Expected String, got Int"
   - ‚úÖ –¢–µ—Å—Ç fail gracefully —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
   - ‚ùå Force unwrap –¥–∞—ë—Ç stack trace –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

#### –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π fixtures

```
Tests/
‚îî‚îÄ‚îÄ Fixtures/
    ‚îî‚îÄ‚îÄ TDLib/
        ‚îú‚îÄ‚îÄ chats_response.json          # getChats –æ—Ç–≤–µ—Ç
        ‚îú‚îÄ‚îÄ chat_history_response.json   # getChatHistory –æ—Ç–≤–µ—Ç
        ‚îú‚îÄ‚îÄ authorization_state.json     # authorization updates
        ‚îî‚îÄ‚îÄ error_response.json          # TDLib –æ—à–∏–±–∫–∏
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- Unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–∏—Ö —Ñ–∞–π–ª–æ–≤
- Component-—Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤ MockTDLibClient
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∞–ª—å–Ω—ã–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º TDLib

---

## –ü—Ä–∞–≤–∏–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Request/Response/Error –º–æ–¥–µ–ª–∏ TDLib

**–ó–ê–ü–†–ï–©–ï–ù–û –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–¥–µ –º–æ–¥–µ–ª–µ–π:**
- ‚ùå –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ–ª—è–º –º–æ–¥–µ–ª–∏
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫–∏
- ‚ùå "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤", "–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ enum –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫–∏
- ‚ùå –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–µ—Å—Ç—å –≤ –∫–æ–¥–µ)

**–í—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ unit-—Ç–µ—Å—Ç–∞—Ö:**
- ‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é TDLib
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª—å–Ω–æ–≥–æ JSON (–≤ —Ç–µ—Å—Ç–∞—Ö –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ (–≤ docstring —Ç–µ—Å—Ç–∞)

**–í –∫–æ–¥–µ –º–æ–¥–µ–ª–∏ –¥–æ–ø—É—Å—Ç–∏–º–æ –¢–û–õ–¨–ö–û:**
- –û–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ß–¢–û —ç—Ç–æ –∑–∞ –º–æ–¥–µ–ª—å (–±–µ–∑ –¥–µ—Ç–∞–ª–µ–π)
- –°—Å—ã–ª–∫–∞ –Ω–∞ TDLib API docs

**–ü—Ä–∏–º–µ—Ä:**

```swift
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
/// –ó–∞–ø—Ä–æ—Å loadChats –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤ –≤ –∫–µ—à.
///
/// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: ChannelMessageSource, DigestOrchestrator
///
/// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
/// - chat_list: —Ç–∏–ø —Å–ø–∏—Å–∫–∞ (main –∏–ª–∏ archive)
/// - limit: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤
///
/// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: Ok
public struct LoadChatsRequest: TDLibRequest { ... }

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –º–∏–Ω–∏–º—É–º
/// –ó–∞–ø—Ä–æ—Å loadChats –¥–ª—è TDLib.
///
/// **TDLib API:** https://core.telegram.org/tdlib/docs/classtd_1_1td__api_1_1load_chats.html
public struct LoadChatsRequest: TDLibRequest { ... }
```

### Business logic helpers

**–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã** (—á—Ç–æ –ù–ï –∏–∑–º–µ–Ω–∏—Ç—Å—è):

```swift
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –æ–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ
extension TDLibErrorResponse {
    /// –í—Å–µ —á–∞—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (TDLib –≤–µ—Ä–Ω—É–ª 404).
    public var isAllChatsLoaded: Bool { code == 404 }
}

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
extension TDLibErrorResponse {
    /// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ChannelMessageSource –ø—Ä–∏ pagination loop.
    /// –ü—Ä–∏–º–µ—Ä: if error.isAllChatsLoaded { break }
    public var isAllChatsLoaded: Bool { code == 404 }
}
```

### Enum –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫–∏

**–ó–ê–ü–†–ï–©–ï–ù–û –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å:**

```swift
// ‚ùå –ù–ï –î–ï–õ–ê–ô –¢–ê–ö: —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ç—É—Ö–Ω–µ—Ç
/// –ö–æ–¥—ã –æ—à–∏–±–æ–∫ TDLib:
/// - 400: Validation errors
/// - 401: Authentication errors
/// - 404: Not found
/// - 429: Rate limit
/// - 500: Internal errors
```

**–ü–†–ê–í–ò–õ–¨–ù–û:**

```swift
// ‚úÖ –¢–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
/// –ö–æ–¥—ã –æ—à–∏–±–æ–∫ —Å–º. https://core.telegram.org/api/errors
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –º–æ–¥–µ–ª–µ–π

### Request –º–æ–¥–µ–ª–∏ (TDLibRequest)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `Sources/TDLibAdapter/TDLibCodableModels/Requests/`

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:**
- Conformance: `TDLibRequest, Sendable, Equatable`
- –°–≤–æ–π—Å—Ç–≤–æ `type: String` —Å TDLib –º–µ—Ç–æ–¥–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"loadChats"`)
- `CodingKeys` enum —Å –º–∞–ø–ø–∏–Ω–≥–æ–º snake_case ‚Üí camelCase (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- `init` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–∞ (–ø—É–±–ª–∏—á–Ω—ã–π, –ë–ï–ó #if DEBUG)

**–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–∏–ø—ã:**
- Enum-—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ChatList`) –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –û–î–ù–û–ú —Ñ–∞–π–ª–µ —Å Request
- –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ helper-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ChatListMain`)

**–ü—Ä–∏–º–µ—Ä:**
```swift
public enum ChatList: Sendable, Equatable {
    case main
    case archive
}

public struct LoadChatsRequest: TDLibRequest, Sendable, Equatable {
    public let type = "loadChats"
    public let chatList: ChatList
    public let limit: Int

    enum CodingKeys: String, CodingKey {
        case type = "@type"
        case chatList = "chat_list"
        case limit
    }

    public init(chatList: ChatList, limit: Int) {
        self.chatList = chatList
        self.limit = limit
    }
}
```

---

### Response –º–æ–¥–µ–ª–∏ (TDLibResponse)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `Sources/TDLibAdapter/TDLibCodableModels/Responses/`

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:**
- Conformance: `TDLibResponse, Sendable` + `Equatable` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤)
- –°–≤–æ–π—Å—Ç–≤–æ `type: String` —Å TDLib —Ç–∏–ø–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"chats"`)
- `CodingKeys` enum —Å –º–∞–ø–ø–∏–Ω–≥–æ–º snake_case ‚Üí camelCase (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- `init` –ø–æ–¥ `#if DEBUG` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –º–æ–∫–∞—Ö)

**–ü—Ä–∞–≤–∏–ª–æ –¥–ª—è init:**
- **–° #if DEBUG** ‚Äî –µ—Å–ª–∏ init –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ —Ç–µ—Å—Ç–∞—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è mock-–¥–∞–Ω–Ω—ã—Ö
  - –ü—Ä–∏–º–µ—Ä—ã: `ChatsResponse`, `AuthorizationStateUpdateResponse`, `TDLibErrorResponse`
  - –≠—Ç–æ –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ë—Ä—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤ production –∫–æ–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Decodable
- **–ë–ï–ó #if DEBUG** ‚Äî –µ—Å–ª–∏ init –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ production –∫–æ–¥–µ
  - –ü—Ä–∏–º–µ—Ä: `UserResponse` ‚Äî –∏–º–µ–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ, –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ

**–ü—Ä–∏–º–µ—Ä —Å #if DEBUG:**
```swift
public struct ChatsResponse: TDLibResponse, Sendable, Equatable {
    public let type = "chats"
    public let chatIds: [Int64]

    enum CodingKeys: String, CodingKey {
        case chatIds = "chat_ids"
    }

    #if DEBUG
    public init(chatIds: [Int64]) {
        self.chatIds = chatIds
    }
    #endif
}
```

**–ü—Ä–∏–º–µ—Ä –ë–ï–ó #if DEBUG:**
```swift
public struct UserResponse: TDLibResponse, Sendable {
    public let type = "user"
    public let id: Int64
    public let firstName: String
    public let lastName: String
    public let username: String?

    // Init –¥–æ—Å—Ç—É–ø–µ–Ω –≤ production (—Å–ª–æ–∂–Ω–∞—è –º–æ–¥–µ–ª—å —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏)
    public init(id: Int64, firstName: String, lastName: String, username: String? = nil) {
        self.id = id
        self.firstName = firstName
        self.lastName = lastName
        self.username = username
    }
}
```

---

### Error –º–æ–¥–µ–ª–∏ (TDLibErrorResponse)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `Sources/TDLibAdapter/TDLibCodableModels/Responses/`

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:**
- Conformance: `TDLibResponse, Error, Sendable`
- –°–≤–æ–π—Å—Ç–≤–æ `type = "error"`
- –°–≤–æ–π—Å—Ç–≤–∞ `code: Int`, `message: String`
- `init` –ø–æ–¥ `#if DEBUG` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –º–æ–∫–∞—Ö)

**–ü—Ä–∏–º–µ—Ä:**
```swift
public struct TDLibErrorResponse: TDLibResponse, Error, Sendable {
    public let type = "error"
    public let code: Int
    public let message: String

    #if DEBUG
    public init(code: Int, message: String) {
        self.code = code
        self.message = message
    }
    #endif
}
```

---

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **–î–µ—Ä–∂–∏—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã –≤–º–µ—Å—Ç–µ** ‚Äî enum ChatList –≤ —Ñ–∞–π–ª–µ GetChatsRequest.swift
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ #if DEBUG –¥–ª—è mock-only init** ‚Äî –µ—Å–ª–∏ init –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
3. **–ü—É–±–ª–∏—á–Ω—ã–µ init –¥–ª—è production** ‚Äî –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ (–Ω–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ JSON)
4. **–í—Å–µ–≥–¥–∞ Sendable** ‚Äî –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
5. **Equatable –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é** ‚Äî –¥–ª—è —Ç–µ—Å—Ç–æ–≤ —Å #expect(model1 == model2)
6. **CodingKeys –¥–ª—è snake_case** ‚Äî TDLib –∏—Å–ø–æ–ª—å–∑—É–µ—Ç snake_case, Swift ‚Äî camelCase

---

### Outside-In vs Inside-Out: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ

**–ó–ê–ë–õ–£–ñ–î–ï–ù–ò–ï:** Outside-In = —Ç–æ–ª—å–∫–æ E2E ‚Üí Component ‚Üí Unit

**–ü–†–ê–í–î–ê:** Outside-In = –Ω–∞—á–∏–Ω–∞–µ–º —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π consumer –Ω–∞ –õ–Æ–ë–û–ú —É—Ä–æ–≤–Ω–µ

#### Outside-In –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ–≥–¥–∞:

- –ï—Å—Ç—å **—è–≤–Ω—ã–π consumer** (–≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥)
- –ú—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ–º **–ø–æ–≤–µ–¥–µ–Ω–∏–µ** –ø–æ–¥ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è consumer
- –ú—ã **–Ω–µ –∑–Ω–∞–µ–º —Ç–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–æ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚úÖ **E2E ‚Üí TDLibClient.loadChats()** (consumer = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–ø–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ")
- ‚úÖ **Component ‚Üí UpdatesHandler** (consumer = ChannelMessageSource –Ω—É–∂–µ–Ω —Ñ–æ–Ω–æ–≤—ã–π updates)
- ‚úÖ **Component ‚Üí MessageFetcher** (consumer = ChannelMessageSource –Ω—É–∂–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è consumer
2. ‚úÖ Component Test (RED) - –æ–ø–∏—Å—ã–≤–∞–µ—à—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∫–∞–∫ –±—É–¥—Ç–æ –º–µ—Ç–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
3. ‚úÖ Protocol/Models/Implementation (GREEN)

**–ö–ª—é—á–µ–≤–æ–µ:** Outside-In —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **–∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏** (E2E, Component, Unit)!

---

#### Inside-Out –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ–≥–¥–∞:

- **–ù–ï–¢ —è–≤–Ω–æ–≥–æ consumer** –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–µ–∫—Ç–∏—Ä—É–µ–º **–º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö** (data structures)
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç –æ—á–µ–≤–∏–¥–µ–Ω –∏–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–ü—Ä–∏–º–µ—Ä—ã:**
- ‚úÖ **SourceMessage** (–ø—Ä–æ—Å—Ç–æ –º–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö)
- ‚úÖ **DigestSummary** (–ø—Ä–æ—Å—Ç–æ –º–æ–¥–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
- ‚úÖ **ChannelInfo** (–ø—Ä–æ—Å—Ç–æ –º–æ–¥–µ–ª—å –¥–ª—è –∫—ç—à–∞)

**–ü—Ä–æ—Ü–µ—Å—Å:**

```
1. Unit Tests –¥–ª—è –º–æ–¥–µ–ª–µ–π (RED)
   ‚îî‚îÄ> –¢–µ—Å—Ç—ã –Ω–∞ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (SourceMessage, DigestSummary)

2. Models implementation (GREEN)
   ‚îî‚îÄ> –°–æ–∑–¥–∞—ë–º –º–æ–¥–µ–ª–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

3. Unit Tests –¥–ª—è –ª–æ–≥–∏–∫–∏ (RED)
   ‚îî‚îÄ> –¢–µ—Å—Ç—ã –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π)

4. Business logic (GREEN)
   ‚îî‚îÄ> –†–µ–∞–ª–∏–∑–∞—Ü–∏—è core –ª–æ–≥–∏–∫–∏

5. Protocol definition
   ‚îî‚îÄ> –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç (MessageSourceProtocol)

6. Component Tests (RED)
   ‚îî‚îÄ> –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DigestOrchestrator –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MessageSource)

7. Implementation (GREEN)
   ‚îî‚îÄ> –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏

8. E2E validation (manual)
   ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ–≥–æ —Ñ–ª–æ—É
```

#### –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –≤ –ø—Ä–æ–µ–∫—Ç–µ

**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:** –≤ –æ–¥–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º –æ–±–∞ –ø–æ–¥—Ö–æ–¥–∞.

```
DigestOrchestrator (Chicago ‚Äî –Ω–∞—à–∞ –ª–æ–≥–∏–∫–∞)
    ‚îú‚îÄ> ChannelMessageSource (Chicago ‚Äî –Ω–∞—à –¥–∏–∑–∞–π–Ω)
    ‚îÇ   ‚îî‚îÄ> TDLibClient.loadChats() (London ‚Äî TDLib adapter)
    ‚îú‚îÄ> SummaryGenerator (Chicago ‚Äî –Ω–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
    ‚îÇ   ‚îî‚îÄ> OpenAIClient (London ‚Äî OpenAI adapter)
    ‚îî‚îÄ> BotNotifier (Chicago ‚Äî –Ω–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
        ‚îî‚îÄ> TelegramBotClient (London ‚Äî Telegram adapter)
```

**–ü—Ä–∞–≤–∏–ª–æ:**
- **–ì—Ä–∞–Ω–∏—Ü—ã —Å–∏—Å—Ç–µ–º—ã (adapters –∫ –≤–Ω–µ—à–Ω–∏–º API):** London TDD (Outside-In)
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ (core, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã):** Chicago TDD (Inside-Out)
- **–ü–µ—Ä–µ—Ö–æ–¥:** –≥–æ—Ç–æ–≤—ã–π adapter —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é –¥–ª—è core –ª–æ–≥–∏–∫–∏

**–ü—Ä–∏–º–µ—Ä:**
1. –°–Ω–∞—á–∞–ª–∞: `TDLibClient.loadChats()` ‚Äî **London** (–∞–¥–∞–ø—Ç–∏—Ä—É–µ–º—Å—è –∫ TDLib)
2. –ü–æ—Ç–æ–º: `ChannelMessageSource.fetchUnreadMessages()` ‚Äî **Chicago** (–Ω–∞—à –¥–∏–∑–∞–π–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–æ—Ç–æ–≤—ã–π TDLibClient —á–µ—Ä–µ–∑ –º–æ–∫–∏)
3. –ù–∞–∫–æ–Ω–µ—Ü: `DigestOrchestrator.run()` ‚Äî **Chicago** (–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–æ—Ç–æ–≤—ã–µ MessageSource/SummaryGenerator)

---

### Senior Architect: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∏—Å–∫–∏

**–ö–†–ò–¢–ò–ß–ù–û:** –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Component/Unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –Ω–æ–≤–æ–π —Ñ–∏—á–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–æ–ª—å **Senior Swift Architect**.

**–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:** –°–º. [PROMPTS.md](PROMPTS.md) ‚Üí Senior Swift Architect ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤

**–ö—Ä–∞—Ç–∫–æ:**
1. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç? rate limits? –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã?)
2. –ü–∞–º—è—Ç—å/–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö? batch processing? –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?)
3. –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å (timeout? –ø–æ—Ç–µ—Ä—è —Å–µ—Ç–∏? —á–∞—Å—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏?)
4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏? —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏? –º–µ—Ç—Ä–∏–∫–∏?)

**–ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –ü—Ä–æ–µ–∫—Ç–∏—Ä—É–π –¥–ª—è –±—É–¥—É—â–µ–≥–æ, —Ä–µ–∞–ª–∏–∑—É–π –¥–ª—è MVP

---

### RED ‚Üí GREEN ‚Üí REFACTOR

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç—ã

**–ü—Ä–∏–Ω—Ü–∏–ø:** –¢–µ—Å—Ç—ã ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –æ —Ç–æ–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω–µ—à–Ω–∏–µ API.

#### –ì–¥–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ

**‚úÖ –í —Ç–µ—Å—Ç–∞—Ö:**
- –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤–Ω–µ—à–Ω–∏—Ö API (TDLib, OpenAI, Telegram Bot API)
- –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª—å–Ω—ã—Ö JSON –æ—Ç–≤–µ—Ç–æ–≤
- –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
- Edge cases –≤–Ω–µ—à–Ω–∏—Ö API

**‚úÖ –í –∫–æ–¥–µ:**
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π (–ø—Ä–æ—Ç–æ–∫–æ–ª—ã, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã)
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –Ω–∞—à–∏—Ö –º–æ–¥—É–ª–µ–π (—á—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç)
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–ø–æ—á–µ–º—É –ø—Ä–∏–Ω—è—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

#### –ü—Ä–∏–º–µ—Ä

```swift
// Tests/TDLibAdapterTests/TDLibCodableModels/Responses/ChatTests.swift

/// –¢–µ—Å—Ç—ã –¥–ª—è –º–æ–¥–µ–ª–∏ Chat
///
/// **TDLib API:** https://core.telegram.org/tdlib/.claude/classtd_1_1td__api_1_1chat.html
///
/// TDLib –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞:
/// - `unread_count` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
/// - `last_read_inbox_message_id` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ viewMessages
/// - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –≤ snake_case —Ñ–æ—Ä–º–∞—Ç–µ
@Suite("Chat model decoding")
struct ChatTests {
    @Test("Decode channel with unread messages")
    func decodeChannelWithUnread() throws {
        // –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ TDLib
        let json = """
        {
            "id": 123456789,
            "type": { "@type": "chatTypeChannel" },
            "title": "Tech News",
            "unread_count": 5,
            "last_read_inbox_message_id": 100
        }
        """

        let chat = try JSONDecoder().decode(Chat.self, from: json)

        #expect(chat.unreadCount == 5)  // snake_case ‚Üí camelCase
        #expect(chat.lastReadInboxMessageId == 100)
    }
}

// Sources/TDLibAdapter/TDLibCodableModels/Responses/Chat.swift

/// –ú–æ–¥–µ–ª—å —á–∞—Ç–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
///
/// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `ChannelMessageSource` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
/// –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
struct Chat: Codable, Sendable, Equatable {
    let id: Int64
    let unreadCount: Int
    let lastReadInboxMessageId: Int64

    enum CodingKeys: String, CodingKey {
        case id
        case unreadCount = "unread_count"
        case lastReadInboxMessageId = "last_read_inbox_message_id"
    }
}
```

#### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ

1. **–¢–µ—Å—Ç—ã —á–∏—Ç–∞—é—Ç—Å—è —á–∞—â–µ** ‚Äî –∫–æ–≥–¥–∞ —Ä–∞–∑–±–∏—Ä–∞–µ—à—å—Å—è –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π API
2. **–¢–µ—Å—Ç—ã = executable documentation** ‚Äî –ø—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª—å–Ω—ã—Ö JSON —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
3. **–ö–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è —á–∏—Å—Ç—ã–º** ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–µ
4. **–õ–µ–≥—á–µ –º–µ–Ω—è—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é** ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö, –∫–æ–¥ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ

| –ú–æ–¥—É–ª—å | –í–Ω–µ—à–Ω–∏–π API | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –∫–æ–¥–µ |
|--------|-------------|----------------------|---------------------|
| TDLibAdapter | TDLib C API | –ü—Ä–∏–º–µ—Ä—ã JSON –æ—Ç–≤–µ—Ç–æ–≤ | `TDLibClientProtocol` |
| OpenAISummaryGenerator | OpenAI API | HTTP responses | `SummaryGeneratorProtocol` |
| TelegramBotNotifier | Telegram Bot API | API examples | `BotNotifierProtocol` |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

**–ö–†–ò–¢–ò–ß–ù–û:** Async —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –†–ï–ê–õ–¨–ù–û–ï –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∞ –Ω–µ —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏.

**‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã:**
- `Task.sleep()` ‚Äî –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É
- `Thread.sleep()` ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫, –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è async/await
- –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ timeouts –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã

**‚úÖ Best practices:**
- –ò—Å–ø–æ–ª—å–∑—É–π `confirmation()` –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —Å–æ–±—ã—Ç–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π `withMainSerialExecutor` –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–π actor isolation –∏ Sendable conformance
- –¢–µ—Å—Ç–∏—Ä—É–π concurrent behavior (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)

### –ü–∞—Ç—Ç–µ—Ä–Ω 1: Swift Testing `confirmation()`

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AsyncSequence/AsyncStream, –ø–æ–¥—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–±—ã—Ç–∏–π.

**–ü—Ä–∏–º–µ—Ä: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AsyncStream updates**

```swift
import Testing

@Suite("UpdatesHandler: Async updates processing")
struct UpdatesHandlerTests {
    @Test("Receives multiple updates from stream")
    func receivesMultipleUpdates() async throws {
        // Given: Mock TDLib client —Å AsyncStream updates
        let mockClient = MockTDLibClient()
        let updates: [Update] = [
            .updateChatReadInbox(chatId: 1, unreadCount: 5),
            .updateChatReadInbox(chatId: 2, unreadCount: 3),
            .updateChatReadInbox(chatId: 3, unreadCount: 10)
        ]
        await mockClient.setUpdatesStream(updates)

        let handler = UpdatesHandler(tdlib: mockClient)
        var receivedUpdates: [Update] = []

        // When: Start handler and collect updates
        await confirmation(expectedCount: 3) { confirm in
            await handler.start { update in
                receivedUpdates.append(update)
                confirm()  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ
            }
        }

        // Then: –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ updates –ø–æ–ª—É—á–µ–Ω—ã
        #expect(receivedUpdates.count == 3)
        #expect(receivedUpdates[0].chatId == 1)
        #expect(receivedUpdates[2].unreadCount == 10)
    }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ Fail –µ—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–æ –º–µ–Ω—å—à–µ/–±–æ–ª—å—à–µ –æ–∂–∏–¥–∞–µ–º—ã—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ Timeout –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–Ω–µ –Ω—É–∂–µ–Ω Task.sleep)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://developer.apple.com/documentation/testing/confirmation

### –ü–∞—Ç—Ç–µ—Ä–Ω 2: Point-Free `withMainSerialExecutor`

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ async –∫–æ–¥–∞ –±–µ–∑ race conditions.

**–ü—Ä–æ–±–ª–µ–º–∞:** Async –∫–æ–¥ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ ‚Üí flaky tests.

**–†–µ—à–µ–Ω–∏–µ:** –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ main executor.

**–ü—Ä–∏–º–µ—Ä:**

```swift
import PointFreeTestSupport  // https://github.com/pointfreeco/swift-concurrency-extras

@Test("Handler processes updates sequentially")
func processesUpdatesSequentially() async throws {
    await withMainSerialExecutor {
        let handler = UpdatesHandler(tdlib: mockClient)
        var order: [Int] = []

        await handler.start { update in
            order.append(update.chatId)
        }

        // –í –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º executor –ø–æ—Ä—è–¥–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω
        #expect(order == [1, 2, 3])
    }
}
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è async –æ–ø–µ—Ä–∞—Ü–∏–π
- –¢–µ—Å—Ç—ã —Å race conditions
- –ù—É–∂–Ω–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å (–Ω–µ flaky tests)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://www.pointfree.co/blog/posts/110-reliably-testing-async-code-in-swift

### –ü–∞—Ç—Ç–µ—Ä–Ω 3: Actor isolation testing

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ thread-safety –∏ Sendable conformance.

**–ü—Ä–∏–º–µ—Ä:**

```swift
@Test("UpdatesHandler is thread-safe (actor isolation)")
func actorIsolation() async throws {
    let handler = UpdatesHandler(tdlib: mockClient)

    // Concurrent –≤—ã–∑–æ–≤—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ data races
    await withTaskGroup(of: Void.self) { group in
        for i in 1...10 {
            group.addTask {
                await handler.start { update in
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
                }
            }
        }
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å data race ‚Üí Swift 6 compilation error
    // –ï—Å–ª–∏ actor isolation –Ω–∞—Ä—É—à–µ–Ω–∞ ‚Üí runtime warning
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ Sendable:**
```swift
@Test("Update is Sendable (can cross actor boundaries)")
func updateIsSendable() {
    let update = Update.updateChatReadInbox(chatId: 1, unreadCount: 5)

    Task {
        // Update –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—É actor (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Sendable)
        await someActor.process(update)
    }

    // –ï—Å–ª–∏ Update –Ω–µ Sendable ‚Üí compilation error
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω 4: Cancellation testing

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ graceful shutdown –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ Task.

**–ü—Ä–∏–º–µ—Ä:**

```swift
@Test("UpdatesHandler stops gracefully on cancellation")
func stopsOnCancellation() async throws {
    let handler = UpdatesHandler(tdlib: mockClient)

    let task = Task {
        await handler.start { update in
            // Processing...
        }
    }

    // Cancel –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
    try await Task.sleep(for: .milliseconds(10))
    task.cancel()

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ handler –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
    await confirmation { confirm in
        try await Task.sleep(for: .milliseconds(50))
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤—ã–µ updates –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
        confirm()
    }
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω 5: Timeout testing

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± (–±–µ–∑ Task.sleep):**

```swift
@Test("Operation completes within timeout")
func operationTimeout() async throws {
    let start = ContinuousClock.now

    try await withThrowingTaskGroup(of: Void.self) { group in
        group.addTask {
            // –û–ø–µ—Ä–∞—Ü–∏—è –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å
            try await handler.longRunningOperation()
        }

        group.addTask {
            // –¢–∞–π–º–∞—É—Ç task
            try await Task.sleep(for: .seconds(5))
            throw TimeoutError()
        }

        // –ü–µ—Ä–≤–∞—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞
        try await group.next()
        group.cancelAll()
    }

    let duration = start.duration(to: .now)
    #expect(duration < .seconds(5), "Operation –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –¥–æ timeout")
}
```

### –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∫–∞–∫ –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å

#### ‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω 1: Task.sleep() –¥–ª—è "–æ–∂–∏–¥–∞–Ω–∏—è" async –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ü–ª–æ—Ö–æ:**
```swift
@Test("Wait for updates")
func waitForUpdates() async throws {
    await handler.start { update in
        // Process...
    }

    try await Task.sleep(for: .milliseconds(100))  // ‚ùå –ß—Ç–æ –º—ã –æ–∂–∏–¥–∞–µ–º?
    #expect(receivedCount > 0)  // ‚ùå –ú–æ–∂–µ—Ç fail –µ—Å–ª–∏ async –º–µ–¥–ª–µ–Ω–Ω–µ–µ
}
```

**–•–æ—Ä–æ—à–æ:**
```swift
@Test("Wait for updates")
func waitForUpdates() async throws {
    await confirmation(expectedCount: 1) { confirm in
        await handler.start { update in
            confirm()  // ‚úÖ –Ø–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è
        }
    }
}
```

#### ‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω 2: Shared mutable state –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–ü–ª–æ—Ö–æ:**
```swift
@Test("Concurrent updates")
func concurrentUpdates() async throws {
    var count = 0  // ‚ùå Data race!

    await withTaskGroup(of: Void.self) { group in
        for _ in 1...10 {
            group.addTask {
                count += 1  // ‚ùå Concurrent modification
            }
        }
    }
}
```

**–•–æ—Ä–æ—à–æ:**
```swift
@Test("Concurrent updates")
func concurrentUpdates() async throws {
    actor Counter {
        var count = 0
        func increment() { count += 1 }
    }

    let counter = Counter()

    await withTaskGroup(of: Void.self) { group in
        for _ in 1...10 {
            group.addTask {
                await counter.increment()  // ‚úÖ Thread-safe
            }
        }
    }
}
```

#### ‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–∫–∞–∫) –≤–º–µ—Å—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è (—á—Ç–æ)

**–ü–ª–æ—Ö–æ:**
```swift
@Test("Handler uses specific Task priority")
func taskPriority() async throws {
    // ‚ùå –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    #expect(handler.task?.priority == .medium)
}
```

**–•–æ—Ä–æ—à–æ:**
```swift
@Test("Handler processes updates in order")
func processesInOrder() async throws {
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–±–ª—é–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
    var order: [Int] = []
    await handler.start { update in
        order.append(update.id)
    }
    #expect(order == [1, 2, 3])
}
```

### –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

**–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [Swift Testing Confirmation API](https://developer.apple.com/documentation/testing/confirmation)
- [Swift Concurrency Best Practices](https://developer.apple.com/documentation/swift/concurrency)

**Community resources:**
- [SwiftLee: Unit testing async/await](https://www.avanderlee.com/concurrency/unit-testing-async-await/)
- [Swift by Sundell: Testing async code](https://www.swiftbysundell.com/articles/unit-testing-code-that-uses-async-await/)
- [Hacking with Swift: Testing AsyncSequence](https://www.hackingwithswift.com/swift/5.5/test-async-sequences)
- [Point-Free: Reliably testing async code](https://www.pointfree.co/blog/posts/110-reliably-testing-async-code-in-swift)

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- [swift-concurrency-extras](https://github.com/pointfreeco/swift-concurrency-extras) ‚Äî —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | Async –ø–∞—Ç—Ç–µ—Ä–Ω | Testing —Å—Ç—Ä–∞—Ç–µ–≥–∏—è |
|-----------|---------------|-------------------|
| UpdatesHandler | AsyncStream<Update> | confirmation() –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ events |
| TDLibClient | async –º–µ—Ç–æ–¥—ã | Actor isolation, timeout testing |
| ChannelMessageSource | async/await | Concurrent calls testing |
| DigestOrchestrator | Task coordination | Cancellation, graceful shutdown |

**–°–º. —Ç–∞–∫–∂–µ:** [PROMPTS.md](PROMPTS.md) ‚Üí Senior Testing Architect ‚Üí Async testing best practices

---

## Test Helpers

### Encodable Extension –¥–ª—è Round-Trip —Ç–µ—Å—Ç–æ–≤

–î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è extension `Encodable.toTDLibData()`.

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `Tests/TestHelpers/EncodableExtensions.swift`

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```swift
import TestHelpers

// –°–æ–∑–¥–∞—ë–º –º–æ–¥–µ–ª—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
let original = UserResponse(userId: 123, firstName: "Test")

// Encode —á–µ—Ä–µ–∑ TDLib encoder (snake_case)
let data = try original.toTDLibData()

// Decode –æ–±—Ä–∞—Ç–Ω–æ
let decoded = try JSONDecoder.tdlib().decode(UserResponse.self, from: data)

// –ü—Ä–æ–≤–µ—Ä—è–µ–º round-trip
#expect(decoded.userId == 123)
#expect(decoded.firstName == "Test")
```

#### –ü–æ—á–µ–º—É `TDLibResponse: Codable`

Response –º–æ–¥–µ–ª–∏ conform—è—Ç –∫ `Codable` (–≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ `Decodable`) –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ round-trip —Ç–µ—Å—Ç–æ–≤.
–í production –∫–æ–¥–µ encode –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –°–º. `TDLibResponse.swift`

## Coverage Requirements

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π coverage –¥–ª—è PR: **TODO**

## –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- Swift Testing framework (Swift 6)
- CI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- Coverage –æ—Ç—á—ë—Ç—ã

---

**–°–º. —Ç–∞–∫–∂–µ:**
- [TASKS.md](TASKS.md) - –∑–∞–¥–∞—á–∞ 5.1
- [DEVELOPMENT.md](DEVELOPMENT.md) - –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
