# –†–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–∞ v0.4.0 ‚Äî –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

**–ü–µ—Ä–∏–æ–¥ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ v0.4.0:** TBD
**–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** TBD

---

## üîÑ –ü–†–û–ú–ü–¢ –î–õ–Ø –†–ï–ì–£–õ–Ø–†–ù–û–ì–û –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø (—Ä–∞–∑ –≤ 1-3 –¥–Ω—è)

**–°–∫–æ–ø–∏—Ä—É–π –∏ –∑–∞–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç –≤ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏:**

```
–î–∞—Ç–∞: ____

–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ v0.4.0 (—Ä–∞–∑ –≤ 1-3 –¥–Ω—è).

**–†–æ–ª—å:** AI-Assisted Developer

**–ß–∏—Ç–∞—Ç—å:**
1. .claude/archived/retro-v0.4.0-questions.md (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
2. .claude/archived/retro-v0.3.0-results.md (–∫–æ–Ω—Ç–µ–∫—Å—Ç —Ü–µ–ª–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫)

**–ó–∞–¥–∞—á–∞:**
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∏ –º–µ—Ç—Ä–∏–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1-3 –¥–Ω—è:

1. **Research-First –¥–ª—è External APIs:**
   - –ë—ã–ª–∏ –ª–∏ –Ω–æ–≤—ã–µ External APIs?
   - Research-First –ø—Ä–∏–º–µ–Ω—ë–Ω? (WebFetch + live —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã + failing test)

2. **Mock —Ç–æ–ª—å–∫–æ boundaries:**
   - –ë—ã–ª–∏ –ª–∏ –Ω–æ–≤—ã–µ Mock*.swift?
   - –ü—Ä–∞–≤–∏–ª–æ —Å–æ–±–ª—é–¥–µ–Ω–æ? (boundary: FFI/network/filesystem)

3. **Code Review –≤—á–µ—Ä–∞—à–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤:**
   - –ü—Ä–æ–≤–æ–¥–∏–ª—Å—è –ª–∏ review? (–ø–µ—Ä–≤–∞—è —Å–µ—Å—Å–∏—è –¥–Ω—è + –∫–æ–º–º–∏—Ç—ã –∑–∞ –≤—á–µ—Ä–∞)
   - –ü—Ä–æ–±–ª–µ–º—ã –Ω–∞–π–¥–µ–Ω—ã? (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ/–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ/–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

4. **–î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤:**
   - –ë—ã–ª–∏ –ª–∏ –Ω–æ–≤—ã–µ —Ç–∏–ø—ã (struct/enum/class)?
   - Grep –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º?

5. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–µ–±–∞–≥–∞:**
   - –ë—ã–ª–∏ –ª–∏ –±–∞–≥-—Ñ–∏–∫—Å—ã?
   - –ü–æ–ø—ã—Ç–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –±–µ–∑ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è?

6. **Concurrency –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
   - –ë—ã–ª–∏ –ª–∏ –Ω–æ–≤—ã–µ concurrency –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã?
   - Architecture-First —á–µ–∫–ª–∏—Å—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω?
   - TSan –∑–∞–ø—É—â–µ–Ω?

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:**
Append –ª–æ–≥ –≤ —Å–µ–∫—Ü–∏—é "–õ–æ–≥–∏ –º–µ—Ç—Ä–∏–∫" —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ (retro-v0.4.0-questions.md).

–§–æ—Ä–º–∞—Ç:
---
## –õ–æ–≥ –º–µ—Ç—Ä–∏–∫ ‚Äî [–î–∞—Ç–∞]

**Research-First:** X/Y External APIs (100% = —Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
**Mock —Ç–æ–ª—å–∫–æ boundaries:** —Å–æ–±–ª—é–¥–µ–Ω–æ/–Ω–∞—Ä—É—à–µ–Ω–æ
**Code Review:** –ø—Ä–æ–≤–µ–¥—ë–Ω/–ø—Ä–æ–ø—É—â–µ–Ω
**–î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤:** 0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
**–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** 0 –ø–æ–ø—ã—Ç–æ–∫ (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
**Concurrency:** Architecture-First –ø—Ä–∏–º–µ–Ω—ë–Ω (–î–ê/–ù–ï–¢), TSan GREEN/warnings

**–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã:**
- [–æ–ø–∏—Å–∞–Ω–∏–µ –µ—Å–ª–∏ –±—ã–ª–∏]

**–ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª:**
- [–æ–ø–∏—Å–∞–Ω–∏–µ –µ—Å–ª–∏ –±—ã–ª–∏ + root cause]

**–í—ã–≤–æ–¥—ã:**
- –†–∞–±–æ—Ç–∞–µ—Ç: [—á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç]
- –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: [—á—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç]
---

–î–∞–≤–∞–π –ø—Ä–æ–≤–µ—Ä–∏–º –º–µ—Ç—Ä–∏–∫–∏!
```

---

## üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç: –¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ v0.4.0

**–ò–∑ —Ä–µ—Ç—Ä–æ v0.3.0 ([retro-v0.3.0-results.md](retro-v0.3.0-results.md)):**

### –ü—Ä–æ–±–ª–µ–º—ã v0.3.0:
- **Research-First:** 25% (1/4 External APIs) üî¥
- **Mock —Ç–æ–ª—å–∫–æ boundaries:** 0% —Å–æ–±–ª—é–¥–µ–Ω–∏–π (1/1 –Ω–∞—Ä—É—à–µ–Ω–∏–µ) üî¥
- **–î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤:** 16% (1/6 –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤) üî¥
- **–î–æ–ª—è –±–∞–≥—Ñ–∏–∫—Å–æ–≤:** 40% –≤—Ä–µ–º–µ–Ω–∏ üî¥

### –¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ v0.4.0:
1. **Research-First:** 100% External APIs (–±—ã–ª–æ 25%)
2. **Mock —Ç–æ–ª—å–∫–æ boundaries:** 100% —Å–æ–±–ª—é–¥–µ–Ω–∏–π (–±—ã–ª–æ 0%)
3. **–î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤:** 0% (–±—ã–ª–æ 16%)
4. **–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–µ–±–∞–≥–∞:** 0 –ø–æ–ø—ã—Ç–æ–∫ (–±—ã–ª–æ 1)
5. **Code Review:** 100% –¥–Ω–µ–π —Å –∫–æ–º–º–∏—Ç–∞–º–∏ (–Ω–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞)
6. **TSan —É—á–µ–Ω–∏—è:** 3/3 –æ—à–∏–±–æ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã (–Ω–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞)
7. **Concurrency –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** 0 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–≤ –∏–∑-–∑–∞ concurrency –æ—à–∏–±–æ–∫ (–Ω–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞)

---

## üéØ –ì–∏–ø–æ—Ç–µ–∑—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ v0.4.0

### –ì–∏–ø–æ—Ç–µ–∑–∞ 1.3: "Overnight Pause" (Code Review)
**–¶–µ–ª—å:** –û–±–Ω–∞—Ä—É–∂–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –î–û production —á–µ—Ä–µ–∑ —Å–≤–µ–∂–∏–π –≤–∑–≥–ª—è–¥

**–ú–µ—Ç—Ä–∏–∫–∞:** % –¥–Ω–µ–π —Å –∫–æ–º–º–∏—Ç–∞–º–∏ ‚Üí code review –≤ –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –µ—Å–ª–∏:**
- Code review –æ–±–Ω–∞—Ä—É–∂–∏–ª –∫—Ä–∏—Ç–∏—á–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –î–û production
- –ò–õ–ò 5+ reviews –ø—Ä–æ—à–ª–∏ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –Ω–∞—Ö–æ–¥–æ–∫ (–ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

### –ì–∏–ø–æ—Ç–µ–∑–∞ "Concurrency-Aware Architecture" (1.1 + 1.4 + 1.5)
**–¶–µ–ª—å:** –û–±–Ω–∞—Ä—É–∂–∏—Ç—å concurrency –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ —ç—Ç–∞–ø–µ design, –Ω–µ –ø–æ—Å–ª–µ 50+ –∫–æ–º–º–∏—Ç–æ–≤

**–ú–µ—Ç—Ä–∏–∫–∞:**
- Architecture-First –ø—Ä–∏–º–µ–Ω—ë–Ω –î–û —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—á–µ–∫–ª–∏—Å—Ç 7 –±–ª–æ–∫–æ–≤)
- TSan –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è concurrency –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- 0 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–≤ –∏–∑-–∑–∞ concurrency –æ—à–∏–±–æ–∫

---

## üìù –õ–æ–≥–∏ –º–µ—Ç—Ä–∏–∫ (append —Å—é–¥–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)

<!-- –õ–æ–≥–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `echo "---" >> —Ñ–∞–π–ª` –∏–ª–∏ Edit append -->


---

## üî¥ –ò–Ω—Ü–∏–¥–µ–Ω—Ç ‚Äî 2025-12-11 (–Ω–∞—á–∞–ª–æ v0.4.0)

**–¢–∏–ø:** –ù–∞—Ä—É—à–µ–Ω–∏–µ TDD –ø—Ä–æ—Ü–µ—Å—Å–∞ (–ø—Ä–æ–ø—É—â–µ–Ω User Story –¥–æ–∫—É–º–µ–Ω—Ç)

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
1. –ù–∞—á–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é v0.4.0 (MarkAsReadService) —Å—Ä–∞–∑—É —Å DocC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –∫–æ–¥–µ
2. –ü—Ä–æ–ø—É—â–µ–Ω —à–∞–≥: —Å–æ–∑–¥–∞–Ω–∏–µ E2E User Story –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∫–∞–∫ FetchUnreadMessages.md)
3. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ç–∞–∫–∂–µ: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç User Story –¥–ª—è v0.3.0 (GenerateSummary)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—É TDD (User Story ‚Üí E2E ‚Üí Component ‚Üí Unit)
- –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Å–∞–π—Ç–µ (v0.2.0 –≤–º–µ—Å—Ç–æ v0.3.0)
- –†–∏—Å–∫: –Ω–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–µ–∑ —á—ë—Ç–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è user value

**Root Cause:**
- –ù–µ—Ç —á–µ–∫–ª–∏—Å—Ç–∞ "–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏"
- TDD workflow –≤ TESTING.md —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ç–µ—Å—Ç–∞—Ö, –Ω–æ –ù–ï —É–ø–æ–º–∏–Ω–∞–µ—Ç User Story –¥–æ–∫—É–º–µ–Ω—Ç

**–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
1. ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ User Story:
   - GenerateSummary.md (v0.3.0)
   - MarkAsRead.md (v0.4.0)
2. ‚úÖ –£–±—Ä–∞—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (TgClient.md)
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –≤ TESTING.md —Å–µ–∫—Ü–∏—é "Workflow –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏" (—á–µ–∫–ª–∏—Å—Ç)
4. ‚è≥ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å DocC –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º:**
- –î–æ–±–∞–≤–∏—Ç—å –≤ TESTING.md —á–µ–∫–ª–∏—Å—Ç "–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏":
  ```
  ‚òê Research-First (–µ—Å–ª–∏ –Ω–æ–≤—ã–π External API)
  ‚òê Architecture-First (–µ—Å–ª–∏ concurrency/performance –∫—Ä–∏—Ç–∏—á–µ–Ω)
  ‚òê RFC –≤ MVP.md
  ‚òê User Story –¥–æ–∫—É–º–µ–Ω—Ç (E2E-Scenarios/*.md) ‚Üê –ù–û–í–û–ï
  ‚òê –¢–û–õ–¨–ö–û –ü–û–¢–û–ú ‚Üí Component Test (RED)
  ```

**–ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- "User Story –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –î–û –Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω—ã, –∑–∞–¥–∞—á–∞ –≤ TASKS.md)


---

## üî¥ –ò–Ω—Ü–∏–¥–µ–Ω—Ç ‚Äî 2025-12-11 (spike viewMessages)

**–¢–∏–ø:** –ù–µ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ (TDLIB_DATABASE_ENCRYPTION_KEY)

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
1. –ó–∞–ø—É—Å–∫ E2E spike —Ç–µ—Å—Ç–∞ –¥–ª—è viewMessages
2. TDLib —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π "Wrong padding length" –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. Root Cause: encryption key –¥–ª–∏–Ω–æ–π 23 –±–∞–π—Ç–∞ (–Ω–µ –∫—Ä–∞—Ç–Ω–æ 16 –¥–ª—è AES)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- E2E —Ç–µ—Å—Ç –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ —ç—Ç–∞–ø–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/—Ç–µ—Å—Ç—ã –±–µ–∑ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–ª—é—á–∞
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ .env.example, README, DEPLOY.md

**Root Cause:**
- –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ TDLIB_DATABASE_ENCRYPTION_KEY
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª–∏–Ω—ã –∫–ª—é—á–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- .env.example –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–º–µ—Ä –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–ª—é—á–∞

**–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
1. ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤–∞–ª–∏–¥–Ω—ã–π –∫–ª—é—á (32 –±–∞–π—Ç–∞ hex, 64 —Å–∏–º–≤–æ–ª–∞)
   - –§–æ—Ä–º–∞—Ç: hex (0-9a-f) –≤–º–µ—Å—Ç–æ base64 (–ø—Ä–æ–±–ª–µ–º—ã —Å `/`, `+`, `=` –≤ .env)
   - –ö–æ–º–∞–Ω–¥–∞: `openssl rand -hex 32`
2. ‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ BACKLOG.md
3. ‚è≥ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤ .env.example
4. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ TDConfig.forTesting()
5. ‚è≥ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ DEPLOY.md

**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º:**
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç/–¥–ª–∏–Ω—É –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (encryption key, API credentials)

**–ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- "Env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ" (–Ω–æ–≤–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)

**–ó–∞–¥–∞—á–∞:** –°–º. BACKLOG.md "–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è TDLIB_DATABASE_ENCRYPTION_KEY"

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Ö–æ–¥–∫–∞ (2025-12-12):**
- –ë–∞–≥ –≤ `main.swift` ‚Äî –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª `databaseEncryptionKey` –≤ TDConfig
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: main.swift:28,43 ‚Äî —á–∏—Ç–∞–µ—Ç –∏–∑ `env["TDLIB_DATABASE_ENCRYPTION_KEY"]`
- Spike test —É—Å–ø–µ—à–µ–Ω –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è


---

## üî¥ –ò–Ω—Ü–∏–¥–µ–Ω—Ç ‚Äî 2025-12-12 (Component Test: –Ω–∞—Ä—É—à–µ–Ω–∏–µ TDD + –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–µ–π–º–∏–Ω–≥)

**–¢–∏–ø:** –ù–∞—Ä—É—à–µ–Ω–∏–µ TDD –ø—Ä–æ—Ü–µ—Å—Å–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ë–ï–ó unit —Ç–µ—Å—Ç–∞)

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
1. –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å Component Test –¥–ª—è MarkAsReadService (–®–ê–ì 1 —Å–æ–≥–ª–∞—Å–Ω–æ –ø–ª–∞–Ω—É)
2. –í —Ç–µ—Å—Ç–µ —Å–æ–∑–¥–∞–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å `ViewMessagesRequest` (–¥—É–±–ª–∏–∫–∞—Ç –∏–∑ E2E —Ç–µ—Å—Ç–∞)
3. –ü—Ä–æ–ø—É—â–µ–Ω —à–∞–≥: Unit Test –¥–ª—è ViewMessagesRequest + —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ Sources/

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–∞—Ä—É—à–µ–Ω–∏–µ TDD –ø—Ä–∏–Ω—Ü–∏–ø–∞: –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞ –ë–ï–ó unit —Ç–µ—Å—Ç–∞ (RED ‚Üí GREEN –ø—Ä–æ–ø—É—â–µ–Ω)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞: ViewMessagesRequest –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –≤ E2E + Component Test
- –†–∏—Å–∫: –º–æ–¥–µ–ª—å –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ Codable (encode/decode)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (–Ω–µ–π–º–∏–Ω–≥):**
- Component Test –Ω–∞–∑–≤–∞–Ω –ø–æ —Å–µ—Ä–≤–∏—Å—É: `MarkAsReadServiceTests`
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–∑–≤–∞–Ω –ø–æ user story/flow: `"–û—Ç–º–µ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö"`
- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–µ–π–º–∏–Ω–≥–∞: `AuthenticationFlowTests` ‚Üí "–ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"

**Root Cause:**
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –≤ –ø—Ä–æ–º–ø—Ç–µ:
   - –ü—Ä–æ–º–ø—Ç —É–∫–∞–∑—ã–≤–∞–ª "Component Test (RED) –®–ê–ì 1"
   - –ù–æ TASKS.md –ø–æ–∫–∞–∑—ã–≤–∞–ª: "–®–ê–ì 1 Component Test, –®–ê–ì 2 Models + Unit Tests"
2. –ù–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ Outside-In TDD –¥–ª—è Component Tests:
   - Component Test –¢–†–ï–ë–£–ï–¢ –º–æ–¥–µ–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã
   - –ó–Ω–∞—á–∏—Ç, –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –†–ê–ù–¨–®–ï (—á–µ—Ä–µ–∑ Unit Test)
   - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –≤ —Ç–µ—Å—Ç–µ = anti-pattern

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (TDD):**
1. **Unit Test –¥–ª—è ViewMessagesRequest** (RED ‚Üí GREEN)
   - Tests/TgClientUnitTests/TDLibAdapter/TDLibCodableModels/Requests/ViewMessagesRequestTests.swift
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Codable: encode ‚Üí JSON (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã, @type, snake_case)
   - –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å –≤ Sources/TgClientModels/TDLibAdapter/Requests/ViewMessagesRequest.swift
   - GREEN
2. **Component Test –¥–ª—è Mark As Read flow** (RED ‚Üí GREEN)
   - Tests/TgClientComponentTests/DigestCore/MarkAsReadFlowTests.swift (–Ω–µ–π–º–∏–Ω–≥ –ø–æ flow!)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å ViewMessagesRequest
   - –°–æ–∑–¥–∞—Ç—å MarkAsReadService
   - GREEN

**–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
1. ‚è≥ –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É —Å–æ–∑–¥–∞–Ω–∏—è MarkAsReadServiceTests.swift
2. ‚è≥ –°–æ–∑–¥–∞—Ç—å Unit Test –¥–ª—è ViewMessagesRequest (–®–ê–ì 1)
3. ‚è≥ –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å ViewMessagesRequest –≤ Sources/ (–®–ê–ì 1)
4. ‚è≥ –°–æ–∑–¥–∞—Ç—å Component Test —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–µ–π–º–∏–Ω–≥–æ–º (–®–ê–ì 2)
5. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å TASKS.md (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ —à–∞–≥–æ–≤)

**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º:**
- **–ü—Ä–∞–≤–∏–ª–æ:** –ú–æ–¥–µ–ª—å –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ Unit Test (RED ‚Üí GREEN)
- **–ü—Ä–∞–≤–∏–ª–æ:** Component Test –∏–º–µ–Ω—É–µ—Ç—Å—è –ø–æ user story/flow, –ù–ï –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É/—Å–µ—Ä–≤–∏—Å—É
- –î–æ–±–∞–≤–∏—Ç—å –≤ TESTING.md:
  ```
  Component Test —Ç—Ä–µ–±—É–µ—Ç –º–æ–¥–µ–ª–∏? ‚Üí –°–Ω–∞—á–∞–ª–∞ Unit Test –¥–ª—è –º–æ–¥–µ–ª–∏ (RED ‚Üí GREEN)
  ```
- –û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md —Å–µ–∫—Ü–∏—é "Workflow –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏":
  ```
  ‚òê –ú–æ–¥–µ–ª—å –¥–ª—è Component Test? ‚Üí –°–Ω–∞—á–∞–ª–∞ Unit Test –º–æ–¥–µ–ª–∏
  ‚òê Component Test –Ω–µ–π–º–∏–Ω–≥: –ø–æ flow/user story, –ù–ï –ø–æ —Å–µ—Ä–≤–∏—Å—É
  ```

**–ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- "–ú–æ–¥–µ–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ Unit Test –î–û Component Test" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)
- "Component Test –Ω–µ–π–º–∏–Ω–≥ –ø–æ user story" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ (–ø–æ—Å–ª–µ spike research):**

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –¥–∞–ª—å—à–µ (–ø–æ—Å–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏):**
1. ‚úÖ –°–æ–∑–¥–∞–ª Unit Test ViewMessagesRequest ‚Üí GREEN
2. ‚úÖ –°–æ–∑–¥–∞–ª –º–æ–¥–µ–ª—å ViewMessagesRequest –≤ Sources/
3. ‚úÖ –£–¥–∞–ª–∏–ª –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∏–∑ E2E —Ç–µ—Å—Ç–∞
4. ‚ùå **–ù–û–í–ê–Ø –û–®–ò–ë–ö–ê:** –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å Component Test –î–û —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ viewMessages() –≤ TDLibClient
5. ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å MarkAsReadService —Å –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ (TaskGroup –≤—Ä—É—á–Ω—É—é)
6. ‚ùå –ù–ï –∏–∑—É—á–∏–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ (getChatHistory, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
7. ‚ùå –ù–ï —Å–ø—Ä–æ—Å–∏–ª –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø–æ—Ö–æ–∂–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞
- –¢—Ä–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–Ω—É–∂–¥–µ–Ω –ø–æ–≤—Ç–æ—Ä—è—Ç—å –±–∞–∑–æ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∞
- –ù–∞—Ä—É—à–µ–Ω–∏–µ "–∏–∑—É—á–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ü–ï–†–ï–î –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ"

**Root Cause (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π):**
1. **–ü—Ä–æ–ø—É—Å–∫ –∏–∑—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞:**
   - viewMessages() –Ω—É–∂–µ–Ω –±—ã–ª wrapper –∫–∞–∫ getChatHistory()
   - –ù–µ –∏–∑—É—á–∏–ª TDLibClient+HighLevelAPI –ø–µ—Ä–µ–¥ Component Test
   - –ù–µ –∏–∑—É—á–∏–ª –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (ResponseWaiters + @extra)
2. **–ò–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
   - –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å MarkAsReadService —Å TaskGroup —Å –Ω—É–ª—è
   - –ù–ï –ø–æ—Å–º–æ—Ç—Ä–µ–ª –Ω–∞ ChannelMessageSource (–∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ –µ—Å—Ç—å)
   - –ù–ï —Å–ø—Ä–æ—Å–∏–ª "–∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞?"
3. **–ù–∞—Ä—É—à–µ–Ω–∏–µ TDD –ø–æ—Ä—è–¥–∫–∞:**
   - –ü–æ–ø—ã—Ç–∫–∞ Component Test –î–û Unit Test –¥–ª—è viewMessages() High-Level API
   - –ù–µ —É—á—ë–ª —á—Ç–æ viewMessages() –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ @extra matching
4. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
   - –ü–æ—Å–ª–µ spike research –ø–æ—Ç–µ—Ä—è–ª —Ñ–æ–∫—É—Å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö
   - –ù–µ –ø—Ä–∏–º–µ–Ω–∏–ª –ø—Ä–∏–Ω—Ü–∏–ø "look at similar code first"

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (—á—Ç–æ –î–û–õ–ñ–ù–û –±—ã–ª–æ –±—ã—Ç—å):**

**–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
1. ‚òê **–ò–∑—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:**
   - –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω getChatHistory() –≤ TDLibClient+HighLevelAPI?
   - –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (TDLibClientTests ‚Üí @extra matching)?
   - –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω TaskGroup –≤ ChannelMessageSource?
2. ‚òê **–°–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - "–í–∏–∂—É —á—Ç–æ getChatHistory ‚Äî —ç—Ç–æ wrapper. viewMessages –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Ç–∞–∫ –∂–µ?"
   - "–í–∏–∂—É –ø–∞—Ç—Ç–µ—Ä–Ω TaskGroup –≤ ChannelMessageSource. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?"

**TDD —Ü–µ–ø–æ—á–∫–∞ (–ø–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è):**
1. ‚úÖ Unit Test ViewMessagesRequest (encode) ‚Üí GREEN
2. ‚è≥ **Unit Test viewMessages() High-Level API** (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã @extra) ‚Üí GREEN
   - –î–æ–±–∞–≤–∏—Ç—å –≤ TDLibClientTests (–∫–∞–∫ parallelGetChatRequestsMatchByExtra)
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å viewMessages() wrapper –≤ TDLibClient+HighLevelAPI
3. ‚è≥ **Component Test MarkAsReadFlowTests** (–∏—Å–ø–æ–ª—å–∑—É—è viewMessages()) ‚Üí GREEN
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π viewMessages()
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å MarkAsReadService (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω TaskGroup)

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ (—á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ):**
1. ‚úÖ Unit Test ViewMessagesRequest ‚Üí GREEN
2. ‚ùå Component Test MarkAsReadFlowTests (–ë–ï–ó viewMessages()) ‚Üí FAIL (–∫–æ–º–ø–∏–ª—è—Ü–∏—è)
3. ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É MarkAsReadService ‚Üí –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
4. üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –Ω–∞ getChatHistory
5. ‚úÖ Unit Test viewMessages() ‚Üí GREEN
6. ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è viewMessages() wrapper
7. ‚úÖ –ó–∞–≥–ª—É—à–∫–∞ MarkAsReadService (–¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)
8. ‚úÖ –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è MarkAsReadService (–ø–æ—Å–ª–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏)
9. ‚úÖ Component Test ‚Üí GREEN

**–†–∞–∑–Ω–∏—Ü–∞:** 9 —à–∞–≥–æ–≤ –≤–º–µ—Å—Ç–æ 3, –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫, –ø–µ—Ä–µ–¥–µ–ª–æ–∫.

**–ù–æ–≤—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
1. ‚è≥ **–û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md ‚Äî —Å–µ–∫—Ü–∏—è "–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏":**
   ```
   ‚òê Grep/Read —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Ö–æ–∂–∏–π –∫–æ–¥
   ‚òê –ò–∑—É—á–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã (ResponseWaiters, TaskGroup, High-Level API wrappers)
   ‚òê –°–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ
   ‚òê –¢–û–õ–¨–ö–û –ü–û–¢–û–ú –Ω–∞—á–∏–Ω–∞—Ç—å –ø–∏—Å–∞—Ç—å –∫–æ–¥
   ```
2. ‚è≥ **–î–æ–±–∞–≤–∏—Ç—å –≤ TESTING.md —á–µ–∫–ª–∏—Å—Ç "Outside-In TDD":**
   ```
   –ù–æ–≤—ã–π High-Level API –º–µ—Ç–æ–¥?
   ‚òê Unit Test –¥–ª—è –º–µ—Ç–æ–¥–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
   ‚òê –†–µ–∞–ª–∏–∑–∞—Ü–∏—è wrapper (–∏–∑—É—á–∏ getChatHistory –∫–∞–∫ –ø—Ä–∏–º–µ—Ä)
   ‚òê GREEN

   –ù–æ–≤—ã–π Service —Å concurrency?
   ‚òê –ò–∑—É—á–∏ ChannelMessageSource (TaskGroup –ø–∞—Ç—Ç–µ—Ä–Ω)
   ‚òê Component Test (–∏—Å–ø–æ–ª—å–∑—É—è —É–∂–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API)
   ‚òê –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ç—Ç–µ—Ä–Ω)
   ‚òê GREEN
   ```
3. ‚è≥ **–°–æ–∑–¥–∞—Ç—å .claude/PATTERNS.md ‚Äî –∫–∞—Ç–∞–ª–æ–≥ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:**
   - High-Level API wrapper (getChatHistory)
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (@extra matching, TDLibClientTests)
   - TaskGroup —Å concurrency limit (ChannelMessageSource)
   - Mock —Ç–æ–ª—å–∫–æ boundaries (MockTDLibFFI, –ù–ï MockTDLibClient)

**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º:**
- **–ü—Ä–∞–≤–∏–ª–æ 0 (–ù–û–í–û–ï):** –ü–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –∫–æ–¥–∞ ‚Üí Grep/Read –ø–æ—Ö–æ–∂–∏–π –∫–æ–¥
- **–ü—Ä–∞–≤–∏–ª–æ 1:** –°–ø—Ä–æ—Å–∏ "–∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö?" –ü–ï–†–ï–î –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ–º
- **–ü—Ä–∞–≤–∏–ª–æ 2:** TDD Outside-In: Lower-level API ‚Üí Higher-level Service
- **–ü—Ä–∞–≤–∏–ª–æ 3:** Mock —Ç–æ–ª—å–∫–æ boundaries (—É–∂–µ –±—ã–ª–æ, –Ω–æ –Ω–∞—Ä—É—à–µ–Ω–æ —Å–Ω–æ–≤–∞)

**–ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è):**
- "–ò–∑—É—á–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –î–û –Ω–∞–ø–∏—Å–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)
- "–ó–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ—Å—Ç–∏" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)
- "–ú–æ–¥–µ–ª–∏/API —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ Unit Test –î–û Component Test" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)
- "–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)

**–í—ã–≤–æ–¥—ã:**
- **Spike research ‚Üí –ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞** ‚Äî –ø–æ—Å–ª–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ API –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
- **"–ü—Ä–æ—Å—Ç–∞—è –∑–∞–¥–∞—á–∞" —Ç—Ä–µ–±—É–µ—Ç –º–µ—Ç–æ–¥–∏—á–Ω–æ—Å—Ç–∏** ‚Äî –æ—Ç–º–µ—Ç–∫–∞ —á–∞—Ç–æ–≤ –ø—Ä–æ—Å—Ç–∞ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤—Å–µ–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º TDD
- **–ò–∑—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ > –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ** ‚Äî –ø—Ä–æ–µ–∫—Ç —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –Ω—É–∂–Ω–æ –∏—Ö –Ω–∞—Ö–æ–¥–∏—Ç—å –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- **TDD –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤** ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (Unit ‚Üí Component) –≤—ã–Ω—É–∂–¥–∞–µ—Ç –∏–∑—É—á–∞—Ç—å API –ü–ï–†–ï–î Service

**–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å–∏–ª–µ–Ω–∏–µ —á–µ–∫–ª–∏—Å—Ç–æ–≤.


---

## üî¥ –ò–Ω—Ü–∏–¥–µ–Ω—Ç ‚Äî 2025-12-12 (–ü—Ä–æ–ø—É—â–µ–Ω Code Review –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏)

**–¢–∏–ø:** –ù–∞—Ä—É—à–µ–Ω–∏–µ Development Flow (CLAUDE.md ¬ß –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò)

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é 2025-12-12
2. –ó–∞ –≤—á–µ—Ä–∞ (2025-12-11) –±—ã–ª–∏ –∫–æ–º–º–∏—Ç—ã:
   - `72ccc4b docs: –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ spike test v0.4.0`
   - `ec95e95 test: E2E —Ç–µ—Å—Ç –¥–ª—è viewMessages + User Story –¥–æ–∫—É–º–µ–Ω—Ç—ã`
   - `5a28087 fix: —á—Ç–µ–Ω–∏–µ TDLIB_DATABASE_ENCRYPTION_KEY –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è`
3. Claude –ù–ï –ø—Ä–µ–¥–ª–æ–∂–∏–ª Code Review –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏
4. –°—Ä–∞–∑—É –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ–π (Component Test –¥–ª—è MarkAsReadService)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü—Ä–æ–ø—É—â–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –∫–æ–¥–∞
- –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏
- –ù–∞—Ä—É—à–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ "–ø–µ—Ä–≤–∞—è —Å–µ—Å—Å–∏—è –¥–Ω—è ‚Üí code review –≤—á–µ—Ä–∞—à–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤"

**Root Cause:**
–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω —á–µ–∫–ª–∏—Å—Ç –∏–∑ CLAUDE.md ¬ß "–ù–ê–ß–ê–õ–û –ù–û–í–û–ô –°–ï–°–°–ò–ò":

```
3. **–ü–µ—Ä–≤–∞—è —Å–µ—Å—Å–∏—è –∑–∞ –¥–µ–Ω—å?** ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å code review:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `git log --since="yesterday" --oneline`
   - –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–º–∏—Ç—ã –∑–∞ –≤—á–µ—Ä–∞ ‚Üí "–ü—Ä–µ–¥–ª–∞–≥–∞—é code review –≤—á–µ—Ä–∞—à–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π"
   - –†–æ–ª—å: Senior Code Reviewer ([ROLES.md](.claude/ROLES.md))
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (—á—Ç–æ –î–û–õ–ñ–ù–û –±—ã–ª–æ –±—ã—Ç—å):**

1. `git fetch && git status` ‚úÖ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `git log --since="yesterday" --oneline` ‚ùå (–ø—Ä–æ–ø—É—â–µ–Ω–æ)
3. –û–±–Ω–∞—Ä—É–∂–∏—Ç—å 3 –∫–æ–º–º–∏—Ç–∞ –∑–∞ –≤—á–µ—Ä–∞ ‚ùå (–ø—Ä–æ–ø—É—â–µ–Ω–æ)
4. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å: "–í–∏–∂—É 3 –∫–æ–º–º–∏—Ç–∞ –∑–∞ –≤—á–µ—Ä–∞. –ü—Ä–µ–¥–ª–∞–≥–∞—é code review?" ‚ùå (–ø—Ä–æ–ø—É—â–µ–Ω–æ)
5. –ü—Ä–æ–≤–µ—Å—Ç–∏ review (—Ä–æ–ª—å: Senior Code Reviewer) ‚ùå (–ø—Ä–æ–ø—É—â–µ–Ω–æ)
6. –ü—Ä–æ—á–∏—Ç–∞—Ç—å TASKS.md –∏ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É ‚úÖ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. `git fetch && git status` ‚úÖ
2. –ü—Ä–æ—á–∏—Ç–∞—Ç—å TASKS.md ‚úÖ
3. –°—Ä–∞–∑—É –Ω–∞—á–∞—Ç—å Component Test ‚úÖ (–Ω–æ –ë–ï–ó code review!)

**–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
1. ‚è≥ –£—Å–∏–ª–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ (system message?)
2. ‚è≥ –ü—Ä–æ–≤–µ—Å—Ç–∏ Code Review –≤—á–µ—Ä–∞—à–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤ –°–ï–ô–ß–ê–° (–∑–∞–ø–æ–∑–¥–∞–ª–æ)
3. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md ‚Äî —Å–¥–µ–ª–∞—Ç—å Code Review –±–æ–ª–µ–µ —è–≤–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º

**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º:**
- **–ü—Ä–∞–≤–∏–ª–æ:** –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è—Ç—å `git log --since="yesterday"` –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏
- –î–æ–±–∞–≤–∏—Ç—å –≤ internal checklist (–ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º TASKS.md)

**–ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- "Code Review –ø—Ä–æ–≤–µ–¥—ë–Ω –≤ –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–∏ –¥–Ω—è" (100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ)
- –¶–µ–ª–µ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞ v0.4.0: 100% –¥–Ω–µ–π —Å –∫–æ–º–º–∏—Ç–∞–º–∏ ‚Üí code review

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–≤–µ–¥—ë–Ω (2025-12-12)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** APPROVE ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ—Ç, –∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç v0.4.0


---

## üìù Finding ‚Äî 2025-12-12 (TSan –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å uninstrumented libraries)

**–¢–∏–ø:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (TSan + C++ libraries)

**–ß—Ç–æ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏:**

–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å `swift run --sanitize=thread tg-client` ‚Üí –∫—Ä–∞—à –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã:

```
ThreadSanitizer: CHECK failed: sanitizer_allocator_secondary.h:297
"((IsAligned(p, page_size_))) != (0)" (0x0, 0x0)

Stack trace: operator delete(void*) in libtdjson.1.8.56.dylib
```

**Root Cause:**

TDLib ‚Äî C++ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è **–ë–ï–ó TSan –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ü–∏–∏**.

–ö–æ–≥–¥–∞ Swift –∫–æ–¥ (—Å TSan) –≤—ã–∑—ã–≤–∞–µ—Ç uninstrumented C++ library:
- TSan tracking –ø–∞–º—è—Ç–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∞–ª–ª–æ–∫–∞—Ü–∏—è–º–∏ TDLib
- –ü—Ä–∏ cleanup TDLib –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å ‚Üí TSan –≤–∏–¥–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
- **False positive** ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –Ω–∞—à–µ–º –∫–æ–¥–µ, –∞ –≤ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ TSan + uninstrumented lib

**–†–µ—à–µ–Ω–∏–µ:**

‚úÖ **Component-level TSan –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:**
- `swift test --sanitize=thread` ‚Äî 216 —Ç–µ—Å—Ç–æ–≤ CLEAN
- MockTDLibFFI –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ TDLib –≤ —Ç–µ—Å—Ç–∞—Ö
- –ü–æ–∫—Ä—ã–≤–∞–µ—Ç –≤–µ—Å—å Swift concurrency –∫–æ–¥ (MarkAsReadService, MockLogger, TaskGroup)

‚ùå **E2E —Å TSan –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω:**
- `swift run --sanitize=thread` –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å TDLib
- E2E validation –ë–ï–ó TSan: `swift run tg-client`

**–í—ã–≤–æ–¥:**

TSan —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è Swift –∫–æ–¥–∞, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å uninstrumented C/C++ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏.

–î–ª—è FFI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (TDLib, libcurl, etc.) –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞:
- Component tests —Å mock boundaries (TSan CLEAN)
- E2E validation –±–µ–∑ TSan (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

**–ú–µ—Ç—Ä–∏–∫–∞:**
- Component-level TSan: 100% coverage Swift concurrency –∫–æ–¥–∞ ‚úÖ
- E2E TSan: –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å FFI ‚ùå

**–°—Ç–∞—Ç—É—Å:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è


---

## üî¥ –í–æ–ø—Ä–æ—Å –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è ‚Äî 2025-12-12

**–¢–µ–º–∞:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫ ‚Äî –ø–æ—á–µ–º—É –Ω–µ —Å–¥–µ–ª–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `withRetry()` —Å exponential backoff (1s, 2s, 4s)
- –ù–∞–ø–∏—Å–∞–Ω—ã —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ ‚Üí 3.2s –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–ª–æ–∂–∏–ª: —É–º–µ–Ω—å—à–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö –¥–æ 0.1s, 0.2s, 0.3s
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤ —Å–Ω–∏–∑–∏–ª–æ—Å—å —Å 3.2s ‚Üí 0.47s (7x —É—Å–∫–æ—Ä–µ–Ω–∏–µ)

**–ü—Ä–æ–±–ª–µ–º–∞:**
Claude –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏–ª —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ö–æ—Ç—è:
1. –û–±—Å—É–∂–¥–∞–ª–∞—Å—å —Ç–µ–º–∞ `Task.sleep` –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö —Ä–∞–Ω–µ–µ
2. –û—á–µ–≤–∏–¥–Ω—ã–π trade-off: production –∑–∞–¥–µ—Ä–∂–∫–∏ vs —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏
3. –ü–∞—Ç—Ç–µ—Ä–Ω –∏–∑–≤–µ—Å—Ç–µ–Ω: –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–µ—Ç—Ä–æ:**
1. –ü–æ—á–µ–º—É –Ω–µ –±—ã–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω `baseDelay` –ø–∞—Ä–∞–º–µ—Ç—Ä —Å—Ä–∞–∑—É –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤?
2. –î–æ–ª–∂–µ–Ω –ª–∏ —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –±—ã—Ç—å –≤ TESTING.md –∫–∞–∫ best practice?
3. –ù—É–∂–µ–Ω –ª–∏ —á–µ–∫–ª–∏—Å—Ç "—Ç–µ—Å—Ç—ã —Å Task.sleep ‚Üí –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏"?

**–°–≤—è–∑–∞–Ω–æ —Å:**
- –û–±—Å—É–∂–¥–µ–Ω–∏–µ `Task.sleep` –≤ —Ç–µ—Å—Ç–∞—Ö (–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–µ—Å—Å–∏–∏)
- TESTING.md ¬ß "–¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±—ã—Å—Ç—Ä—ã–º–∏"

**–î–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –≤ –∏—Ç–æ–≥–æ–≤–æ–π —Ä–µ—Ç—Ä–æ v0.4.0**


**–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—É (2025-12-12):**

**–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî DigestOrchestrator retry —Ç–µ—Å—Ç—ã:**
1. –°–æ–∑–¥–∞–Ω DigestOrchestrator —Å retry –ª–æ–≥–∏–∫–æ–π (baseDelay: .seconds(1) –¥–ª—è production)
2. –ù–∞–ø–∏—Å–∞–Ω—ã component —Ç–µ—Å—Ç—ã –¥–ª—è retry –ë–ï–ó –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–µ—Ä–∂–µ–∫
3. –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –±—ã production delays (1s, 2s, 4s) ‚Üí ~7 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤–∞ –∑–∞–º–µ—Ç–∏–ª –ø—Ä–æ–±–ª–µ–º—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏–ª –¥–æ–±–∞–≤–∏—Ç—å `baseDelay` –≤ init
5. –ü–æ—Å–ª–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏: —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞ 0.32s (–≤–º–µ—Å—Ç–æ ~7s)

**–ü–∞—Ç—Ç–µ—Ä–Ω:**
- RetryHelpers unit —Ç–µ—Å—Ç—ã: —Ç–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞ ‚Üí —Ä–µ—à–µ–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–º–µ—á–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- DigestOrchestrator component —Ç–µ—Å—Ç—ã: —Ç–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞ ‚Üí —Å–Ω–æ–≤–∞ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ

**Root Cause (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è):**
Claude –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—ã—É—á–µ–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω "—Ç–µ—Å—Ç—ã —Å Task.sleep ‚Üí –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫ –Ω–æ–≤–æ–º—É –∫–æ–¥—É.

**–ì–∏–ø–æ—Ç–µ–∑–∞:**
–ü–∞—Ç—Ç–µ—Ä–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –≤ TESTING.md –∫–∞–∫ —è–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å–∞–Ω –≤ —Ä–µ—Ç—Ä–æ-–≤–æ–ø—Ä–æ—Å—ã.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Ä–µ—Ç—Ä–æ v0.4.0:**
–î–æ–±–∞–≤–∏—Ç—å –≤ TESTING.md —Å–µ–∫—Ü–∏—é:
```markdown
## –¢–µ—Å—Ç—ã —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ (Task.sleep)

**–ü—Ä–∞–≤–∏–ª–æ:** –ï—Å–ª–∏ –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Task.sleep –∏–ª–∏ retry —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏, –í–°–ï–ì–î–ê –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

**–ü–ª–æ—Ö–æ:**
```swift
let orchestrator = DigestOrchestrator(...)  // baseDelay = .seconds(1) hardcoded
```

**–•–æ—Ä–æ—à–æ:**
```swift
let orchestrator = DigestOrchestrator(..., baseDelay: .milliseconds(100))  // –¢–µ—Å—Ç—ã –≤ 10x –±—ã—Å—Ç—Ä–µ–µ
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –±—ã—Å—Ç—Ä–æ (< 1s –Ω–∞ suite). Production –∑–∞–¥–µ—Ä–∂–∫–∏ (1s+) –∑–∞–º–µ–¥–ª—è—é—Ç TDD —Ü–∏–∫–ª.
```


---

## üî¥ –ò–Ω—Ü–∏–¥–µ–Ω—Ç ‚Äî 2025-12-12 (–ù–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π Spike Search –¥–ª—è viewMessages)

**–¢–∏–ø:** –ù–∞—Ä—É—à–µ–Ω–∏–µ Research-First –ø—Ä–æ—Ü–µ—Å—Å–∞ (–Ω–µ–ø–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**
1. –ü—Ä–æ–≤–µ–¥—ë–Ω spike test –¥–ª—è viewMessages (MarkAsReadE2ETests)
2. –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–∏–ª `viewMessages(chatId, messageIds, forceRead: true)`
3. TDLib –≤–µ—Ä–Ω—É–ª `OkResponse` ‚Üí —Ç–µ—Å—Ç PASSED ‚úÖ
4. **–ù–û:** –°–æ–æ–±—â–µ–Ω–∏—è –ù–ï –±—ã–ª–∏ –ø–æ–º–µ—á–µ–Ω—ã –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º Telegram –∫–ª–∏–µ–Ω—Ç–µ!
5. –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ production validation (2+ —á–∞—Å–∞ —Å–ø—É—Å—Ç—è)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Ç—Ä–∞—á–µ–Ω–æ 2+ —á–∞—Å–∞ –Ω–∞ debug (—Ñ–∏–ª—å—Ç—Ä—ã –∫–∞–Ω–∞–ª–æ–≤, unsupported –∫–æ–Ω—Ç–µ–Ω—Ç)
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≥–∏–ø–æ—Ç–µ–∑ (—Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—ã vs –∫–∞–Ω–∞–ª—ã, —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞, parallel viewMessages)
- –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä–∏–ª UI –≤—Ä—É—á–Ω—É—é

**Root Cause:**
1. **Spike test –ù–ï –ø—Ä–æ–≤–µ—Ä–∏–ª —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ü—Ä–æ–≤–µ—Ä–∏–ª–∏ —Ç–æ–ª—å–∫–æ API response (OkResponse)
   - –ù–ï –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ UI effect (unread badge –∏—Å—á–µ–∑?)
   - –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–ª–∏ —á—Ç–æ OkResponse = success
2. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è TDLib –Ω–µ–ø–æ–ª–Ω–∞—è:**
   - `viewMessages` docs –Ω–µ —É–ø–æ–º–∏–Ω–∞—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ `openChat`
   - –ù–∞—à–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –≤ GitHub Issues: "You need to properly call openChat, closeChat and viewMessages"
3. **Research-First —á–µ–∫–ª–∏—Å—Ç –Ω–µ –≤–∫–ª—é—á–∞–ª UI validation:**
   - ‚úÖ WebFetch –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   - ‚úÖ Live test —Å —Ä–µ–∞–ª—å–Ω—ã–º API
   - ‚ùå **Manual UI verification** ‚Üê –ø—Ä–æ–ø—É—â–µ–Ω–æ!

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π spike test (—á—Ç–æ –î–û–õ–ñ–ù–û –±—ã–ª–æ –±—ã—Ç—å):**
1. –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å E2E test ‚Üí `viewMessages()`
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Telegram –∫–ª–∏–µ–Ω—Ç–µ:** badge –∏—Å—á–µ–∑? ‚Üê –ö–†–ò–¢–ò–ß–ù–û!
4. –ï—Å–ª–∏ badge –æ—Å—Ç–∞–ª—Å—è ‚Üí –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å Issue tracker TDLib
5. –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ UI verification ‚Üí —Å—á–∏—Ç–∞—Ç—å spike —É—Å–ø–µ—à–Ω—ã–º

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π spike test (—á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ):**
1. –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å E2E test ‚Üí `viewMessages()` ‚Üí OkResponse
3. –°—á–∏—Ç–∞—Ç—å spike —É—Å–ø–µ—à–Ω—ã–º ‚úÖ (–û–®–ò–ë–ö–ê!)
4. Production: viewMessages –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚ùå
5. 2+ —á–∞—Å–∞ debug ‚Üí –Ω–∞—à–ª–∏ –≤ GitHub Issues –ø—Ä–æ `openChat`

**–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
1. ‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: `openChat` ‚Üí `viewMessages` ‚Üí `closeChat`
2. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å TESTING.md ¬ß Research-First —á–µ–∫–ª–∏—Å—Ç:
   ```
   ‚òê WebFetch –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã + behaviour + edge cases)
   ‚òê Live —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç (–µ—Å–ª–∏ —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞)
   ‚òê **Manual UI verification** (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –≤ UI/–∫–ª–∏–µ–Ω—Ç–µ)
   ‚òê Failing test —Å –∫—Ä–∞–µ–≤—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏
   ‚òê –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
   ```
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –≤ CLAUDE.md –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è External APIs:
   ```
   External API spike ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (UI/—Ñ–∞–π–ª/—Å–µ—Ç—å)
   OkResponse ‚â† success (–º–æ–∂–µ—Ç –±—ã—Ç—å accepted –Ω–æ –Ω–µ executed)
   ```

**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º:**
- **–ü—Ä–∞–≤–∏–ª–æ:** Spike test External API ‚Üí –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–Ω–µ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (UI/—Ñ–∞–π–ª/etc)
- **–ü—Ä–∞–≤–∏–ª–æ:** OkResponse –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è TDLib/–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö API)
- **–ß–µ–∫–ª–∏—Å—Ç:** Manual verification –¥–ª—è spike tests (–¥–æ–±–∞–≤–∏—Ç—å –≤ TESTING.md)

**–ú–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- "Spike test –≤–∫–ª—é—á–∞–µ—Ç manual UI verification" (100% –¥–ª—è External APIs)
- Research-First –º–µ—Ç—Ä–∏–∫–∞ v0.4.0 (—Ü–µ–ª–µ–≤–∞—è: 100%)

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã (–Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏ debug):**
- [TDLib Issue #1513](https://github.com/tdlib/td/issues/1513): "You need to properly call openChat, closeChat and viewMessages"
- [TDLib Issue #258](https://github.com/tdlib/td/issues/258): "marking happens in opened chats"
- [TDLib Issue #136](https://github.com/tdlib/td/issues/136): "ViewMessages marks as read ONLY SEEN messages"

**–°—Ç–∞—Ç—É—Å:** ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–æ–≤—ã–π spike test —Å openChat/closeChat + manual verification

**Impact –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏ v0.4.0:**
- Research-First: 2/3 External APIs (66%) ‚Üê —Ü–µ–ª–µ–≤–∞—è 100%
  - viewMessages spike: incomplete (no UI verification)
  - getChatHistory: complete ‚úÖ
  - OpenAI API: complete ‚úÖ

**–í—ã–≤–æ–¥—ã:**
- **API response ‚â† —Ä–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç** ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö/state-dependent API (TDLib)
- **Spike –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å end-to-end** ‚Äî –æ—Ç API call –¥–æ UI/file/network effect
- **GitHub Issues > –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî –¥–ª—è TDLib –º–Ω–æ–≥–∏–µ –Ω—é–∞–Ω—Å—ã —Ç–æ–ª—å–∫–æ –≤ Issues
- **Manual verification –∫—Ä–∏—Ç–∏—á–Ω–∞** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –Ω–µ –≤—Å–µ–≥–¥–∞ –ª–æ–≤—è—Ç UI/state –ø—Ä–æ–±–ª–µ–º—ã


---
## –õ–æ–≥ –º–µ—Ç—Ä–∏–∫ ‚Äî 2025-12-13 (–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ v0.4.0)

**–ü–µ—Ä–∏–æ–¥ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** 2025-12-11 ‚Äî 2025-12-13 (3 –¥–Ω—è, 11 –∫–æ–º–º–∏—Ç–æ–≤)

**Research-First:** 1/1 External APIs (100% = —Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å) ‚úÖ
- viewMessages (TDLib API) ‚Äî spike test –≤—ã–ø–æ–ª–Ω–µ–Ω (ec95e95), E2E –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω

**Mock —Ç–æ–ª—å–∫–æ boundaries:** —Å–æ–±–ª—é–¥–µ–Ω–æ ‚úÖ
- MockTDLibFFI (FFI boundary), MockHTTPClient (network boundary)
- MockLogger race condition –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (NSLock)

**Code Review:** –ø—Ä–æ–≤–µ–¥—ë–Ω (1/1 –¥–µ–Ω—å = 100%) ‚úÖ
- 2025-12-12: review –≤—á–µ—Ä–∞—à–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤ (—Ö–æ—Ç—å –∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
- –†–µ–∑—É–ª—å—Ç–∞—Ç: APPROVE ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ—Ç

**–î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤:** 0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å) ‚úÖ
- ViewMessagesRequest, MarkAsReadService, RetryHelpers ‚Äî Grep –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º

**–ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** 0 –ø–æ–ø—ã—Ç–æ–∫ (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å) ‚úÖ
- –ë–∞–≥ TDLIB_DATABASE_ENCRYPTION_KEY –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥—ë–Ω –≤ spike —Ç–µ—Å—Ç–µ, root cause –Ω–∞–π–¥–µ–Ω

**Concurrency:** Architecture-First –ø—Ä–∏–º–µ–Ω—ë–Ω (–î–ê), TSan GREEN ‚úÖ
- MarkAsReadService: actor, concurrency safety, TaskGroup —Å limit=20
- TSan: 248 —Ç–µ—Å—Ç–æ–≤ CLEAN, 1 race condition –Ω–∞–π–¥–µ–Ω –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (MockLogger)
- 0 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–≤ –∏–∑-–∑–∞ concurrency –æ—à–∏–±–æ–∫ (—Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)

**–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã:**
1. User Story –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–ø—É—â–µ–Ω (2025-12-11) ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (GenerateSummary.md, MarkAsRead.md —Å–æ–∑–¥–∞–Ω—ã)
2. TDLIB_DATABASE_ENCRYPTION_KEY –Ω–µ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω (2025-12-11) ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (.env.example –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
3. –ù–∞—Ä—É—à–µ–Ω–∏–µ TDD –ø–æ—Ä—è–¥–∫–∞ (Component Test –ë–ï–ó Unit Test) (2025-12-12) ‚Üí –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
4. –ü—Ä–æ–ø—É—â–µ–Ω Code Review –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏ (2025-12-12) ‚Üí –ø—Ä–æ–≤–µ–¥—ë–Ω (–∑–∞–ø–æ–∑–¥–∞–ª–æ), APPROVE
5. TSan + uninstrumented C++ library (finding) ‚Äî Component-level TSan –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

**–ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª:**
- User Story –¥–æ–∫—É–º–µ–Ω—Ç: –ø—Ä–æ–ø—É—â–µ–Ω –≤ –Ω–∞—á–∞–ª–µ v0.4.0 (root cause: –Ω–µ—Ç —á–µ–∫–ª–∏—Å—Ç–∞ "–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤–µ—Ä—Å–∏–∏")
- TDD –ø–æ—Ä—è–¥–æ–∫: –ø–æ–ø—ã—Ç–∫–∞ Component Test –ë–ï–ó Unit Test –¥–ª—è –º–æ–¥–µ–ª–∏ (root cause: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –ø–ª–∞–Ω–∞)
- Code Review: –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏ (root cause: –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω —á–µ–∫–ª–∏—Å—Ç –∏–∑ CLAUDE.md)
- "–ò–∑—É—á–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ü–ï–†–ï–î –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º": –Ω–∞—Ä—É—à–µ–Ω–æ (–ø–æ–ø—ã—Ç–∫–∞ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤–º–µ—Å—Ç–æ –∏–∑—É—á–µ–Ω–∏—è getChatHistory –ø–∞—Ç—Ç–µ—Ä–Ω–∞)

**–í—ã–≤–æ–¥—ã:**

**–†–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ Research-First: 100% (–±—ã–ª–æ 25% –≤ v0.3.0) ‚Äî spike test –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è External APIs
- ‚úÖ Mock —Ç–æ–ª—å–∫–æ boundaries: 100% (–±—ã–ª–æ 0% –≤ v0.3.0) ‚Äî –ø—Ä–∞–≤–∏–ª–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤: 0% (–±—ã–ª–æ 16% –≤ v0.3.0) ‚Äî Grep –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ TSan: 1 race condition –Ω–∞–π–¥–µ–Ω –î–û production (MockLogger) ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω
- ‚úÖ Concurrency: 0 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–≤ ‚Äî Architecture-First + TSan –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏
- ‚úÖ Code Review: 100% –¥–Ω–µ–π ‚Äî –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã (—Ö–æ—Ç—å –∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)

**–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç / —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚ö†Ô∏è –ß–µ–∫–ª–∏—Å—Ç "–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤–µ—Ä—Å–∏–∏": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí User Story –ø—Ä–æ–ø—É—â–µ–Ω
- ‚ö†Ô∏è "–ò–∑—É—á–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ü–ï–†–ï–î –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º": –Ω–∞—Ä—É—à–µ–Ω–æ ‚Üí –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–¥–µ–ª–æ–∫
- ‚ö†Ô∏è Code Review timing: –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏ ‚Üí –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ —è–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
- ‚ö†Ô∏è TDD –ø–æ—Ä—è–¥–æ–∫: Component Test –ë–ï–ó Unit Test ‚Üí –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π —á–µ–∫–ª–∏—Å—Ç

**–ù–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è v0.5.0:**
1. –ß–µ–∫–ª–∏—Å—Ç "–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤–µ—Ä—Å–∏–∏" –≤ TESTING.md (Research-First ‚Üí RFC ‚Üí User Story ‚Üí E2E ‚Üí Component)
2. –ü—Ä–∞–≤–∏–ª–æ "–ò–∑—É—á–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥" ‚Äî Grep/Read –ø–æ—Ö–æ–∂–∏–π –∫–æ–¥ –ü–ï–†–ï–î –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º
3. Code Review —Ç—Ä–∏–≥–≥–µ—Ä –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `git log --since="yesterday"` –í–°–ï–ì–î–ê
4. TDD —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫ ‚Äî Unit Test –¥–ª—è –º–æ–¥–µ–ª–∏ ‚Üí Component Test –¥–ª—è flow

**–¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã:**
- Research-First: 100% ‚úÖ (—Ü–µ–ª—å: 100%)
- Mock —Ç–æ–ª—å–∫–æ boundaries: 100% ‚úÖ (—Ü–µ–ª—å: 100%)
- –î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤: 0% ‚úÖ (—Ü–µ–ª—å: 0%)
- Code Review: 100% ‚úÖ (—Ü–µ–ª—å: 100%)
- Concurrency: 0 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–≤ ‚úÖ (—Ü–µ–ª—å: 0)
- –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ: 0 –ø–æ–ø—ã—Ç–æ–∫ ‚úÖ (—Ü–µ–ª—å: 0)

**–ò—Ç–æ–≥ v0.4.0:** –í—Å–µ —Ü–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã, –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ

–ù–æ: 4 –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ –Ω—É–∂–Ω—ã –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ —á–µ–∫–ª–∏—Å—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫.

**–°–ª–µ–¥—É—é—â–∞—è –≤–µ—Ä—Å–∏—è (v0.5.0):** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–≤–æ–¥—ã —Ä–µ—Ç—Ä–æ ‚Üí —É—Å–∏–ª–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç—ã ‚Üí –º–µ–Ω—å—à–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤.


---

# –†–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–∞ v0.4.0 ‚Äî –ò—Ç–æ–≥–∏

**–ü–µ—Ä–∏–æ–¥:** 2025-12-11 ‚Äî 2025-12-13 (3 –¥–Ω—è, 11 –∫–æ–º–º–∏—Ç–æ–≤)
**–ó–∞–¥–∞—á–∞:** v0.4.0 MarkAsReadService + DigestOrchestrator (pipeline integration)

## –ú–µ—Ç—Ä–∏–∫–∏ ‚Äî –í–°–ï –¶–ï–õ–ï–í–´–ï –î–û–°–¢–ò–ì–ù–£–¢–´ ‚úÖ

**Research-First:** 100% (1/1 External APIs) ‚úÖ ‚Äî —Ü–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (–±—ã–ª–æ 25% –≤ v0.3.0)
**Mock —Ç–æ–ª—å–∫–æ boundaries:** 100% —Å–æ–±–ª—é–¥–µ–Ω–∏–π ‚úÖ ‚Äî –ø—Ä–∞–≤–∏–ª–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–±—ã–ª–æ 0% –≤ v0.3.0)
**–î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤:** 0% ‚úÖ ‚Äî Grep –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç (–±—ã–ª–æ 16% –≤ v0.3.0)
**Code Review:** 100% –¥–Ω–µ–π —Å –∫–æ–º–º–∏—Ç–∞–º–∏ ‚úÖ ‚Äî –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã (–Ω–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞)
**TSan:** 1 race condition –Ω–∞–π–¥–µ–Ω –î–û production ‚úÖ ‚Äî MockLogger –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (–Ω–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞)
**Concurrency:** 0 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–≤ ‚úÖ ‚Äî Architecture-First –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ (–Ω–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞)

## –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã (4 —à—Ç.)

1. **User Story –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–ø—É—â–µ–Ω** (2025-12-11) ‚Äî –Ω–∞—á–∞–ª–∏ v0.4.0 –±–µ–∑ E2E User Story –¥–æ–∫—É–º–µ–Ω—Ç–∞.
   - Root cause: –Ω–µ—Ç —á–µ–∫–ª–∏—Å—Ç–∞ "–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏"
   - –†–µ—à–µ–Ω–∏–µ: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º (Planning Architect ‚Üí Testing Architect gating)

2. **TDLIB_DATABASE_ENCRYPTION_KEY –Ω–µ–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω** (2025-12-11) ‚Äî E2E —Ç–µ—Å—Ç —É–ø–∞–ª –∏–∑-–∑–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –∫–ª—é—á–∞.
   - Root cause: —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
   - –†–µ—à–µ–Ω–∏–µ: one-off –∏–Ω—Ü–∏–¥–µ–Ω—Ç, —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (.env.example –æ–±–Ω–æ–≤–ª–µ–Ω)

3. **–ù–∞—Ä—É—à–µ–Ω–∏–µ TDD –ø–æ—Ä—è–¥–∫–∞** (2025-12-12) ‚Äî Component Test –ë–ï–ó Unit Test –¥–ª—è –º–æ–¥–µ–ª–∏ + –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.
   - Root cause A: spike search —Å–±–∏–≤–∞–µ—Ç —Å TDD –ø—Ä–æ—Ü–µ—Å—Å–∞
   - Root cause B: –Ω–µ –∏–∑—É—á–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ (getChatHistory –ø–∞—Ç—Ç–µ—Ä–Ω)
   - –†–µ—à–µ–Ω–∏–µ: —á–µ–∫-–ª–∏—Å—Ç "–ü–æ—Å–ª–µ spike search" + –ü—Ä–∞–≤–∏–ª–æ 0 (Grep/Read –ü–ï–†–ï–î –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º)

4. **–ü—Ä–æ–ø—É—â–µ–Ω Code Review –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏** (2025-12-12) ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
   - Root cause: —Å–ª–æ–∂–Ω–æ –æ—Ç–ª–æ–≤–∏—Ç—å "–Ω–æ–≤—ã–π –¥–µ–Ω—å" vs "–Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è"
   - –†–µ—à–µ–Ω–∏–µ: –≤–æ–ø—Ä–æ—Å –≤ /endtask + /endsession "–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?" ‚Üí –ø—Ä–æ–º–ø—Ç —Å Code Review

## –í—ã–≤–æ–¥—ã

### –†–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ—Ü–µ—Å—Å—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã):
- ‚úÖ **Research-First** ‚Äî spike —Ç–µ—Å—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è External APIs, 100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–∞–≥–∏
- ‚úÖ **Mock —Ç–æ–ª—å–∫–æ boundaries** ‚Äî –ø—Ä–∞–≤–∏–ª–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ —Å–Ω–∏–∑–∏–ª–æ—Å—å
- ‚úÖ **TSan** ‚Äî race conditions –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –î–û production (MockLogger NSLock fix)
- ‚úÖ **Architecture-First** ‚Äî concurrency –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ, 0 —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–≤
- ‚úÖ **Code Review** ‚Äî overnight pause –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã, –∫—É–ª—å—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è:
- ‚ö†Ô∏è **–ß–µ–∫-–ª–∏—Å—Ç "–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤–µ—Ä—Å–∏–∏"** ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, User Story –ø—Ä–æ–ø—É—â–µ–Ω
- ‚ö†Ô∏è **–ü—Ä–∞–≤–∏–ª–æ "–ò–∑—É—á–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ü–ï–†–ï–î –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º"** ‚Äî –Ω–∞—Ä—É—à–µ–Ω–æ, –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–¥–µ–ª–æ–∫
- ‚ö†Ô∏è **Code Review —Ç—Ä–∏–≥–≥–µ—Ä** ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏, –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ —è–≤–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
- ‚ö†Ô∏è **TDD —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫** ‚Äî –ø–æ–ø—ã—Ç–∫–∞ Component Test –ë–ï–ó Unit Test, —á–µ–∫-–ª–∏—Å—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–≥–∏–π

## –ù–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è v0.5.0

1. **ROLES.md ‚Äî Planning Architect:**
   - –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ v0.X.0: User Story ‚Üí Spike research ‚Üí Architecture-First ‚Üí RFC ‚Üí –ø–µ—Ä–µ–¥–∞—Ç—å –≤ TDD

2. **ROLES.md ‚Äî Testing Architect (–ø—Ä–∏–µ–º–∫–∞ –∑–∞–¥–∞—á–∏):**
   - Gating: User Story –µ—Å—Ç—å? Spike research –≤—ã–ø–æ–ª–Ω–µ–Ω? –ï—Å–ª–∏ –ù–ï–¢ ‚Üí –≤–µ—Ä–Ω—É—Ç—å –≤ Planning

3. **CLAUDE.md ‚Äî –ü—Ä–∞–≤–∏–ª–æ 0:**
   - Grep/Read –ø–æ—Ö–æ–∂–∏–π –∫–æ–¥ –ü–ï–†–ï–î –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º ‚Üí —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω

4. **TESTING.md ‚Äî —á–µ–∫-–ª–∏—Å—Ç "–ü–æ—Å–ª–µ spike search":**
   - –ü–æ—Å–ª–µ spike ‚Üí –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ TDD: E2E –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí Unit Test –º–æ–¥–µ–ª–∏ ‚Üí Component Test

5. **Code Review —Ç—Ä–∏–≥–≥–µ—Ä:**
   - /endtask + /endsession: "–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è?" ‚Üí –ø—Ä–æ–º–ø—Ç —Å Code Review
   - CLAUDE.md: –µ—Å–ª–∏ –ø—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "Code Review" ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ü–ï–†–ï–î –¥—Ä—É–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è v0.5.0

**–û—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
1. Research-First: 100% ‚úÖ
2. Mock —Ç–æ–ª—å–∫–æ boundaries: 100% ‚úÖ
3. TSan: race conditions –Ω–∞–π–¥–µ–Ω—ã –î–û production ‚úÖ
4. Code Review: 100% (–∫–æ–≥–¥–∞ –ø—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "Code Review") üÜï
5. User Story + spike research –î–û TDD: 100% üÜï
6. –ú–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ Unit Test –î–û Component Test: 100% üÜï
7. –ü—Ä–∞–≤–∏–ª–æ 0 –ø—Ä–∏–º–µ–Ω–µ–Ω–æ (–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ) üÜï

**–£–±—Ä–∞—Ç—å –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
- –î—É–±–ª–∏–∫–∞—Ç—ã —Ç–∏–ø–æ–≤ (–ø—Ä–∞–≤–∏–ª–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –¥–≤–∞ —Ä–µ–ª–∏–∑–∞ –ø–æ–¥—Ä—è–¥ 0%)
- –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–µ–±–∞–≥–∞ (–ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞, –¥–≤–∞ —Ä–µ–ª–∏–∑–∞ –ø–æ–¥—Ä—è–¥ 0 –Ω–∞—Ä—É—à–µ–Ω–∏–π)

## –ó–∞–¥–∞—á–∏

- [ ] –û–±–Ω–æ–≤–∏—Ç—å ROLES.md (Planning Architect + Testing Architect gating)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md (–ü—Ä–∞–≤–∏–ª–æ 0 + Code Review —Ç—Ä–∏–≥–≥–µ—Ä)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å TESTING.md (—á–µ–∫-–ª–∏—Å—Ç "–ü–æ—Å–ª–µ spike search")
- [ ] –û–±–Ω–æ–≤–∏—Ç—å /endtask + /endsession (Code Review —Ç—Ä–∏–≥–≥–µ—Ä)
- [ ] –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω retro-v0.5.0-questions.md
- [ ] –ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É —Ä–µ—Ç—Ä–æ –≤ TASKS.md

**–ò—Ç–æ–≥:** v0.4.0 ‚Äî –≤—Å–µ —Ü–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã üéâ, –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç! –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∏—è —á–µ–∫-–ª–∏—Å—Ç–æ–≤ –∏ –ø—Ä–∞–≤–∏–ª–∞ "–∏–∑—É—á–∏ –∫–æ–¥ –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º". –°–ª–µ–¥—É—é—â–∞—è –≤–µ—Ä—Å–∏—è (v0.5.0) ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–≤–æ–¥—ã —Ä–µ—Ç—Ä–æ ‚Üí –º–µ–Ω—å—à–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤.
