# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

## –ü—Ä–∞–≤–∏–ª–æ (–ù–ï–°–ù–ò–ú–ê–ï–ú–û–ï –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–µ—Ä–∞

–°–æ–∑–¥–∞–π `/tmp/tg_token_tracker.json` —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```json
{
  "session_id": "<—Ç–µ–∫—É—â–∏–π session_id –∏–∑ /usage>",
  "total_budget": 200000,
  "real_usage_percent": <–ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑ /usage>,
  "last_sync_message_count": 0,
  "current_message_count": 0,
  "sync_interval": 3,
  "warning_threshold": 80,
  "critical_threshold": 90,
  "last_sync_time": "<ISO timestamp>"
}
```

### 2. Workflow –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**–ü–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û –º–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
1. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–π `current_message_count` –≤ —Ç—Ä–µ–∫–µ—Ä–µ
2. –ï—Å–ª–∏ `(current_message_count - last_sync_message_count) >= sync_interval`:
   - –í –ö–û–ù–¶–ï –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å —Å—Ç—Ä–æ–∫—É: `üìä Sync: –≤—ã–∑–æ–≤–∏ /usage, –ø—Ä–∏—à–ª–∏ %`
   - –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –¥–∏–∞–ª–æ–≥, –ù–ï –±–ª–æ–∫–∏—Ä—É–π —Ä–∞–±–æ—Ç—É
3. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä "57"):
   - –û–±–Ω–æ–≤–∏ `real_usage_percent`
   - –û–±–Ω–æ–≤–∏ `last_sync_message_count = current_message_count`
   - –ü—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–±–æ—Ç—É –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

**–í –ö–û–ù–¶–ï –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–≤—Å–µ–≥–¥–∞):**
```
üìä –¢–æ–∫–µ–Ω—ã: ~X% (sync: Y%, Z msg ago) | –î–æ 80%: ~A msg | –î–æ 90%: ~B msg
```

–ì–¥–µ:
- `X%` = –æ—Ü–µ–Ω–∫–∞ (real_usage_percent + –ø—Ä–∏–º–µ—Ä–Ω–æ 1% –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ sync)
- `Y%` = –ø–æ—Å–ª–µ–¥–Ω–∏–π real_usage_percent
- `Z` = current_message_count - last_sync_message_count
- `A msg` = –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ 80%
- `B msg` = –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ 90%

### 3. –ê–ª–µ—Ä—Ç—ã

- **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 75%:** –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏: `‚ö†Ô∏è –ü—Ä–∏–±–ª–∏–∂–∞–µ–º—Å—è –∫ –ª–∏–º–∏—Ç—É 80%. –†–µ–∫–æ–º–µ–Ω–¥—É—é –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É.`
- **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 85%:** –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏: `üö® –ö—Ä–∏—Ç–∏—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å! –î–æ 90% –æ—Å—Ç–∞–ª–æ—Å—å –º–∞–ª–æ. –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É?`
- **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 90%:** `üõë –°–¢–û–ü! 90% –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é.`

### 4. –û—Ü–µ–Ω–∫–∞ —Ä–∞—Å—Ö–æ–¥–∞ —Ç–æ–∫–µ–Ω–æ–≤

–ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –Ω–∞ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–ª—è –æ—Ü–µ–Ω–∫–∏):
- –ü—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –±–µ–∑ tool calls: ~1-2%
- –û—Ç–≤–µ—Ç —Å 1-2 tool calls: ~2-3%
- –û—Ç–≤–µ—Ç —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ tool calls / –±–æ–ª—å—à–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏: ~3-5%

### 5. –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–ö–æ–≥–¥–∞ –ø–æ—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**
```
üìä Sync: –≤—ã–∑–æ–≤–∏ /usage, –ø—Ä–∏—à–ª–∏ %
```

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç:**
```
57
```

**–Ø –æ–±–Ω–æ–≤–ª—è—é —Ç—Ä–µ–∫–µ—Ä –∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é —Ä–∞–±–æ—Ç—É –ë–ï–ó –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.**

---

## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–≤—ã–ø–æ–ª–Ω–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∫–æ–º–∞–Ω–¥—ã)

1. –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–∑–≤–∞—Ç—å `/usage` –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑ "Current session"
2. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ - —Å–æ–∑–¥–∞–π `/tmp/tg_token_tracker.json`
3. –°–∫–∞–∂–∏: "‚úÖ –¢—Ä–µ–∫–∏–Ω–≥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ë—É–¥—É –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å sync –∫–∞–∂–¥—ã–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è."
4. –ù–∞—á–∏–Ω–∞–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å –≠–¢–û–ì–û –º–æ–º–µ–Ω—Ç–∞

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ (–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞):**
```bash
jq '.current_message_count += 1' /tmp/tg_token_tracker.json > /tmp/tg_token_tracker.json.tmp && mv /tmp/tg_token_tracker.json.tmp /tmp/tg_token_tracker.json
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ sync:**
```bash
current=$(jq '.current_message_count' /tmp/tg_token_tracker.json)
last_sync=$(jq '.last_sync_message_count' /tmp/tg_token_tracker.json)
interval=$(jq '.sync_interval' /tmp/tg_token_tracker.json)
delta=$((current - last_sync))
if [ $delta -ge $interval ]; then
  echo "–ù—É–∂–µ–Ω sync"
fi
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```bash
new_percent=<—á–∏—Å–ª–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>
jq --arg percent "$new_percent" '.real_usage_percent = ($percent | tonumber) | .last_sync_message_count = .current_message_count | .last_sync_time = now | strftime("%Y-%m-%dT%H:%M:%S")' /tmp/tg_token_tracker.json > /tmp/tg_token_tracker.json.tmp && mv /tmp/tg_token_tracker.json.tmp /tmp/tg_token_tracker.json
```

---

## –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

**–°–æ–æ–±—â–µ–Ω–∏–µ 1:**
```
[–ú–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–¥–∞—á—É]

üìä –¢–æ–∫–µ–Ω—ã: ~54% (sync: 53%, 1 msg ago) | –î–æ 80%: ~26 msg | –î–æ 90%: ~36 msg
```

**–°–æ–æ–±—â–µ–Ω–∏–µ 2:**
```
[–ú–æ–π –æ—Ç–≤–µ—Ç]

üìä –¢–æ–∫–µ–Ω—ã: ~55% (sync: 53%, 2 msg ago) | –î–æ 80%: ~25 msg | –î–æ 90%: ~35 msg
```

**–°–æ–æ–±—â–µ–Ω–∏–µ 3:**
```
[–ú–æ–π –æ—Ç–≤–µ—Ç]

üìä –¢–æ–∫–µ–Ω—ã: ~56% (sync: 53%, 3 msg ago) | –î–æ 80%: ~24 msg | –î–æ 90%: ~34 msg
üìä Sync: –≤—ã–∑–æ–≤–∏ /usage, –ø—Ä–∏—à–ª–∏ %
```

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** `58`

**–°–æ–æ–±—â–µ–Ω–∏–µ 4:**
```
[–ú–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É]

üìä –¢–æ–∫–µ–Ω—ã: ~59% (sync: 58%, 1 msg ago) | –î–æ 80%: ~22 msg | –î–æ 90%: ~32 msg
```
