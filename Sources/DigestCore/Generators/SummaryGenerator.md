# Generate AI Summary

Генерация краткого саммари непрочитанных сообщений через OpenAI API.

## User Story

Как пользователь, я хочу получать AI-саммари непрочитанных сообщений из Telegram каналов в удобном формате для быстрого ознакомления с контентом.

**Ожидаемое поведение:**
- Успешный сценарий: Краткое саммари в Telegram Markdown с группировкой по каналам, эмодзи для категорий, ссылками на оригинальные сообщения. Максимальная длина 4096 символов (лимит Telegram Bot API)
- Пустой результат: Если передан пустой массив сообщений — возвращается пустая строка или информационное сообщение "Нет новых сообщений"
- Ошибки:
  - `401 Unauthorized` — неверный API key (критическая ошибка, не ретраим)
  - `429 Rate Limit` — превышен лимит запросов (retry с exponential backoff)
  - `500-503 Server Error` — проблемы на стороне OpenAI (retry до 3 попыток)
  - `504 Timeout` — таймаут запроса (retry)
  - Парсинг ответа — если ответ пустой или некорректный JSON

## Официальная документация

- [OpenAI Chat API Reference](https://platform.openai.com/docs/api-reference/chat) — Chat Completions endpoint
- [OpenAI Models](https://platform.openai.com/docs/models) — доступные модели и цены
- [OpenAI Error Codes](https://platform.openai.com/docs/guides/error-codes) — обработка ошибок API

## Предусловия

- `.env` файл с `OPENAI_API_KEY` (см. `.env.example`)
- Массив `SourceMessage` с непрочитанными сообщениями (не пустой)
- Каждое сообщение содержит: `channelTitle`, `content`, `link` (может быть `nil` для приватных каналов)

## Шаги

1. **Форматирование промпта на русском языке**
   - System message: правила создания дайджеста (группировка по каналам, Telegram Markdown, лимит 3800 символов)
   - User message: список сообщений с указанием канала и содержимого
   - **Результат:** Структурированный запрос к OpenAI API

2. **HTTP запрос к OpenAI Chat API**
   - Модель: `gpt-3.5-turbo` (стоимость ~$0.006 за дайджест из 100 сообщений)
   - **Результат:** JSON ответ с саммари или ошибка API

3. **Парсинг ответа**
   - Извлечение текста саммари
   - Проверка корректности (finish_reason, длина)
   - **Результат:** Текст саммари

4. **Обрезка до лимита Telegram**
   - Проверка длины (максимум 4096 символов)
   - Если больше — обрезать по границе предложения
   - **Результат:** Финальное саммари для отправки в Telegram

## Как проверить сценарий

**Запуск E2E теста:**

E2E тест будет запускаться ВРУЧНУЮ из Xcode после реализации (шаг 3):
1. Убедитесь что `OPENAI_API_KEY` настроен в `.env`
2. Откройте проект в Xcode
3. Найдите `SummaryGenerationE2ETests.swift`
4. Временно уберите `.disabled()` из `@Test` атрибута
5. Запустите тест через Xcode UI

**Что будет проверять тест:**
1. Получение реальных непрочитанных сообщений через `ChannelMessageSource`
2. Генерация саммари через `SummaryGenerator` с реальным OpenAI API
3. Проверка формата ответа: группировка по каналам, ссылки, лимит 4096 символов, Telegram Markdown
4. Логирование токенов (prompt_tokens, completion_tokens, total_tokens)

**Ожидаемый результат:**
- Тест проходит успешно ✅
- В логах: "Generated summary: N characters, M tokens used"
- Саммари содержит эмодзи, группировку по каналам, ссылки

## E2E тест

**Местоположение:** `Tests/TgClientE2ETests/SummaryGenerationE2ETests.swift` (будет создан на шаге 3)

Автоматизированный E2E сценарий с реальным OpenAI API. Проверяет полный цикл:
- Получение непрочитанных сообщений из Telegram
- Генерация AI-саммари через OpenAI
- Проверка формата и структуры ответа

## Компонентный тест

Компонентный тест будет создан на шаге 5 с реальным HTTP запросом к OpenAI API.
