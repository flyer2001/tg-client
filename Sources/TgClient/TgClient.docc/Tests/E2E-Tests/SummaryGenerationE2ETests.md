# E2E: Генерация AI-дайджеста

## Описание

E2E тест для сценария генерации AI-дайджеста из непрочитанных сообщений.

**User Story:** Получить AI-дайджест непрочитанных сообщений из Telegram каналов
с группировкой по каналам, ссылками на сообщения и соблюдением лимита Telegram.

**Сценарий:** <doc:SummaryGenerator>

**Предусловия:**
- Переменная окружения `OPENAI_API_KEY` настроена
- OpenAI API доступен (gpt-3.5-turbo)

**ПРИМЕЧАНИЕ:** E2E тест использует реальный OpenAI API и потребляет токены (~$0.006 за прогон).
Запускайте вручную из Xcode по необходимости.

**Ссылки:**
- Spike: `.claude/archived/spike-openai-api-2025-12-03.md`
- DocC: `Sources/DigestCore/Generators/SummaryGenerator.md`

**Тип теста:** E2E

**Исходный код:** [`Tests/TgClientE2ETests/SummaryGenerationE2ETests.swift`](https://github.com/flyer2001/tg-client/blob/main/Tests/TgClientE2ETests/SummaryGenerationE2ETests.swift)

## Тестовые сценарии

### Генерация дайджеста через OpenAI API", .disabled("E2E: требует OPENAI_API_KEY, запускать вручную

E2E тест: генерация дайджеста через реальный OpenAI API.

**Что тестируем:**
- Интеграцию с OpenAI API (gpt-3.5-turbo)
- Группировку сообщений по каналам
- Генерацию ссылок на сообщения (для публичных каналов)
- Соблюдение лимита 4096 символов (Telegram)
- Формат Telegram Markdown (экранирование, ссылки)
- Логирование использования токенов (prompt_tokens, completion_tokens)

**Тестовые данные:** 3 сообщения из 2 каналов (1 публичный, 1 приватный)

**Проверки:**
- Дайджест не пустой
- Длина ≤ 4096 символов
- Содержит заголовки обоих каналов
- Для публичного канала есть ссылки на сообщения
- Для приватного канала НЕТ ссылок

**⚠️ SwiftPM bug fixed:** Откат на Swift 6.0 решил проблему incremental builds.
Тест требует OPENAI_API_KEY в .env файле.

**⚠️ Disabled для CI:** E2E тест использует реальный API ($), запускается вручную.

0. Загрузка .env файла (для получения OPENAI_API_KEY)

1. Тестовые данные: 3 сообщения из 2 каналов (на русском языке)

2. Setup logger

3. Проверка OPENAI_API_KEY

4. Создание SummaryGenerator с реальным HTTP клиентом

5. Генерация дайджеста через реальный OpenAI API

6. Базовые проверки результата

7. Проверка группировки по каналам

Дайджест должен содержать заголовки обоих каналов

8. Проверка ссылок на сообщения (для публичных каналов)

⚠️ TODO: OpenAI не всегда включает ссылки (зависит от промпта/модели)

См. BACKLOG: улучшить генерацию ссылок (отдельные саммари per chat или post-processing)

9. Для приватного канала не должно быть ссылок

Проверяем что chatId не попал в итоговый текст

---


## Topics

### Связанная документация

- <doc:TgClient>
