# ``TgClient``

CLI-клиент Telegram для получения саммари непрочитанных сообщений через AI.

Эта документация предназначена для разработчиков. В проекте реализован подход TDD — тесты являются основным источником правды и документации.

> **Документация актуальна для релиза v0.2.0**
>
> **Скачать последнюю версию:** [GitHub Releases](https://github.com/flyer2001/tg-client/releases)

## Topics

### Пользовательские (E2E) сценарии

- <doc:Authentication>
- <doc:FetchUnreadMessages>

### Аудит безопасности

#### Шифрование локальной базы данных

TDLib использует **SQLCipher** для шифрования локальной базы данных на **macOS** и **Linux**.

**Что хранится в базе данных:**
- Сессия авторизации (токены доступа)
- Скачанные сообщения из чатов (текущая конфигурация: кэширование включено)
- Информация о чатах и пользователях
- Кэшированные медиафайлы

**Ключ шифрования:**
- Передаётся через переменную окружения `TDLIB_ENCRYPTION_KEY`
- Должен быть сгенерирован криптографически стойким генератором (32+ символа)
- **НЕ КОММИТИТЬ в git** — использовать `.env` (файл в `.gitignore`)

**Путь к базе данных:**
- macOS: `~/.tdlib/` (по умолчанию)
- Linux: `~/.tdlib/` (или путь из переменной окружения `TDLIB_DATABASE_DIRECTORY`)

**Рекомендации:**
- Ограничьте права доступа к директории БД: `chmod 700 ~/.tdlib`
- Регулярно делайте ротацию ключа шифрования (удалить старую БД, сгенерировать новый ключ)

#### Безопасность авторизации

**Код проекта открыт** — вы можете убедиться что:
- ✅ OTP код авторизации **не пересылается** никуда кроме официальных серверов Telegram
- ✅ Пароль 2FA **не сохраняется** и передаётся только в TDLib
- ✅ Все сетевые запросы идут через официальный TDLib API (Telegram серверы)

**Исходный код для проверки:**
- Входная точка авторизации: [`Sources/App/main.swift`](https://github.com/flyer2001/tg-client/blob/main/Sources/App/main.swift)
- Обработка состояний авторизации: [`Sources/TDLibAdapter/TDLibClient.swift:224`](https://github.com/flyer2001/tg-client/blob/main/Sources/TDLibAdapter/TDLibClient.swift#L224) (метод `processAuthorizationStates`)

**Уведомление об авторизации:**
- При первой авторизации вы получите уведомление в официальном Telegram клиенте
- Вы увидите: платформу (macOS/Linux), **IP адрес сервера** (на котором запущен клиент), время авторизации
- **Можно завершить сессию** в любой момент через "Settings → Devices" в Telegram

**Отзыв доступа:**

Если вы хотите отозвать доступ к этому клиенту:
1. Откройте официальный Telegram клиент
2. Settings → Privacy and Security → Active Sessions
3. Найдите сессию "TgClient (macOS/Linux)" и завершите её

После отзыва сессии клиент перестанет работать до повторной авторизации.

#### Безопасность данных (сообщения)

**Скачанные сообщения:**
- Хранятся **только в памяти** во время работы приложения (массив `[SourceMessage]`)
- **НЕ сохраняются** на диск (кроме кэша TDLib в зашифрованной БД)
- **НЕ отправляются** на внешние серверы

**Исходный код для проверки:**
- Получение сообщений: [`Sources/DigestCore/Sources/ChannelMessageSource.swift:70`](https://github.com/flyer2001/tg-client/blob/main/Sources/DigestCore/Sources/ChannelMessageSource.swift#L70) (метод `fetchUnreadMessages`)

#### Управление секретами

**Переменные окружения:**
- `TELEGRAM_API_ID` — получить на [my.telegram.org](https://my.telegram.org/apps)
- `TELEGRAM_API_HASH` — получить там же
- `TDLIB_ENCRYPTION_KEY` — сгенерировать: `openssl rand -hex 32`

**Хранение:**
- Локальная разработка: `.env` файл (в `.gitignore`)
- Production (Linux systemd): переменные окружения в unit-файле службы

#### Рекомендации по безопасности

1. **Регулярно проверяйте активные сессии** в официальном Telegram клиенте (Settings → Privacy and Security → Active Sessions)
2. **Используйте сильный ключ шифрования БД** — минимум 32 случайных символа (`openssl rand -hex 32`)
3. **Не передавайте `.env` файл третьим лицам** — он содержит API ключи и ключ шифрования БД
4. **При компрометации ключа шифрования:**
   - Завершите сессию в Telegram (Settings → Active Sessions)
   - Сгенерируйте новый ключ: `openssl rand -hex 32`
   - Удалите старую БД: `rm -rf ~/.tdlib`
   - Повторно авторизуйтесь с новым ключом
5. **На production серверах** ограничьте доступ к директории БД: `chmod 700 ~/.tdlib`

### Навигация по документации

Документация построена по принципу **Outside-In** — от пользовательских сценариев к деталям реализации:

1. **E2E сценарии** — описание того, что видит пользователь (user stories)
2. **Component тесты** — проверка работы модулей (TDLibClient, ChannelMessageSource, etc.)
3. **Unit тесты** — тестирование моделей (Request/Response) и вспомогательных компонентов

Каждый E2E сценарий содержит ссылки на Component тесты, которые в свою очередь ссылаются на Unit тесты используемых моделей.
