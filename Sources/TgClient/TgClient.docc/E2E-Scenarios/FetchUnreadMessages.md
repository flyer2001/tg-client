# Fetch Unread Messages

Получение непрочитанных сообщений из Telegram каналов для создания дайджеста.

## User Story

Как пользователь, я хочу получить список всех непрочитанных сообщений из подписанных Telegram каналов, чтобы создать AI-дайджест и отправить его через бота.

**Ожидаемое поведение:**
- Успешный сценарий: Список непрочитанных сообщений из всех каналов (не в архиве) с текстом и ссылками
- Пустой результат: Если нет непрочитанных — дайджест не создаётся, логируется "No unread messages"
- Ошибки: Явное сообщение об ошибке на каждом этапе (недоступный канал, ошибка TDLib, etc.)

## Официальная документация

- [TDLib Getting Started](https://core.telegram.org/tdlib/getting-started) — общий флоу работы с TDLib
- [TDLib Chat Methods](https://core.telegram.org/tdlib/docs/annotated.html) — методы для работы с чатами

## Предусловия

- Пользователь авторизован в TDLib (`authorizationStateReady`)
- `.env` файл с настройками (см. `.env.example`)
- У пользователя есть подписки на Telegram каналы
- В некоторых каналах есть непрочитанные сообщения

## Шаги

1. **Получение и фильтрация списка каналов с непрочитанными**
   - **Результат:** Список каналов (не в архиве) с `unreadCount > 0`
   - **Ошибки:** Ошибка TDLib (timeout, internal error) → прерываем выполнение

2. **Получение текста непрочитанных сообщений**
   - **Результат:** Для каждого канала: текст сообщений + ссылки (если канал публичный)
   - **Ошибки:**
     - Канал недоступен (`CHAT_NOT_FOUND`) → пропускаем, логируем
     - Если все каналы недоступны → завершаем без дайджеста

**Примечание:** Отметка сообщений как прочитанных происходит ТОЛЬКО после успешной отправки дайджеста (выполняется DigestOrchestrator).

## Как проверить сценарий

**Запуск:**
```bash
# Будет реализовано в MVP-5 (DigestOrchestrator)
swift run tg-client digest on-demand --dry-run
```

**Что проверяем:**
1. Клиент получает список каналов и выводит их названия
2. Для каждого канала с непрочитанными — выводит количество сообщений
3. Формирует ссылки на сообщения (для публичных каналов)
4. Если нет непрочитанных — выводит "No unread messages" и завершается с кодом 0
5. При ошибках — выводит явное сообщение и код ошибки

**Ожидаемый результат:** Список непрочитанных сообщений из всех каналов (или сообщение об их отсутствии)

## E2E тест

**Местоположение:** `Tests/TgClientE2ETests/FetchUnreadMessagesScenarioTests.swift`

Автоматизированный E2E сценарий с реальным TDLib клиентом. Проверяет полный цикл:
- Подключение к Telegram (используется сохранённая сессия)
- Получение списка непрочитанных сообщений
- Проверка структуры данных (chatId, messageId, content)

## Компонентные тесты

_(TODO: будут созданы при реализации MVP-1.6)_

- `ChannelMessageSourceTests` — основной компонентный тест
- `ChannelCacheTests` — тесты кэша каналов
- `UpdatesHandlerTests` — тесты обработчика updates
