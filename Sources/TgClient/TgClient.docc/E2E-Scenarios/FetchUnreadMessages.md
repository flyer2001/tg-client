# Fetch Unread Messages

Получение непрочитанных сообщений из Telegram каналов.

## User Story

Как пользователь, я хочу получить список всех непрочитанных сообщений из подписанных Telegram каналов для дальнейшей обработки.

**Ожидаемое поведение:**
- Успешный сценарий: Список непрочитанных сообщений из всех каналов (не в архиве) с текстом и ссылками
- Пустой результат: Если нет непрочитанных — возвращается пустой массив, логируется "No unread messages"
- Ошибки: Явное сообщение об ошибке на каждом этапе (недоступный канал, ошибка TDLib, etc.)

## Официальная документация

- [TDLib Getting Started](https://core.telegram.org/tdlib/getting-started) — общий флоу работы с TDLib
- [TDLib Chat Methods](https://core.telegram.org/tdlib/docs/annotated.html) — методы для работы с чатами

## Предусловия

- Пользователь авторизован в TDLib (`authorizationStateReady`)
- `.env` файл с настройками (см. `.env.example`)
- У пользователя есть подписки на Telegram каналы
- В некоторых каналах есть непрочитанные сообщения

## Шаги

1. **Получение и фильтрация списка каналов с непрочитанными**
   - **Результат:** Список каналов (не в архиве) с `unreadCount > 0`
   - **Ошибки:** Ошибка TDLib (timeout, internal error) → прерываем выполнение

2. **Получение текста непрочитанных сообщений**
   - **Результат:** Для каждого канала: текст сообщений + ссылки (если канал публичный)
   - **Ошибки:**
     - Канал недоступен (`CHAT_NOT_FOUND`) → пропускаем, логируем
     - Если все каналы недоступны → завершаем без дайджеста

## Как проверить сценарий

**Запуск E2E теста:**

E2E тест запускается ВРУЧНУЮ из Xcode:
1. Убедитесь что вы авторизованы (запустите `swift run tg-client` если нет)
2. Откройте проект в Xcode
3. Найдите `FetchUnreadMessagesScenarioTests.swift`
4. Временно уберите `.disabled()` из `@Test` атрибута
5. Запустите тест через Xcode UI

**Что проверяет тест:**
1. Подключение к Telegram (используется сохранённая сессия из `~/.tdlib/`)
2. Получение списка каналов с непрочитанными сообщениями
3. Фильтрация: только каналы (не группы), только с `unreadCount > 0`
4. Получение текста сообщений через `getChatHistory`
5. Формирование ссылок на сообщения (для публичных каналов)
6. Проверка структуры данных (chatId, messageId, content)

**Ожидаемый результат:**
- Тест проходит успешно ✅
- В логах: "Fetched N unread messages from M channels" (или "No unread messages found" если нет непрочитанных)

## E2E тест

**Местоположение:** `Tests/TgClientE2ETests/FetchUnreadMessagesScenarioTests.swift`

Автоматизированный E2E сценарий с реальным TDLib клиентом. Проверяет полный цикл:
- Подключение к Telegram (используется сохранённая сессия)
- Получение списка непрочитанных сообщений
- Проверка структуры данных (chatId, messageId, content)

## Компонентный тест

<doc:ChannelMessageSourceTests>
