# Fetch Unread Messages

Получение непрочитанных сообщений из Telegram каналов для создания дайджеста.

## User Story

Как пользователь, я хочу получить список всех непрочитанных сообщений из подписанных Telegram каналов, чтобы создать AI-дайджест и отправить его через бота.

**Ожидаемое поведение:**
- Успешный сценарий: Список непрочитанных сообщений из всех каналов (не в архиве) с текстом и ссылками
- Пустой результат: Если нет непрочитанных — дайджест не создаётся, логируется "No unread messages"
- Ошибки: Явное сообщение об ошибке на каждом этапе (недоступный канал, ошибка TDLib, etc.)

## Официальная документация

- [TDLib Getting Started](https://core.telegram.org/tdlib/getting-started) — общий флоу работы с TDLib
- [TDLib Chat Methods](https://core.telegram.org/tdlib/docs/annotated.html) — методы для работы с чатами

## Предусловия

- Пользователь авторизован в TDLib (`authorizationStateReady`)
- `.env` файл с настройками (см. `.env.example`)
- У пользователя есть подписки на Telegram каналы
- В некоторых каналах есть непрочитанные сообщения

## Шаги

1. **Получение списка чатов** — Запрос всех чатов из основного списка (не архив)
   - **Ввод:** Параметры: `chatList: .main`, `limit: 100`
   - **Результат:** Список ID чатов с метаданными (тип, название, счётчик непрочитанных)
   - **Ошибки:** Ошибка TDLib (timeout, internal error)

2. **Фильтрация каналов** — Отбор только каналов с непрочитанными
   - **Ввод:** Список чатов из шага 1
   - **Результат:** Отфильтрованный список: только каналы (`type == channel`) с `unreadCount > 0`
   - **Ошибки:** Если нет подходящих каналов → успешное завершение без дайджеста

3. **Получение сообщений из каждого канала** — Запрос истории для каждого канала
   - **Ввод:** `chatId`, `unreadCount`, `lastReadInboxMessageId`
   - **Результат:** Список непрочитанных сообщений (текст + ID)
   - **Ошибки:** Канал недоступен (`CHAT_NOT_FOUND`) → пропускаем, логируем

4. **Формирование ссылок** — Создание кликабельных ссылок на сообщения
   - **Ввод:** `chatId`, `messageId`, `username` канала (если есть)
   - **Результат:** Публичный канал → `https://t.me/{username}/{messageId}`, приватный → "Private channel"
   - **Ошибки:** Нет ошибок (для приватных каналов ссылка не создаётся)

5. **Отметка как прочитанное** _(опциональный, только после успешной отправки дайджеста)_
   - **Ввод:** `chatId`, список `messageIds`
   - **Результат:** Сообщения отмечены как прочитанные на сервере Telegram
   - **Ошибки:** Ошибка TDLib → логируем, но не прерываем работу

## Как проверить сценарий

**Запуск:**
```bash
# Будет реализовано в MVP-5 (DigestOrchestrator)
swift run tg-client digest on-demand --dry-run
```

**Что проверяем:**
1. Клиент получает список каналов и выводит их названия
2. Для каждого канала с непрочитанными — выводит количество сообщений
3. Формирует ссылки на сообщения (для публичных каналов)
4. Если нет непрочитанных — выводит "No unread messages" и завершается с кодом 0
5. При ошибках — выводит явное сообщение и код ошибки

**Ожидаемый результат:** Список непрочитанных сообщений из всех каналов (или сообщение об их отсутствии)

## Компонентный тест

<doc:GetChatsTests> _(TODO: будет создан на следующем шаге TDD)_
