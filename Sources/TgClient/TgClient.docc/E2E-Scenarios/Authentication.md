# Authentication

Авторизация пользователя в Telegram через TDLib.

## User Story

Как пользователь, я хочу авторизоваться в Telegram клиенте под своей учётной записью, введя свой номер телефона и код подтверждения (и пароль 2FA при необходимости), чтобы получить доступ к своим чатам и сообщениям.

**Ожидаемое поведение:**
- Успешный сценарий: Сообщение "Authorization successful" и переход в состояние `authorizationStateReady`
- Ошибки: Явное сообщение об ошибке на каждом этапе (неверный номер, код, пароль, или внутренняя ошибка TDLib)

## Официальная документация

- [TDLib Authorization](https://core.telegram.org/tdlib/getting-started#initialization) — флоу инициализации и авторизации
- [Telegram Two-Step Verification](https://core.telegram.org/api/srp) — документация по 2FA

## Предусловия

- `.env` файл с настройками (см. `.env.example`)
- Конфигурация: `api_id`, `api_hash`, `encryption_key`, `tdlib_path` должны быть установлены до начала авторизации

## Шаги

1. **Инициализация TDLib** — Установка параметров и ключа шифрования БД
   - **Ввод:** Параметры из конфигурации (`api_id`, `api_hash`, `database_directory`)
   - **Результат:** TDLib переходит в состояние `authorizationStateWaitPhoneNumber`
   - **Ошибки:** Ошибка инициализации TDLib (неверные параметры, проблемы с БД)

2. **Ввод номера телефона** — Пользователь вводит номер в формате `+1234567890`
   - **Ввод:** Номер телефона (например, `+79991234567`)
   - **Результат:** Telegram отправляет код подтверждения, переход в `authorizationStateWaitCode`
   - **Ошибки:** `PHONE_NUMBER_INVALID` (неверный формат), `FLOOD_WAIT` (слишком много попыток)

3. **Ввод кода подтверждения** — Пользователь вводит код из SMS/Telegram
   - **Ввод:** Код (например, `12345`)
   - **Результат:** Успешная авторизация → `authorizationStateReady` (если нет 2FA)
   - **Ошибки:** `PHONE_CODE_INVALID` (неверный код), переход к шагу 4 если включена 2FA

4. **Ввод пароля 2FA** _(опциональный, только если у пользователя включена двухфакторная аутентификация)_
   - **Ввод:** Пароль 2FA
   - **Результат:** Успешная авторизация → `authorizationStateReady`
   - **Ошибки:** `PASSWORD_HASH_INVALID` (неверный пароль)

## Как проверить сценарий

**Запуск:**
```bash
# Очистить БД для чистого теста (опционально)
rm -rf ~/.tdlib/*

# Запустить клиент
swift run tg-client

# Следовать инструкциям в консоли:
# 1. Ввести номер телефона
# 2. Ввести код из Telegram
# 3. (Если требуется) Ввести пароль 2FA
```

**Что проверяем:**
1. Клиент запрашивает номер телефона
2. После ввода номера — запрашивает код подтверждения
3. (Опционально) Если включена 2FA — запрашивает пароль
4. После успешной авторизации — выводит "Authorization successful"
5. При ошибках — выводит явное сообщение (например, "Invalid phone number" или "Invalid code")

**Ожидаемый результат:** Сообщение "Authorization successful" и клиент готов к работе

## Компонентный тест

<doc:AuthenticationFlowTests>
