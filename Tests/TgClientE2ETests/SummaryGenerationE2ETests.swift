import TgClientModels
import Foundation
import Testing
import Logging
@testable import DigestCore
@testable import TestHelpers

/// E2E —Ç–µ—Å—Ç –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI-–¥–∞–π–¥–∂–µ—Å—Ç–∞ –∏–∑ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
///
/// **User Story:** –ü–æ–ª—É—á–∏—Ç—å AI-–¥–∞–π–¥–∂–µ—Å—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram –∫–∞–Ω–∞–ª–æ–≤
/// —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –∫–∞–Ω–∞–ª–∞–º, —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ª–∏–º–∏—Ç–∞ Telegram.
///
/// **–°—Ü–µ–Ω–∞—Ä–∏–π:** <doc:SummaryGenerator>
///
/// **–ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è:**
/// - –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `OPENAI_API_KEY` –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
/// - OpenAI API –¥–æ—Å—Ç—É–ø–µ–Ω (gpt-3.5-turbo)
///
/// **–ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** E2E —Ç–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π OpenAI API –∏ –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã (~$0.006 –∑–∞ –ø—Ä–æ–≥–æ–Ω).
/// –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é –∏–∑ Xcode –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
///
/// **–°—Å—ã–ª–∫–∏:**
/// - Spike: `.claude/archived/spike-openai-api-2025-12-03.md`
/// - DocC: `Sources/DigestCore/Generators/SummaryGenerator.md`
@Suite("E2E: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI-–¥–∞–π–¥–∂–µ—Å—Ç–∞")
struct SummaryGenerationE2ETests {

    /// E2E —Ç–µ—Å—Ç: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ —Ä–µ–∞–ª—å–Ω—ã–π OpenAI API.
    ///
    /// **–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:**
    /// - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å OpenAI API (gpt-3.5-turbo)
    /// - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∫–∞–Ω–∞–ª–∞–º
    /// - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤)
    /// - –°–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ 4096 —Å–∏–º–≤–æ–ª–æ–≤ (Telegram)
    /// - –§–æ—Ä–º–∞—Ç Telegram Markdown (—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å—Å—ã–ª–∫–∏)
    /// - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (prompt_tokens, completion_tokens)
    ///
    /// **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:** 3 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ 2 –∫–∞–Ω–∞–ª–æ–≤ (1 –ø—É–±–ª–∏—á–Ω—ã–π, 1 –ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
    ///
    /// **–ü—Ä–æ–≤–µ—Ä–∫–∏:**
    /// - –î–∞–π–¥–∂–µ—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
    /// - –î–ª–∏–Ω–∞ ‚â§ 4096 —Å–∏–º–≤–æ–ª–æ–≤
    /// - –°–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ–±–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤
    /// - –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    /// - –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –ù–ï–¢ —Å—Å—ã–ª–æ–∫
    ///
    /// **‚ö†Ô∏è SwiftPM bug fixed:** –û—Ç–∫–∞—Ç –Ω–∞ Swift 6.0 —Ä–µ—à–∏–ª –ø—Ä–æ–±–ª–µ–º—É incremental builds.
    /// –¢–µ—Å—Ç —Ç—Ä–µ–±—É–µ—Ç OPENAI_API_KEY –≤ .env —Ñ–∞–π–ª–µ.
    @Test("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ OpenAI API")
    func generateSummaryThroughOpenAI() async throws {
        // 0. –ó–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞ (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è OPENAI_API_KEY)
        try? EnvFileLoader.loadDotEnv(from: ".env")

        // 1. –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: 3 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ 2 –∫–∞–Ω–∞–ª–æ–≤ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ)
        let messages = [
            SourceMessage(
                chatId: -1001234567890,
                messageId: 100,
                content: "–í—ã—à–µ–ª Swift 6.0 —Å –Ω–æ–≤—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ concurrency –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.",
                channelTitle: "Swift –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏",
                link: "https://t.me/swiftdev/100"
            ),
            SourceMessage(
                chatId: -1001234567890,
                messageId: 101,
                content: "–¢—É—Ç–æ—Ä–∏–∞–ª: —Å–æ–∑–¥–∞–Ω–∏–µ CLI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å ArgumentParser –∏ async/await.",
                channelTitle: "Swift –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏",
                link: "https://t.me/swiftdev/101"
            ),
            SourceMessage(
                chatId: -1009876543210,
                messageId: 200,
                content: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã: –∏–∑–º–µ–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ code review.",
                channelTitle: "–ö–æ–º–∞–Ω–¥–∞ –ü—Ä–æ–µ–∫—Ç–∞",
                link: nil
            )
        ]

        // 2. Setup logger
        let logger = Logger(label: "tg-client.e2e.summary")

        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ OPENAI_API_KEY
        guard let apiKey = ProcessInfo.processInfo.environment["OPENAI_API_KEY"],
              !apiKey.isEmpty else {
            Issue.record("‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ environment. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ .env —Ñ–∞–π–ª.")
            return
        }

        // 4. –°–æ–∑–¥–∞–Ω–∏–µ SummaryGenerator —Å —Ä–µ–∞–ª—å–Ω—ã–º HTTP –∫–ª–∏–µ–Ω—Ç–æ–º
        let httpClient = URLSessionHTTPClient()
        let generator = OpenAISummaryGenerator(apiKey: apiKey, httpClient: httpClient, logger: logger)

        // 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–π–¥–∂–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ —Ä–µ–∞–ª—å–Ω—ã–π OpenAI API
        let summary = try await generator.generate(messages: messages)

        // 6. –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        #expect(!summary.isEmpty, "–î–∞–π–¥–∂–µ—Å—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        #expect(summary.count <= 4096, "–î–∞–π–¥–∂–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–±–ª—é–¥–∞—Ç—å –ª–∏–º–∏—Ç Telegram (4096 —Å–∏–º–≤–æ–ª–æ–≤)")

        // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º
        // –î–∞–π–¥–∂–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ–±–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤
        #expect(summary.contains("Swift –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏"), "–î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞")
        #expect(summary.contains("–ö–æ–º–∞–Ω–¥–∞ –ü—Ä–æ–µ–∫—Ç–∞"), "–î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞")

        // 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤)
        // OpenAI –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∏—Ç—å —Å—Å—ã–ª–∫–∏ –≤ markdown —Ñ–æ—Ä–º–∞—Ç–µ
        #expect(summary.contains("https://t.me/swiftdev/100"), "–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
        #expect(summary.contains("https://t.me/swiftdev/101"), "–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")

        // 9. –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Å—ã–ª–æ–∫
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ chatId –Ω–µ –ø–æ–ø–∞–ª –≤ –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç
        #expect(!summary.contains("-1009876543210"), "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å chatId –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –≤ summary")

        print("‚úÖ Generated summary (\(summary.count) chars):")
        print(summary)
        print("\nüìä Token usage –±—É–¥–µ—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω –≤ console (—Å–º. –ª–æ–≥–∏ SummaryGenerator)")
    }
}
